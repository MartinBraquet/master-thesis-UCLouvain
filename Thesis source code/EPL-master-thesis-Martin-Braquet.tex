% EPL master thesis covers template
\documentclass{EPL-master-thesis-covers-EN}

\usepackage{parskip}
\usepackage{siunitx}
\usepackage{float}
\usepackage{textcomp}
\usepackage{amsmath}
\usepackage{multirow}
\usepackage{subcaption}
\usepackage{pgfplots}
\usepackage{mathtools}
\usepackage{booktabs}
\pgfplotsset{compat=1.15}
\usepackage[hidelinks]{hyperref}
\definecolor{lttotitextcolor}{rgb}{0, 0.4, 0.25}
\usepackage{natbib}
\pdfoptionpdfminorversion=7

\graphicspath{{img/}}

\newgeometry{top=3cm,bottom=3cm,left=2cm,right=2cm}

\usepackage[americanresistors, RPvoltages, american voltages]{circuitikz}
\tikzstyle{sensor}=[draw, fill=blue!20, text width=5em, 
    text centered, minimum height=2.5em, rounded corners]
\tikzstyle{sensor2}=[draw, fill=green!20, minimum width=20em, 
    text centered, minimum height=2.5em, rounded corners]
\tikzstyle{sensor3}=[draw, fill=brown!20, text width=5em, 
    text centered, minimum height=2.5em, rounded corners]
\tikzstyle{sensor4}=[draw, fill=orange!20, text width=5em, 
    text centered, minimum height=2.5em, rounded corners]
\tikzstyle{empty_block}=[draw, minimum width=30em, 
    text centered, minimum height=12em, rounded corners]
\tikzstyle{empty_block2}=[draw, minimum width=10em, 
    text centered, minimum height=12em, rounded corners]
\tikzstyle{ann} = [above, text width=5em]
\tikzstyle{afes} = [draw, fill=red!20, text width=5em, 
    text centered, minimum height=2.5em, rounded corners]
\def\edgedist{2.5}

\usetikzlibrary{external}
\tikzexternalize
\tikzsetexternalprefix{tikz_figures/}


\newcommand{\parallelsum}{\mathbin{\!/\mkern-5mu/\!}}
\newcommand{\te}[1]{\textrm{#1}}
\newcommand{\tabitem}{~~\llap{\textbullet}~~}

\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}

\newcommand\nnfootnote[1]{%
  \begin{NoHyper}
  \renewcommand\thefootnote{}\footnote{#1}%
  \addtocounter{footnote}{-1}%
  \end{NoHyper}
}


% Please fill in the following boxes
% Title of the thesis
\title{Design of an ultra-low-power energy-harvesting audio sensor for ecosystem monitoring}

% Subtitle - remove this line if not applicable
%\subtitle{Microphone design for biodiversity inventory in forest}

% Name of the student author(s)
\author{Martin \textsc{Braquet}\!\nnfootnote{\url{martin.braquet@hotmail.com}}}
%\secondauthor{Firstname \textsc{Lastname}}		% remove if not applicable
%\thirdauthor{Firstname \textsc{Lastname}}			% remove if not applicable

% Official title of the master degree (copy/paste from list below)
% Master [120] in Biomedical Engineering
% Master [120] in Chemical and Materials Engineering
% Master [120] in Civil Engineering
% Master [120] in Computer Science
% Master [120] in Computer Science and Engineering
% Master [120] in Cybersecurity
% Master [120] in Data Sciences Engineering
% Master [120] in Data Science: Information technology
% Master [120] in Electrical Engineering
% Master [120] in Electro-mechanical Engineering
% Master [120] in Mathematical Engineering
% Master [120] in Mechanical Engineering
% Master [120] in Physical Engineering
% Master [60] in Computer Science
% Specialised master in nanotechnologies
% Specialised master in nuclear engineering
\degreetitle{Master [120] in Electro-mechanical Engineering}

% Name of the supervisor(s)
\supervisor{David \textsc{Bol}}
\secondsupervisor{Ramin \textsc{Sadre}}		% remove if not applicable
%\thirdsupervisor{Firstname \textsc{Lastname}}		% remove if not applicable

% Name of the reader(s)
\readerone{Rémi \textsc{Dekimpe}}
\readertwo{Denis \textsc{Flandre}}			% remove if not applicable
%\readerthree{Firstname \textsc{Lastname}}			% remove if not applicable
%\readerfour{Firstname \textsc{Lastname}}			% remove if not applicable
%\readerfive{Firstname \textsc{Lastname}}			% remove if not applicable

% Academic year (update if necessary)
\years{2019--2020}


% Document
\begin{document}

% Front cover page
\hypersetup{pageanchor=false}

\maketitle

\begin{abstract}

On one hand, the Internet-of-Things (IoT) is predicted to lead to the deployment of a very large number (possibly trillions) of connected smart sensors for various applications. Such a massive deployment of smart sensors is not environmentally sustainable if the smart sensors are replaced every two years because of the pressure they put on natural resources and the ecotoxicity of the e-waste they generate.

On the other hand, the rising climate change due to ecosystem destruction involves monitoring forests in order to analyze and preserve the ecosystem. Such monitoring is typically achieved manually via a person who samples the data less than once a day, which fails to provide strong results and asks for human presence during data acquisition.

To solve these issues, the focus of this master thesis is on the development of an autonomous and efficient audio smart sensor continuously analyzing the forest ecosystem. To fulfill the energy constraints implied by its total autonomy, this sensor harvests energy from the environment through miniaturized photovoltaic cells sized according to the sun illuminance throughout days and seasons, using an environmentally-friendly and non-toxic supercapacitor as energy storage.
With a 15+ year lifetime, this fully autonomous device operates at an optimized \SI{2.5}{V} supply voltage reaching \SI{22.1}{mW} of average power harvesting/consumption. An electret condenser microphone collects a signal as low as \SI{16}{dB_{SPL}} (compared to a \SI{14.22}{dB_{SPL}} input-referred noise), which is then amplified in the full bird emission frequency range (\SI{20}{Hz} -- \SI{20}{kHz}) by a low-noise and low-power analog front-end. This signal is further processed in an ultra-low-power chip embedding a microcontroller, alternating between run and sleep modes with a $1/3$ duty cycle, and a transceiver optimized for IoT applications with LoRaWAN networks. 

The microcontroller detects sounds when birds are active (typically during the day for more than 12 hours) and ensures the radio-frequency communication at night depending on the supercapacitor voltage that is carefully monitored in real time. It sends the information about the bird species encountered during the day, as well as their apparition frequency. In case of firmware update, this device receives the associated fragments when its energy is sufficient and automatically changes the firmware with energy-optimized software requiring only \SI{10.6}{J} for the whole update.

By computing the weighted average frequency of the received sounds, the smart sensor is able to discriminate between four common birds in Belgium: the pigeon, blackbird, great tit and blue tit. For each species, several songs have been analyzed and used to train a $k$-nearest neighbors (KNN) classifier working in the real-time embedded system. Its precision, defined as the likelihood to find the correct species, reaches 94\% for songs coming from the previously learned database. For newly analyzed sounds, the detection algorithm performs likewise. More complex machine-learning algorithms could finally be further designed to discriminate between more species.
\end{abstract}

\renewcommand{\abstractname}{Acknowledgements}
\begin{abstract}
This thesis has been written throughout my last year at UCLouvain. It gave me the opportunity to have a first glimpse into an important work required for the procurement of a master's degree in engineering.  During this substantial work, I would like to thank the following people, starting with the most meaningful ones, for their important hints and source of motivation.

First of all, I would like to thank my main supervisor, Prof. D. Bol, for his precious information. In his works, I really appreciated his way to approach a problem, starting with a technological/ecological/social need and then solving it by considering all the factors in the process (systemic approach). His maturity, sensibility and motivation to handle such problems made one of the most important marks on me throughout my studies at UCLouvain. 

Second, I would like to thank Tim Hess who wrote his thesis on a same topic but more focused on the wireless communication. We have had great collaborations to produce the final model for this work. He gave me important advice for the overall design and soldering of the PCB, more specifically on the handling of KiCad (a PCB design tool).

Third, I would like to thank the members of the ECS group\footnote{Electrical Circuits and Systems group led by Professors D. Bol and D. Flandre at UCLouvain.} and more specifically Rémi Dekimpe for his constant supervision through the year. He proved his availability at any time and had precious hints.

I would also like to thank my second supervisor, Prof. R. Sadre, for his availability. I want to thank Prof. D. Flandre in advance for the reading of this thesis, as well as for his interesting courses given during my curriculum. More generally, I need to thank all the people who contributed to this work, e.g. for accessing the electronics lab and the ordering of the required materials.
\end{abstract}

\tableofcontents

\listoffigures

\listoftables

\newpage

\hypersetup{pageanchor=true}


\chapter{Introduction}

This thesis is dedicated to people interested in audio monitoring and its subsequent recent rise, as well as the technical details/constraints related to the design of such sensors. It is accessible for people from diverse domains, but a background in engineering is nonetheless advised.

\section*{Context}

The Internet-of-Things (IoT) is a system of interrelated computing devices that are provided with unique identifiers and the ability to transfer data over a network without requiring human-to-human or human-to-computer interaction. It is predicted to lead to the deployment of a very large number (possibly trillions) of connected smart sensors for various applications. However, such a massive deployment of smart sensors is not environmentally sustainable if the smart sensors are replaced every two years because of the pressure they put on natural resources and the ecotoxicity of the e-waste they generate. Therefore, it is needed to fight obsolescence in the IoT domain by enabling a 10+ year lifetime for the smart sensors. 

\paragraph{Audio monitoring}

Forests are important sources for biodiversity and ecological balance. They provide many benefits and it is the main functions for water and soil conservation, genetic resources for plant and animal, and also a source of wood supply and other forest goods. They also have important benefits on human physical and mental health~\cite{Meyer-Schulz}. However, recently the green forest environment has been interrupted by unethical activities such as development activities that decrease the benefits of the forest contribution.
Thus, in order to ensure long-term forest autonomy, it is important to implement a monitoring system that is responsible for providing effective monitoring for forest environment. Forest monitoring is not limited to environmental issues only, but it also includes fire monitoring and detection in forests~\cite{OTHMAN20121204}. To set the problems, a policy-relevant infrastructure for monitoring of forest ecosystems has been recently proposed in the European Union~\cite{ICP_Forests}.

Nowadays, some key variables, such as tree health and biodiversity, are only collected once a year because they must be assessed by a well-trained human operator. This low observation frequency considerably limits the possibility of characterizing evolution trends relating them with explanatory causes. 

To achieve this goal of an autonomous long-lasting sensor, energy needs to be harvested from the environment through miniaturized photovoltaic cells, using batteries whose chemistry does not wear out and having reconfiguration capabilities to keep up with application, security and communication protocol updates.

\section*{Contributions}

In this master thesis, a operational device was built to monitor bird songs in forest. It will be attached to a tree, will record the sounds, analyze and send them over-the-air. Thanks to a supercapacitor and solar cells, it is fully autonomous, efficient and connected to the cloud. It is in operation for more than 15 years without any human assistance and can discriminate between bird songs which are rather distinct (based on their frequency spectrum).

The objectives of this thesis are multiple. It first aims at improving the audio monitoring quality in forest while reducing human interactions, especially in areas with difficult access. Via this text, it also includes providing useful information for diverse people interested in the domain, such as companies willing to improve ecosystem monitoring or students facing a related problem.

For this purpose, all the files used for the simulations as well as the LaTeX source code of this thesis are fully open-source under the \textit{MIT} license\footnote{Provided that the reader gives appropriate credit, he is free to copy and redistribute the material in any medium or format under the same license as the original. He has permission to remix, transform, and build upon the material for any purpose, even commercially.} at \url{https://github.com/MartinBraquet/master-thesis-UCLouvain}.

\section*{Structure}

The structure of this thesis has been carefully built to replicate the design process of this sensor. Indeed, the chapters totally mimic the real chronology throughout the year, in such a way that each chapter is only based on the design choices of the previous chapters. 

Chapter 2 describes the use case, by detailing the state-of-the-art of audio monitoring, the requirements for the system and its general architecture.

Chapter 3 details the different types of energy storage, from the primary battery to the supercapacitor and the new developments. They are then compared and the most suited for this application is selected.  

Chapter 4 is dedicated to the power management. The selection of the supply voltage as well as the operation of the power management unit are explained.

Chapter 5 analyzes the sensing subsystem. After a brief review of the principles of wave propagation, different kinds of microphones are detailed and compared, leading to the selection of the most meaningful. Then, the analog front-end is detailed, associated with the design of each component. The best microphone is then chosen such that it optimizes the noise / power consumption specifications.

Chapter 6 gives a description of the data processing and transmission, with an emphasis on the microcontroller behavior.

Chapter 7 describes the power supply by first summarizing the whole power consumption. The best solar cells are then selected in accordance with the expected sun illuminance. The supercapacitor is characterized and its capacitance is designed according to the power management unit specifications.

Chapter 8 details the final model, with its design and prototyping, and ends with a complete validation of the system.

Chapter 9 provides different inference algorithms used to process, inside the microcontroller, the received data from the microphone. Experimental results are provided and reviewed.

Chapter 10 gives some perspectives of improvement for an application which is still new with great perspectives.

Chapter 11 ends this work with a conclusion. The appendices give additional details on the transimpedance amplifier, the noise gain of the microphone amplifier and the PCB layout/schematic of the final model.


\chapter{Use case}

This chapter describes the state-of-the-art IoT smart sensors for forest monitoring and the process/systems required to accomplish the aforementioned goals.

\section{State-of-the-art of IoT sensors for forest monitoring}

Since 2000, \textit{wireless sensor networks} (WSNs) have received increasing attention in research on automatic natural environments~\cite{Akyildiz}. 

For forest monitoring, research has already been achieved as attested by the following state-of-the-art. First, in \cite{Granados}, they worked on autonomous recording units which have been widely used in a large number of bird studies in recent years, but challenges remain in estimating abundance based on acoustic monitoring. They tested whether vocal activity rate index (VAR; the number of songs per unit time for a species), recorded using autonomous recording units, was related to population abundance in two terrestrial bird species. Second, in \cite{Huanqi}, they illustrate a forest monitoring system solution of wireless sensor networks based on ZigBee by using sensor nodes and coordinator nodes. Third, in \cite{Jiang}, a 20-day wireless sensor network of 18 nodes has been deployed in a mountain area. It has a good fidelity since they received 87\% of sent sample data. Their primary concern remains to enlarge the network scale and prolong the network lifetime.

However, these previous works show that the use of WSNs has been limited to simple tasks due to key technological issues. First, the high power consumption of the sensor nodes in operation leads to a trade-off between the density of the sensor deployment (limited by the frequency of battery replacement by an operator) and the complexity of the ecosystem parameters to monitor. Second, the limited range of low-power wireless communication prevented large-scale deployment. Third, the monitoring of complex, non-directly observable parameters (e.g. bird population, tree health) is impeded by the lack of low-power algorithms (typically machine learning) that would process on-chip data. However, today, technological advances in ultra-low-power processors~\cite{8662293}, IoT communications and artificial intelligence open new possibilities. A brief insight of them will be described in this work.

\paragraph{Communication}

In regard to these topics, low power communication protocols also appeared. There is a trade-off between energy and range that such devices can sustain. The data rate, i.e. the amount of data transmitted per unit of time, can be tuned as a degree of freedom to adjust this trade-off. It is thus desirable to produce reconfigurable solutions.

For long-range communications, a low-power wide-area network (LPWAN) such as LoRa is used. LoRa is a spread spectrum modulation technique derived from chirp spread spectrum (CSS) technology and is the first low-cost implementation of chirp spread spectrum for commercial usage. LoRa also has a lot of applications in urban areas, such as waste management in smart cities~\cite{Cerchecci}.

For short-range communications, a wireless personal area network (WPAN) such as Bluetooth low energy (BLE) is used since they consume less energy per bit sent (\SI{30}{nJ/bit} compared to \SI{1}{\micro J/bit} for LoRa~\cite{Local_Sensor_Data_Processing}). For this, multiple challenges exist such as spectrum congestion (due to the limited data rate), data deluge, security flaws, natural resources, ecotoxicity, battery charging/replacement. Multi-hop transfer describes communications between several sensors, they can help solve some of these issues by increasing the range but with a costly synchronization~\cite{bol2018}.

\paragraph{Data processing}

With the limited data rate of low-power communication protocols, local data storage and processing are required to extract and store meaningful information.

In addition to on-chip data processing, edge computing has been proposed to further reduce the data flow and hence the power consumption, it refers to the enabling technologies allowing computation to be performed at the edge of the network, on downstream data on behalf of cloud services and upstream data on behalf of IoT services~\cite{Shi2016}. Here, edges are any computing and network resources along the path between data sources and cloud data center (e.g. for forest monitoring, a gateway between smart sensors and cloud data centers). 

For sound analysis, some algorithms such as Blind Audio Source Separation (BASS) have been developed to discriminate the sound from several sources (e.g. birds) with the help of several sensors (that is, microphones). Methods exist to rank existing BASS algorithms according to their performance on the same test data~\cite{Vincent2006}.

\section{General architecture}

The general architecture of this type of sensor node is given in Figure~\ref{fig:general_architecture}. A sensor is a device which probes, processes and sends diverse physical subjects in an environment. For this work, the physical subject is the sound pressure.

\begin{figure}[H]
\centering
\scalebox{0.9}{
\begin{tikzpicture}
    \node (afe) [afes] {Sensor};
    \path (afe.0)+(-6,0) node (mic) [sensor4] {Sound,\dots};
    \path (afe.0)+(3,0) node (proc) [sensor] {Controller};
    \path (afe.0)+(6.5,0) node (tx) [sensor3] {Transceiver};
    \path (afe.0)+(3,2) node (pw) [sensor2] {Power management};
    \path (afe.0)+(2.7,1) node (mysensor) [empty_block] {};
    \path (afe.0)+(-6,1) node (envi) [empty_block2] {};
    \node[anchor=north west,inner sep=10pt] at (mysensor.north west)
    {\textbf{Sensor node}};
    \draw (afe.0)+(-6,0.5) circle (50pt);
    \node[anchor=north west,inner sep=10pt] at (envi.north west)
    {\textbf{Environment}};
    \path [draw, ->] (mic) -- node [above] {} (afe.west |- mic) ;
    \path [draw, ->] (afe.east) -- node [above] {} (proc.west |- afe) ;
    \path [draw, <->] (proc.east) -- node [above] {} (tx.west |- proc) ;
    \draw (tx.0) -- (11,0) -- (11,1) ;
    \node[] at (-4.8,1) {Physical subject};
    \foreach \r in {.1,.2,.3}
      \draw (11.1,1) ++ (60:\r) arc (60:-60:\r);
\end{tikzpicture}}
\caption{Block diagram of a general IoT sensor node}
\label{fig:general_architecture}
\end{figure}

Inside the sensor node, there are typically four submodules:
\begin{itemize}
 \item \textit{Sensor}: The sensor captures data from its environment by producing a measurable response to a change in a physical condition like temperature or pressure. It has specific characteristics such as accuracy, sensitivity\dots The physical signal is typically filtered and amplified in an analog front-end (AFE). The continual analog signal is then sent to a controller for further processing, either in continuous form or in digital form via an analog-to-digital converter (ADC).
 \item \textit{Controller}: The data are processed in a controller, which is most often a microcontroller for its low cost, flexibility to connect to other devices, ease of programming, and low power consumption. The microcontroller performs tasks, processes data and controls the functionality of other components in the sensor node.
 \item \textit{Transceiver}: The transmission (TX) and reception (RX) are combined in a transceiver which allows exchanging data, mostly wirelessly through radio frequency (RF) with an antenna. WSNs tend to use license-free communication frequencies\footnote{The ISM radio bands are portions of the radio spectrum reserved internationally for industrial, scientific and medical (ISM) purposes other than telecommunications.}, LoRa uses for example license-free sub-gigahertz radio frequency bands (like 433 MHz, 868 MHz (Europe)) enabling long-range transmissions with low power consumption.
 \item \textit{Power management}: Since the wireless sensor node is often placed in a hard-to-reach location, changing the battery regularly can be costly and inconvenient. Hence, an important aspect in the development of a wireless sensor node is ensuring that there is always adequate energy available to power the system. The sensor node consumes power for sensing, data processing and communicating. Power is stored either in batteries or capacitors. They renew their energy from solar sources, radio frequency, temperature differences, or vibration.
\end{itemize}

Because energy is the most important scarcity in such sensors (defining its lifetime), one has to keep in mind the power consumption of each block throughout the design. It is expected that the parts with the most power consumption are the microcontroller, the transceiver and the microphone. The other parts will be designed to be negligible compared to the formers.

\section{Requirements analysis}
\label{section:requirements}

The sensor that will be produced needs to fit the following requirements:

\begin{itemize}
 \item The microphone detects sounds up to \SI{50}{m} in order to produce a reasonable inventory of bird population. 
 \item Based on the continuously received sound, the sensor has to discriminate the bird species among a small group of selected birds.
 \item The lifetime is one of the most important demands for this application, the sensor has to work fully autonomously (days and night) for at least 15 years.
 \item The materials used for the design, particularly the energy storage element, must have low toxicity.
 \item The total volume must not exceed \SI{20 x 20 x 5}{cm} to respect the forest ecosystem and be easily placed on a tree. The main part of the volume will be due to the storage element and the solar cells.
 \item For a massive deployment, the cost cannot exceed 80 euros.
\end{itemize}

%\textcolor{green}{Schema de flow (déroulement du mémoire)}


\chapter{Energy storage}

Energy storage has an important role in sensor applications. First, this role can be identified as either a unique power for the application, or as a temporary storage of energy provided by the energy harvester. In the framework of this thesis, the latter is considered since solar cells (energy harvester) will bring energy to the system, which is stored in an energy storage element.

Then, one has to characterize the main figures of merits such as the energy density, the maximum self-discharge and application conditions, as well as financial and environmental considerations.

A Ragone plot is typically used for comparing the energy density of various energy-storing devices. On such a chart, the values of specific energy density (in \si{Wh/kg}) are plotted versus specific power density (in \si{W/kg}). In Figure~\ref{fig:ragone_plot}, one can see the trade-off between energy density and power density. From fuel cells to supercapacitors by way of Li-ion batteries, energy density is decreasing in aid of power density.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{service2006.pdf}
    \caption[Ragone plot showing specific energy versus specific power for various energy-storing devices]{Ragone plot showing specific energy versus specific power for various energy-storing devices~\cite{Service902}}
    \label{fig:ragone_plot}
\end{figure}

In order to answer the previous requirements, common energy storage types are analyzed and the most suited type for this work is detailed.


\section{Primary batteries}

Primary batteries are non-rechargeable, they thus have only one life cycle. However, they can sometimes still have their place in IoT applications when the power consumption and the sensor lifetime are particularly reduced. Primary batteries are mainly based on three technologies.

\subsection*{Zn-MnO${}_{\textbf{2}}$ batteries}

Zn-MnO${}_2$ batteries are composed of a combination of metallic zinc (oxidation) and a manganese dioxide electrode (reduction). They exist under the form of zinc-carbon cells and alkaline batteries and differ according to the electrolyte inside.

The voltage window is between \SI{0.9}{V} and \SI{1.5}{V}. The energy density of a typical AA (approximately \SI{8}{cm^3}) zinc-carbon cell is \SI{100}{mWh/cm^3}, whereas a commercial alkaline cell reaches at present up to \SI{400}{mWh/cm^3}~\cite{doi:10.1002/er.2949}.

These batteries are very well known and low cost, but present a high self-discharge rate.

\subsection*{Lithium primary batteries}

Lithium primary batteries have an anode made of metallic lithium and a cathode made of several materials such as MnO${}_2$ or FeS${}_2$.

Batteries integrating MnO${}_2$ commonly deliver a total cell voltage of around \SI{3}{V}. These batteries work with the oxidation of lithium and reduction of manganese, with a typical energy density of \SI{650}{mWh/cm^3}.

The second type of lithium battery is based on FeS${}_2$. It has a practical voltage of \SI{1.5}{V} and is therefore compatible with alkaline and zinc-carbon cells. It has an energy density of approximately \SI{550}{mWh/cm^3}.

Overall, it is able of delivering high currents and has a quite flat voltage profile upon discharging. Moreover, it performs well at low temperatures and has a significantly lighter weight than alkaline cells.

\subsection*{Zn-air batteries}

Zn-air batteries are a class of batteries that employ metallic zinc particles as its anode and an aqueous liquid electrolyte. With a voltage of \SI{1.4}{V}, this
battery is commercially available as button cells with an energy density of around \SI{1500}{mWh/cm^3}.

Other disadvantages of this type of battery are that the catalyst that is required for the reduction of oxygen usually consists of expensive noble metals and that the battery is unable to deliver high peak currents. This type of battery is therefore commonly used in applications where only low
currents are required from a battery with a small volume~\cite{doi:10.1002/er.2949}.

\section{Secondary batteries}

Secondary batteries are rechargeable, they thus have a certain number of life cycles (usually more than 500). Only battery types that are suitable for the IoT domain are presented in this thesis.

\subsection*{Batteries with liquid or polymer gel electrolytes}


\subsubsection*{Nickel metal hydride batteries}

Nickel metal hydride batteries (NiMH) combine nickel at the positive electrode and hydrogen (metal hydride) at the negative electrode.  During discharge, a proton, obtained from the electrolyte, occurs in reduction of nickel oxyhydroxide. The loss of protons in the electrolyte produces hydroxide anions which will recombine with a proton from the metal hydride.

The cells typically work at around \SI{1.2}{V}, allowing interchangeability with alkaline batteries. However, they have a higher self-discharge rate and a narrow temperature window (0 to \SI{45}{\degree C}). The energy density is around 250 and \SI{380}{mWh/cm^3}.

\subsubsection*{Li-ion batteries}

Lithium-ion batteries are composed of lithium metal oxide at the positive electrode (LiCoO${}_2$) and a material storing lithium in a neutral form such as graphite at the negative electrode. The charge process is based on the motion of lithium ions from the metal oxide to the electrolyte, where they are stored in graphite.

Compared to NiMH batteries, they have higher energy density (between 300 and \SI{500}{mWh/cm^3}), lower self-discharge rate and larger temperature window (-20 to \SI{60}{\degree C}). They are however easily damaged in case of overdischarging or overcharging, thus requiring a special protective electric circuit for the power management.

However, liquid electrolytes have high volatility and have been the source of explosions in lithium batteries. Research thus has been done on the design of solid electrolytes.

\subsection*{Solid-state batteries}

Solid-state batteries use solid electrodes and a solid electrolyte, such as ceramics (e.g. oxides, sulfides, phosphates) or a solid polymer. They are potentially safer than batteries with liquid electrolytes, with higher energy density, but at a much higher cost.
However, these efforts have faced a number of issues.

One of the biggest problems is that when the battery is charged up, atoms accumulate inside the lithium metal, causing it to expand. These repeated changes in the metal’s dimensions make it difficult for the solids to maintain constant contact, and tend to cause the solid electrolyte to fracture or detach.

Another problem is that none of the proposed solid electrolytes are truly chemically stable while in contact with the highly reactive lithium metal, and they tend to degrade over time.

\section{Supercapacitors}

Supercapacitors are high-capacity capacitors storing energy in an electric field, rather than in a chemical reaction, like batteries. This allows high power density for short-term energy storage\footnote{They can provide very high currents during a short time.}, almost instant recharging and very long lifetimes. Made of porous carbon (electrodes) and liquid salts (electrolyte)~\cite{BAPTISTA20191153}, they are not composed of harmful\footnote{Failing in a nice way, they will never overrun or start a fire.} chemicals or toxic metals.
Since the supercapacitor is non-chemical, the voltage is free to rise until the dielectric fails (often in the form of a short circuit). It is thus needed to avoid going higher than the specified voltage, which is characterized by a lower voltage limit than batteries.

Due to their behavior in between electrolytic capacitors and batteries, they are particularly well suited for IoT applications. Indeed, they typically store 10 to 100 times more energy per unit volume or mass than electrolytic capacitors. They can also accept and deliver charge much faster than batteries, and tolerate many more charge and discharge cycles than rechargeable batteries. Nevertheless, care needs to be paid to their significant leakage current which is proportional to the value of the supercap.

Instead of using a conventional solid dielectric, supercapacitors use electrostatic double-layer capacitance and electrochemical pseudocapacitance~\cite{2019JPS...414..420B}.

\subsection*{Electrostatic double-layer capacitors}

Electrostatic double-layer capacitors (EDLCs) are the most common type of supercapacitors. They use carbon electrodes or derivatives with much higher electrostatic double-layer capacitance than electrochemical pseudocapacitance, achieving separation of charge in a Helmholtz double layer at the interface between the surface of a conductive electrode and an electrolyte.

\subsection*{Electrochemical pseudocapacitors}

Electrochemical pseudocapacitors use metal oxide or conducting polymer electrodes with a high amount of electrochemical pseudocapacitance additional to the double-layer capacitance. They store charge chemically through redox reactions where one species transfers electrons to another, similar to a battery. While pseudocapacitors store more energy, their widespread use has been hampered by their narrow electrochemical voltage window, which is the voltage range where the electrode materials are stable.

Additionally, there exist hybrid capacitors, such as the lithium-ion capacitors, using electrodes with different characteristics: one exhibiting mostly electrostatic capacitance and the other mostly electrochemical capacitance.

\section{New developments}

Promising new methods are also developed in research laboratories, some of them are detailed hereafter.

\subsection*{3D electrodes for electrochemical energy storage}

Superior energy or power density for batteries is typically achieved only in ultra-thin electrodes with low mass loadings. To realize the full potential of these electrode materials, new electrode architectures allow more efficient charge transport beyond the limits of traditional electrodes. Working on the design and synthesis of 3D electrodes is promising to address charge transport limitations in thick electrodes. Such 3D porous architectures could enable composite electrodes with an unprecedented combination of energy and power densities~\cite{Sun2019}.

In addition to the recent development of Li-Ion batteries with  flexible, bendable, or foldable characteristics, some researches have been focused on batteries with advanced features of stretchability in which the systems are able to accommodate large mechanical strain and still maintain their functions. Such sponge-inspired electrodes for stretchable Li-Ion Batteries show no specific capacity reduction when bent, unlike the cells using conventional electrodes~\cite{doi:10.1002/adma.201505299}.

\subsection*{Lithium metal anode}

Recent research has been achieved on lithium metal anodes that could improve the longevity and energy density of future batteries~\cite{10.1038/s41586-020-1972-y}.

Most attempts to overcome the problems of solid-state batteries have focused on designing solid electrolyte materials that are absolutely stable against lithium metal, which turns out to be difficult.  Instead, the researchers adopted an unusual design that utilizes two additional classes of solids, “mixed ionic-electronic conductors” (MIEC) and “electron and Li-ion insulators” (ELI), which are absolutely chemically stable in contact with lithium metal. 

They developed a three-dimensional nanoarchitecture in the form of a honeycomb-like array of hexagonal MIEC tubes, partially infused with the solid lithium metal to form one electrode of the battery, but with extra space left inside each tube. When the lithium expands in the charging process, it flows into the empty space in the interior of the tubes, moving like a liquid even though it retains its solid crystalline structure. This flow, entirely confined inside the honeycomb structure, relieves the pressure from the expansion caused by charging, but without changing the electrode’s outer dimensions or the boundary between the electrode and electrolyte. The other material, the ELI, serves as a crucial mechanical binder between the MIEC walls and the solid electrolyte layer.

\section{Shape}

In addition to the electrical and thermal characteristics, the form of the storage element is particularly important for IoT devices where the full sensor size is often limited. The main trade-off thus appears between the charge capacity and the size of the energy storage element.

The main shapes of micro-batteries are button cells, pouch cells and thin film batteries.

\section{Comparison}

Table~\ref{tab:comparison_energy_storage} presents the main figures of merit for the previously described types of energy storage.

\begin{table}[H]
\centering
\scalebox{0.655}{
\begin{tabular}{l|ccc|ccc}
\toprule
                          & \multicolumn{3}{c|}{Capacitors} & \multicolumn{3}{c}{Batteries} \\ \midrule
                          & Ceramic & Electrolytic & Supercap & Non-rechargeable & \multicolumn{2}{c}{Rechargeable} \\
                          &  &  & EDLC & Alkaline & NiMH & Lithium ion \\ \midrule
 Power density [W/g]      &  & > 100 & 2 -- 10 &  & 2.5 -- 10 & 1 -- 3  \\
 Energy density [mWh/g]   & 0.1~\cite{DEKIMPE20198} & 0.01 -- 0.3  & 5 &  & 60 -- 120  & 120 -- 240 \\
 Self-discharge rate [per month]     & 100\% & \SI{100}{h} & 50\% & < 0.3\% & 0.08 – 2.9\% & 5\% \\
 Leakage current          & 1 -- 100 \si{nA/\micro F}  &  & 2 -- 5 \si{fA/\micro F}~\cite{DMF3Z5R5H474M3DTA0}~\cite{Vishay} &  &  & 5 \si{\micro A}~\cite{DEKIMPE20198} \\
 Service life [years]     & 25~\cite{DEKIMPE20198} & 15 & 10 -- 15 & 5 -- 10 &  & 5 --10 \\
 Life cycles              & unlimited~\cite{DEKIMPE20198} & unlimited & \SI{1000000}{} & 1 & 180 -- 2000 & 500 \\
 Degradation              & negligible &  & -80\% in 10 years &    &  & -50\% in 500 cycles     \\
 Charge time              &    &  & 1 -- \SI{10}{s} &    &  & 10 -- \SI{60}{min}     \\
 Cell voltage [V]             &    & 4 -- 630 & 2.3 -- 2.75 & 1.5   & 1.2 & 3.6     \\
 Charge T° [\si{\degree C}] &  & -40 -- 70 & -40 -- 65 & & & 0 -- 45 \\
 Discharge T° [\si{\degree C}             &  & -40 -- 70 & -40 -- 65 & & & -20 -- 60 \\
 Discharge efficiency     &   & 99\% & 95\% &    & 66\% -- 92\% & 90\%     \\
 Toxicity                 &    &  & low &    &  & middle \\ \bottomrule
\end{tabular}
}
\caption{Comparison of various types of energy storage}
\label{tab:comparison_energy_storage}
\end{table}

In this table, the life cycle is the number of complete charge/discharge cycles that the battery is able to support before its capacity falls under 80\% of its original capacity.
Although the deployment of such sensors would imply the fabrication of several thousands of energy storage elements, the impact of the toxicity is small for such projects lasting more than 20 years without replacement. The degradation corresponds to the decrease of its maximum energy storage throughout its life.

The overall efficiency is computed as
\[
 \eta = \frac{E_\te{O}}{E_\te{I}}
\]
where $E_\te{O}$ is the energy delivered during the whole life of the energy storage element, and $E_\te{I}$ is the total energy fed to the energy storage, composed of both the fabrication energy and the recharge energy. It is difficult to compute this efficiency due to the lack of information about the fabrication energy (typically not given by manufacturers). However, Li-ion batteries (\SI{50.17}{kWh/kg} for electric vehicles~\cite{manufacturing_lithium}) require more manufacturing energy than supercapacitors.


\subsection*{Criticality}

To assess the criticality of energy storage elements, one needs to consider the environmental and societal impacts combined with their scarcity. The scarcity of an element is assessed by the variation of its availability on Earth between from a few decades ago to nowadays (not to be confused with rare-earth elements which are not critical). They include components overused for electronic devices such as copper, gold, silver, lithium and cobalt.

For Lithium-ion and NiMH batteries, the following compounds are used:
\begin{itemize}
 \item Positive electrode: metal oxide compounds such as lithium extracted from brine or rock, nickel, cobalt, hydrogen-absorbing alloy (nickel alloys with many metals: V, Ti, Zr, Ni, Cr, Co, Al and Fe)
 \item Negative electrode: graphite (carbon-based)
 \item Electrolyte
\end{itemize}

One can thus see that many polluting compounds appear in the positive electrode.

For EDLCs, the following compounds are used:

\begin{itemize}
 \item Electrodes: porous carbon (activated carbon, carbon nanotubes and carbon aerogels) built from graphite \cite{Hastak}
 \item Electrolyte: liquid salts (water with ions)
 \item Polymeric membrane forming a microporous layer as separator
\end{itemize}

Supercapacitors are thus mainly built from carbon, one of the most abundant elements on Earth. They are thus far less toxic and resource intensive than metal-based batteries.

    
\section{Selection}

Building upon these results, a supercapacitor is chosen because of its high lifetime, low toxicity and reasonable energy density. As detailed in the Ragone plot (Figure~\ref{fig:ragone_plot}), this energy storage element can deliver high currents but stores less energy per volume. Its substantial leakage current is also needed to be further taken care of. The sizing of this supercapacitor will be achieved in Chapter~\ref{supercap_sizing} when the whole power consumption is fully determined. 

%Approx energy available based on normal volume of supercap -> guideline through the design -> compared with this value and check that small parts draw less than 1 percent of this energy.

\chapter{Power management}

The purpose of power management is to harvest energy from solar cells, store it in a supercapacitor, and deliver it to the circuit through a stable voltage supply. In this section, the best supply voltage is determined and the power management unit is explained.

\section{Operating voltage design}
\label{section:operating_voltage}

First, the supply voltage is used to power the sensing subsystem and the MCU/transceiver chip. For practical and energy efficiency reasons, the same supply voltage is selected for the whole system.

Since the microcontroller uses an LDO to regulate its internal voltage, the current consumption is independent from the supply voltage. In order to minimize the power consumption, one thus needs to use the lowest supply voltage. However, using a low supply voltage decreases the AFE amplification gain and therefore the precision (i.e. the signal-to-noise ratio) on the microphone signal that will be read at the input of the MCU. Indeed, while the noise at the sensing output is roughly independent from the amplification gain of the sensing subsystem (see the proof in Section~\ref{section:AFE}), the signal power is reduced with the gain. Hence, this trade-off leads to the selection of a \SI{2.5}{V} supply voltage which lies in the \SI{2.2}{V} -- \SI{3.6}{V} range of the CMWX1ZZABZ chip.

%the resolution of an $N$-bit ADC is given by $V_\te{DD}/2^N$ where $V_\te{DD}$ is the supply voltage.


\section{Power management unit}
\label{section:PMU}

A power management unit (PMU) is an integrated energy management circuit that extracts DC power from solar cells to simultaneously store energy in a rechargeable element and supply the system with independent regulated voltages. An AEM10941 chip from e-peas is selected because of its ultra-low power consumption and the close relations between the university and the company (see Figure~\ref{fig:AEM10941}).

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{AEM10941.pdf}
    \caption[AEM10941 simplified schematic view]{AEM10941 simplified schematic view~\cite{AEM10941}}
    \label{fig:AEM10941}
\end{figure}

Its characteristics are given in Table~\ref{tab:AEM10941}, by only considering the high voltage regulator. The very low quiescent current is nearly independent from the supercapacitor voltage.

\begin{table}[H]
\centering
\scalebox{1}{
\begin{tabular}{lc}
\toprule
 Max input current                       & \SI{110}{mA}               \\
 Max input voltage                       & \SI{5}{V}                  \\
 Output voltage                          & \SI{1.8}{V} -- \SI{4.1}{V} \\
 Max output current                      & \SI{80}{mA}                \\
 Max supercap charge                     & \SI{4.5}{V}                \\ 
 Min drop-out supercap -- output voltage & \SI{0.3}{V}                \\ 
 Quiescent current                       & \SI{0.6}{\micro A}         \\ \bottomrule
\end{tabular}
}
\caption{Characteristics of the AEM10941 PMU}
\label{tab:AEM10941}
\end{table}


\subsection*{Storage element and LDO configuration}

Configuration pins determine various operating modes by setting predefined conditions for the energy storage element (overcharge or overdischarge voltages) and by selecting the voltage of the high-voltage supply and the low-voltage supply.
The low-voltage supply is not used and the high-voltage supply is set to \SI{2.5}{V}. These characteristics correspond to a preset state in the chip, which helps reduce internal losses by not using additional resistors to select a custom configuration. The three configuration pins CFG[2], CFG[1] and CFG[0] are thus set to 0, 1 and 1, corresponding to the charge of a dual-cell supercapacitor charged in the range \SI{2.8}{V} -- \SI{4.5}{V} in order to power the low-voltage and high-voltage supplies at \SI{1.8}{V} and \SI{2.5}{V}, respectively.

Additionally, three status pins allow monitoring the PMU, whose one informs about supercapacitor overdischarge. For a first prototype, connecting this pin to a LED can be useful to deduce the supercapacitor state, but there are not used in the final model to further reduce power consumption (which is non-negligible for typical LEDs, around \SI{1}{mA}).

\subsection*{Maximum power point tracking}

The efficiency of power transfer from the solar cell depends on both the amount of sunlight falling on the solar cells and the electrical characteristics of the load. As the amount of sunlight varies, the load characteristic that produces the highest power transfer efficiency changes, so that the efficiency of the system is optimized when the load characteristic changes to keep the power transfer at highest efficiency. 
Maximum power point tracking (MPPT) is thus used by the PMU by means of a boost converter regulating its input voltage so that the electrical current that enters the boost converter yields the best power transfer from the harvester under any ambient conditions (see Section~\ref{section:solar_cells} for more details about the intrinsic principle of solar cells).

This PMU uses the open-circuit voltage algorithm, the simplest MPPT control method. It consists to set the voltage at a constant ratio of the open-circuit voltage $V_\te{OC}$. By temporarily disconnecting the source from the PMU, the MPPT module maintains knowledge of $V_\te{OC}$. It then sets the MPPT voltage at $V_\te{MPPT}$ depending on $V_\te{OC}$ and the ratio (70\%, 75\%, 85\% or 90\%) selected in hardware via two headers connected to the configuration pins. A typical MPPT ratio leading to the maximum power is 76\%~\cite{10.1109/ICSTE.2010.5608868}, but it will be refined experimentally in the validation section. Still, the main disadvantage of this method is that there is momentary power loss due to the disconnection of the load from the solar cells for the sampling of its open-circuit voltage.


\subsection*{Boost conversion efficiency}

The energy converted from the solar cells to the supercapacitor (called boost voltage) is not fully converted due to the internal boost converter efficiency. As depicted in Figure~\ref{fig:boost_efficiency} for a typical harvested current of \SI{10}{mA}, the efficiency is maximum when the input voltage $V_\te{SRC}$ is \SI{0.4}{V} below the output voltage $V_\te{BOOST}$ (see Table~\ref{tab:max_eff_PMU}).

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{boost_efficiency.pdf}
    \caption{Boost conversion efficiency (solar cells -- supercap) of the AEM10941}
    \label{fig:boost_efficiency}
\end{figure}

\begin{table}[H]
\centering
\begin{tabular}{ccc}
\toprule
 $V_\te{SRC}$ & $V_\te{BOOST}$ & Efficiency \\ \midrule
 \SI{2.2}{V}  & \SI{2.6}{V}    & 92\%      \\
 \SI{3.2}{V}  & \SI{3.6}{V}    & 95\%      \\
 \SI{3.7}{V}  & \SI{4.1}{V}    & 96\%      \\ \bottomrule
\end{tabular}
\caption{Values of maximum efficiency for the src -- boost conversion with a \SI{10}{mA} input current}
\label{tab:max_eff_PMU}
\end{table}

Since the source voltage impacts both the boost conversion efficiency and the harvested power (see previous paragraph), the optimal source voltage needs to be determined. Based on Figure~\ref{fig:boost_efficiency}, the efficiency significantly falls when the source voltage exceeds its optimal voltage. The source voltage thus needs to stay below $V_\te{BOOST} - \SI{0.4}{V}$ at all times, corresponding to \SI{2.4}{V} for this work (supply voltage of \SI{2.5}{V} implying a supercap voltage of at least \SI{2.8}{V}). In this case, it is thus expected to reach a boost efficiency of 92\% whatever the supercap voltage. Finally, the maximum source voltage set to \SI{2.4}{V} might be slightly relaxed if the IV curve of the solar cells provide a significant power increase at a higher source voltage (see Section~\ref{section:solar_cells}).


\subsection*{High-voltage LDO regulation}

As shown in Figure~\ref{fig:LDO_voltage}, the PMU supply voltage does depend on the load current drawn by the sensing and MCU/TX subsystems. It decreases from \SI{2.5}{V} without load to \SI{2.43}{V} at the maximum load (that is, \SI{80}{mA}). Although this voltage variation might impinge upon the signal reading at the ADC input of the microcontroller, no voltage regulation needs to be taken into account inside the MCU code. Indeed, both the signal voltage $V_\te{in,ADC}$ from the microphone and the ADC supply voltage $V_\te{DD}$ vary likewise, this leads to the same digitized number $\floor{V_\te{in,ADC}/V_\te{DD}}$.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{LDO_voltage.pdf}
    \caption{High-voltage LDO regulation at \SI{2.5}{V} in function of the load current}
    \label{fig:LDO_voltage}
\end{figure}

Finally, the LDO efficiency can be simply calculated as $V_\te{out}/V_\te{in}$ (same input -- output current) if the quiescent current (\SI{0.6}{\micro A}) can be neglected with regards to the output current, which is confirmed by the hyperbolic curve in Figure~\ref{fig:LDO_efficiency}. It is thus advised to work at the lowest supercap voltage (i.e. \SI{2.8}{V}) by selecting a supercapacitor with a similar operation voltage range.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{LDO_efficiency.pdf}
    \caption{High-voltage LDO efficiency at \SI{2.5}{V} in function of the load current}
    \label{fig:LDO_efficiency}
\end{figure}


\chapter{Sensing subsystem}

Sound waves are generated by the variation of a physical characteristic, the pressure. This deviation propagates via vibrations in the environment in such a way that sound can be measured by a microphone from a distance of the source.

Sound waves are often described in terms of sinusoidal plane waves (see Figure~\ref{fig:sound_wave}). Hence, they have a direction of propagation, a speed $v$, a frequency $f$ and an amplitude $A$. 

\begin{figure}[H]
\centering
\begin{tikzpicture}[x={(-10:1cm)},y={(90:1cm)},z={(210:1cm)}]
    % Axes
    \draw (-1,0,0) node[above] {$x$} -- (5,0,0);
    \draw (0,0,0) -- (0,2,0) node[above] {$y$};
    \draw (0,0,0) -- (0,0,2) node[left] {$z$};
    % Propagation
    \draw[->,ultra thick] (5,0,0) -- node[above] {$v$} (6,0,0);
    % Waves
    \draw[thick] plot[domain=0:4.5,samples=200] (\x,{cos(deg(pi*\x))},0);
    % Arrows
    \foreach \x in {0.1,0.3,...,4.4} {
        \draw[->,help lines] (\x,0,0) -- (\x,{cos(deg(pi*\x))},0);
    }
    % Labels
    \node[above right] at (0,1,0) {$A$};
    \node[below] at (0,0,1) {};
\end{tikzpicture}
\caption{General sound wave description}
\label{fig:sound_wave}
\end{figure}

The amplitude of sound pressure corresponds to the loudness of a sound and is typically expressed as the root mean square (RMS) amplitude, called sound
pressure level (SPL). Let the RMS sound pressure be $p=A/\sqrt{2}$ for sine waves, the SPL amplitude is given by
\[
 L_p = 20\log_{10}\left(\frac{p}{p_0}\right) \simeq 20\log_{10}(p) + 94 \quad [\si{dB_{SPL}}]
\]
where $p_0=\SI{20}{\micro Pa}$ is the reference RMS pressure (hearing threshold of humans at \SI{1}{kHz}).

Additionally, the sound SPL amplitude changes over the distance (from $r_1$ to $r_2$) according to the propagation of spherical waves:
\[
 L_{p_2} = L_{p_1} + 20\log_{10}\left(\frac{r_2}{r_1}\right) \quad [\si{dB_{SPL}}].
\]

Table~\ref{tab:sound_levels} gives typical sound pressure levels.

\begin{table}[H]
\centering
\scalebox{1}{
\begin{tabular}{lcc}
\toprule
  Source of sound & Distance & Sound pressure [dB] \\ \midrule
  Jet engine           & \SI{1}{m}   & 150 \\
  Trumpet              & \SI{0.5}{m} & 150 \\
  Traffic on busy road & \SI{10}{m}  & 90  \\
  Passenger car        & \SI{10}{m}  & 70  \\
  Quiet room           & ambient     & 25  \\ \bottomrule
\end{tabular}
}
\caption{Typical sound pressure levels}
\label{tab:sound_levels}
\end{table}

In this work, the sensor is required to detect the song of a bird (around \SI{50}{dB_{SPL}} at \SI{1}{m} of the source) located \SI{50}{m} away. The minimum detected sound pressure is thus
\[
 L_{p_\te{min}} = 50 - 20\log_{10}(50) = \SI{16}{dB_{SPL}}.
\]
Sound production from several bird species have been measured to peaks of about \SI{95}{dB_{SPL}} and are generally greater for larger birds~\cite{FHWA}. The sensor thus needs to detect sounds of at least
\[
 L_{p_\te{max}} = 95 - 20\log_{10}(50) = \SI{61}{dB_{SPL}}.
\]

The frequency range of human hearing is often reported to be between 20 and \SI{20000}{Hz}, but the ability to hear higher frequencies decreases with age. For this reason, a correction, called A-weighting, is applied to instrument-measured sound levels to account for the relative loudness perceived by the human ear as a function of the frequency (see Figure~\ref{fig:a_weighting}).

\begin{figure}[H]
    \centering
    \input{img/a_weighting.tex}
    \caption{A-weighting curve}
    \label{fig:a_weighting}
\end{figure}

Many bird songs have frequency ranges between \SI{1000}{Hz} and \SI{8000}{Hz}, which places them in the spot of human hearing. However, some birds can produce sounds at frequencies\footnote{One might also want to assess the impact of moving birds on the frequency. For this purpose, the Doppler effect characterizes the frequency $f$ perceived at the sensor node compared to the emitted frequency $f_s$ of the bird when it moves at speed $v_s$. The relative variation of frequency is given by $ f/f_0 = \frac{v}{v \pm v_\text{s}}$ where $v$ is the sound velocity (\SI{343}{m/s} in ambient conditions). For a typical bird velocity (\SI{12}{m/s}), the equation provides a relative variation of $\pm \SI{4}{\%}$, which corresponds to a small (but non-negligible) impact on the perceived frequency} as low as \SI{23}{Hz}~\cite{10.2307/4090277} or as high as \SI{15}{kHz}~\cite{doi:10.1111/j.1474-919X.1962.tb08647.x}. Since the presented sensor aims to mainly analyze bird sounds, it has to match the frequency specifications ranging between \SI{20}{Hz} and \SI{20}{kHz}.

In the end, the characteristics of the sound wave at the sensor are summed up in Table~\ref{tab:wave_charact_sensor}.

\begin{table}[H]
\centering
\scalebox{1}{
\begin{tabular}{lcc}
\toprule
  Pressure range & 16 -- 61 & \si{dB_{SPL}} \\
  Frequency range  & 20 -- 20000 &  Hz      \\ \bottomrule
\end{tabular}
}
\caption{Sound wave characteristics at the sensor}
\label{tab:wave_charact_sensor}
\end{table}


As depicted in Figure~\ref{fig:sensing_subsystem}, the sensing subsystem is composed of a microphone and a signal conditioning circuit called analog front-end. This block handles the signal transmission from the input sound pressure detected by the microphone to an analog voltage $V_{\te{ADC,mic}}$ further processed by a microcontroller.

\begin{figure}[H]
\centering
\begin{tikzpicture}
    \node (afe) [afes] {Analog Front-End};
    \path (afe.0)+(-6,0) node (mic) [sensor] {Microphone};
    \path [draw, ->] (mic) -- node [above] {$I_{\te{mic,AC}}$} (afe.west |- mic) ;
    \draw [->] (afe.0) -- node [ann] {} + (1,0) node[right] {$V_{\te{mic,ADC}}$};
\end{tikzpicture}
\caption{Block diagram of the sensing subsystem}
\label{fig:sensing_subsystem}
\end{figure}

\section{Microphone}

A microphone is a device that converts sound into an electrical signal (also called transducer). Generally, they mimic the inner workings of human ear by using a diaphragm which vibrates with the sound pressure. There exist several types of microphones for which the most important characteristics, called figures of merit, need to be compared.


\subsection*{Main types of microphone}

Microphones are categorized by their transducer principle, corresponding to the way they detect the variation of input sound pressure.

\subsubsection*{Carbon microphones}

Carbon microphones were the first created type of electrical microphone. They are based on the variation of electrical resistance between two plates due to the motion of a diaphragm on one of these plates. This type of microphone is less used because of its limited frequency response and high noise level (background and crackling noise~\cite{background.noise}).

\subsubsection*{Optical microphones}

Optical microphones use the moving diaphragm as a reflection plate for the light of a laser. The intensity of the light, dependent on the deformation of the diaphragm, is converted to an electrical signal through a photodiode. Their high power consumption (more than \SI{5}{mW}, \SI{5.4}{mW} in~\cite{optical_microphone})  prevents them from being used in IoT applications.

\subsubsection*{Condenser microphones}

Condenser microphones are based on a parallel-plate capacitor for which one of the plates is the diagram. For a fixed charge $Q$ on the capacitor, the voltage across the capacitor varies with the capacitance according to
\[
V = \frac{Qd}{\varepsilon A}
\]
where $s$ is the distance between the plates, $A$ is the area of the plate, and $\varepsilon$ is the electric permittivity of the medium inside the plates.

This type can be further divided in active and passive condenser microphones.

Active condenser microphones require biasing circuitry to charge the capacitor and perform first stage amplification. In this group belong microelectromechanical systems (MEMS) microphones which are small package condenser microphones made using semiconductor production techniques. Typically, they already integrate an ADC inside. The small size and the rather low power consumption (\SI{10}{\micro W} to  \SI{1}{mW}~\cite{ICS40720},~\cite{10.3390/mi9070323}) of MEMS microphones is ideal for IoT applications.
 
Passive condenser microphones do not require biasing of the capacitor. For instance, condenser electret microphones have an electret material as diaphragm, a material that has a permanent electrical charge on it. Passive microphones are also appealing for their low power consumption and reduced complexity.
 
\subsubsection*{Piezoelectric microphones}

Piezoelectric microphones directly translate the sound pressure into a voltage through the use of a piezoelectric crystal, which redistributes the charges in the crystal under a deformation. They can be packaged in MEMS microphones and have a low power consumption (about \SI{300}{\micro W}~\cite{PMM-3738-VM1000-R}). However, their high impedance makes them sensitive to electrostatic pick-up of hum\footnote{Mains hum electric hum is a sound associated with alternating current at the frequency of the mains electricity (\SI{50}{Hz}).}, which decreases its performance in the presence of mains-powered audio equipment or AC electromagnetic fields from nearby appliances.

\subsubsection*{Inductive microphones}

Inductive microphones are passive microphones working via electromagnetic induction. The vibrations of the diaphragm move a permanent magnet through a coil, inducing an electrical current. They are generally less sensitive, especially at picking up high frequencies and short, detailed sounds. They are also unable to pick up distant sounds laterally and from the back of the microphone, which may lead to flatter audio (unidirectionality). They are thus not suited for this application.


\subsection*{Figures of merit}

In order to select the most suited type of microphone for this application, one has to characterize the main microphone's figures of merit.

\subsubsection*{Power consumption}

For both active and passive microphones, the operation current and voltage are of essential importance in IoT applications. The standard operation voltage $V_{\te{mic}}$ is the voltage needed by the microphone to operate with full functionality, so that the microphone can amplify and record signals fully. The maximum current consumption is often specified to provide a rough upper limit. However, one is more interested in the measurement of the microphone IV curve which allows deducing the operation current $I_{\te{mic}}$ at the operation voltage.

\subsubsection*{Sensitivity}

Sensitivity is the electrical response at the microphone output to a given standard acoustic input. The standard reference input signal for microphone sensitivity measurements is a \SI{1}{kHz} sine wave at \SI{94}{dB_{SPL}}, or \SI{1}{Pa}. It is expressed in \si{V/Pa} or in \si{dB}.

\subsubsection*{Signal-to-noise ratio}

In the microphone's framework, the signal-to-noise ratio (SNR) specifies the ratio of a reference signal to the noise level of the microphone output. Brought back to the input, the SNR is the difference in decibels between a standard \SI{1}{kHz}, \SI{94}{dB_{SPL}} reference signal and a microphone pressure noise. It is an image of the noise generated inside the microphone, called self-noise. Expressed in \si{dB_{SPL}}, self-noise acts like a theoretical external noise source placed at the input of an ideal microphone. The relation between the self-noise and the SNR is thus given by
\[
 \te{SNR} = 94 - \te{self-noise} \quad \si{[dB]}.
\]
SNR is calculated by measuring the noise output of the microphone in a quiet, anechoic environment. This specification is typically presented over a \SI{20}{kHz} bandwidth as an A-weighted value.

\subsubsection*{Frequency response}

The frequency response describes the output level across the frequency spectrum. The high and low frequency limits are described as the points at which the microphone response is \SI{3}{dB} below the reference output level at \SI{1}{kHz}, which is customarily normalized to \SI{0}{dB}. As for the SNR, the frequency response characterization requires precise measurements in anechoic chamber. Typical microphone frequency ranges lie in the human hearing range.

\iffalse
\subsubsection*{Output impedance}

The output impedance is a measurement of the AC resistance (at \SI{1}{kHz}) looking back into the microphone.
\fi

\subsubsection*{Directionality}

Directionality describes the pattern in which the microphone’s sensitivity changes when the sound source changes position in space. Most of the analyzed microphones are omnidirectional.


Finally, the main figures of merit associated with a microphone are summarized below:

\begin{itemize}
 \item $I_{\te{mic}}$: rated current (in [A]),
 \item $V_{\te{mic}}$: rated voltage (in [V]),
 \item $S$: sensitivity from the input sound pressure to the output voltage (in [dB]),
 \item $\te{SNR}_{\te{mic}}$: signal-to-noise ratio (in [dB]),
% \item $R_\te{L}$: output impedance (in [\si{\ohm}]),
 \item the frequency range (in [Hz]),
 \item the directionality,
 \item and the operating temperature (in [\si{\degree C}]).
\end{itemize}


\subsection*{Microphone type selection}

IoT devices are limited by their size, cost and energy requirements. Table~\ref{tab:mic_types_comparison} quantitatively summarizes the two main characteristics for each type of microphone.

\begin{table}[H]
\centering
\scalebox{0.98}{
\begin{tabular}{lccc}
\toprule
  Type                 & Reference      & Noise [\si{dB_{SPL}}] & Power cons. [\si{\micro W}]             \\ \midrule
  Condenser (MEMS)     & ICS-40720  & 24 & 570     \\
  Condenser (Electret) & AOM-5024L-HD-R & 14 & 420     \\
  Piezoelectric        & PMM-3738-WP-R  & 33 & 300     \\ \bottomrule
\end{tabular}
}
\caption{Comparison of several types of microphone}
\label{tab:mic_types_comparison}
\end{table}

A piezoelectric microphone is not considered due to its sensitivity to electrostatic pick-up of hum. MEMS and electret condenser microphones are very similar and well suited for this application, but MEMS microphones already have the amplification circuit inside.
Finally, an electret condenser microphone is selected for this work since it allows a precise design of the amplification circuit, optimizing the whole noise and power consumption.

\subsection*{Electret condenser microphone selection}

Considering the main figures of merit stated above, Table~\ref{tab:mic_comparison} compares several state-of-the-art electret condenser microphones.

\begin{table}[H]
\centering
\scalebox{0.95}{
\begin{tabular}{lccc}
\toprule
                              & ABM-707-RC  & CMC-6027-24L100 & AOM-5024L-HD-R \\ \midrule
 Current [\si{\micro}A]       & 500         & 500             & 500            \\
 Voltage [V]                  & 1.5         & 2               & 2              \\
 Sensitivity [dB]             & -41         & -24             & -24            \\
 SNR [dB]                     & 60          & 70              & 80             \\
 Output impedance [\si{\ohm}] & 2.2         & 2.2             & 2.2            \\
 Frequency range [Hz]         & 50 -- 16000 & 100 -- 20000    & 20 -- 20000    \\
 Temperature [\textdegree C]  & -20 -- 60   & -20 -- 70       & -30 -- 70      \\ \bottomrule
\end{tabular}
}
\caption{Comparison of several electret condenser microphones}
\label{tab:mic_comparison}
\end{table}

The AOM-5024L-HD-R microphone has been selected since it surpasses the others in terms of the most important parameters, the self-noise (related to the SNR) and the sensitivity, while keeping roughly the same power consumption.With its self-noise of \SI{14}{dB_{SPL}}, it is in fact the only microphone that allows staying below the \SI{16}{dB_{SPL}} limit for the minimum detectable sound wave.

However, one has to characterize more precisely the current and voltage characteristics because the values given in the datasheets are very general (current of \SI{500}{\micro A} and voltage of \SI{2}{V}). The IV curve of the AOM-5024L-HD-R and the ABM-707-RC\footnote{The ABM-707-RC, which was initially available in the laboratory, served as a first measurement to characterize the microphone and the analog front-end.} is given in Figure~\ref{fig:IV_mic}.

\begin{figure}[H]
    \centering
    \input{img/IV_mic.tex}
    \caption{IV curve of several microphones}
    \label{fig:IV_mic}
\end{figure}

%\textcolor{green}{Retest SMU with less noise (adapt correct range of measurement) -> K2400}

%\textcolor{green}{For AOM-5024L: test variation of audio sensitivity with the operating voltage (relative compared to 2 V) with a fixed sound source: possible to bias below 2 V ? -> mydaq}

In order to select the best operating voltage, one has to find a trade-off between keeping a low voltage (and thus a low power consumption) and having a sufficient sensitivity by retaining the microphone transistor in saturation. Finally, the operating point given in Table~\ref{tab:op_point_mic} for the AOM-5024L-HD-R will be considered in the following. One can sadly notice a power consumption slightly higher than the reference microphone, this model remains the best suited because of his high precision (the self-noise of the reference microphone is too high to be considered in this work).

\begin{table}[H]
\centering
\begin{tabular}{lcc}
\toprule
 Current & $I_{\te{mic}}$   & \SI{358}{\micro A} \\
 Voltage & $V_{\te{mic}}$   & \SI{2}{V}          \\ \bottomrule
\end{tabular}
\caption{Operating point of the AOM-5024L-HD-R microphone}
\label{tab:op_point_mic}
\end{table}

\section{Analog front-End}
\label{section:AFE}

Once the microphone type is selected, one can analyze in more detail the working principle of electret microphones.
The voltage variation across the electret capacitor varies with the capacitance, acting as an ac-coupled voltage source. Because the charge on the microphone capacitor must be fixed, the amplifier circuitry directly in contact with it must have extremely high input impedance, such that no charge can flow through the amplifier circuit. 

For this reason, most electret microphones have an internal junction field-effect transistor (JFET) which buffers the microphone capacitor. The voltage signal produced by sound modulates the gate voltage of the JFET ($V_\te{G}$), causing a change in the current flowing between the drain and source of the JFET ($I_{\te{mic}}$). An extremely high resistance may be included to bias the gate of the JFET, but parasitic resistance in the microphone PCB will be sufficient in this work.

\begin{figure}[H]
\centering
\begin{circuitikz}[scale=0.5]
    \draw (3.5,-4) node[op amp, scale = 0.5](opamp){} 
        (opamp.+) node[left] {}
        (opamp.-) node[left] {}
        (opamp.out) node[right] {}
        (opamp.down) node[ground] {}
        (opamp.up) ++ (0,.5) node[above] {$V_\te{CC}$}
        -- (opamp.up);
    \draw (3.5,4.5) --  (1.0,4.5) -- (1.0,1.5); % wire w3_w5 polyline 
    \draw (3.5,1.5)-- (1.0,1.5);% wire w6
    \draw (8.5,1.5)-- (6.0,1.5);% wire w8
    \draw (8.5,1.5) --  (8.5,4.5) -- (5.5,4.5); % wire w4_w7 polyline 
    \draw (-7.0,1.5)-- (-7.0,2.0);% wire w9
    \draw (-7.0,-3.5)-- (-7.0,-2.0);% wire w11
    \draw (-8.5,-6.0)-- (-8.5,-6.0);% wire w21_w22 end
    \draw (-7.0,-3.5) to [red,short,i_=$I_{\te{mic}}$] (-7,-5) to[Tnjfet,n=jfet,mirror] (-7.0,-13.0);
    \node (A) at (-10,1) {};
    \draw (jfet.G) -- (A |- jfet.G) to[C] (-10,-13) -- (-7,-13);
    \draw (-3.5,-3.5)to[red,short, i=$I_\te{AC}$] (-7.0,-3.5);% wire w12
    \draw (1.0,-3.5)-- (1.0,1.5);% wire w13
    \draw (1.0,-3.5)-- (-1.5,-3.5);% wire w14
    \draw (opamp.-)-- (1.0,-3.5);% wire w15
    \draw (8.5,-4.0)-- (8.5,1.5);% wire w16
    \draw (8.5,-4.0)-- (opamp.out);% wire w17
    \draw (10.0,-4.0)-- (8.5,-4.0);% wire w18
    \draw (2.5,-4.5)-- (2.5,-4.5);% wire w19_w29 start
    \draw (1.5,-10.5)-- (1.5,-10.5);% wire w19_w29 end
    \draw (opamp.+) --  (1.5,-4.5) -- (1.5,-10.5); % wire w19_w29 polyline
    \draw (-3.0,-7.5)-- (-3.0,-7.0);% wire w24
    \draw (-8.5,-7.5)-- (-8.5,-7.5);% wire w23_w25 end
    \draw (-3.0,-10.5)-- (-3.0,-10.0);% wire w28
    \draw (1.5,-10.5)-- (-3.0,-10.5);% wire w30
    \draw (-3.0,-11.0)-- (-3.0,-10.5);% wire w31
    \draw (1.5,-11.5)-- (1.5,-10.5);% wire w32
    \draw (-3.0,-14.5)-- (-3.0,-13.5);% wire w33
    \draw (1.5,-13.5) --  (1.5,-14.5) -- (-3.0,-14.5); % wire w34_w35 polyline 
    \draw (-3.0,-15.0)-- (-3.0,-14.5);% wire w36
    \draw (-3.0, -15.0) node[ground, xscale=1, yscale=1, rotate=0, ] (undefined) {};%  (undefined)++(0.0,0.0) node {undefined }; % component "circuiTikz\\gnd" "undefined" 
    \draw (-7.0, -13.0) node[ground, xscale=1, yscale=1, rotate=0, ] (undefined) {};%  (undefined)++(0.0,0.0) node {undefined }; % component "circuiTikz\\gnd" "undefined" 
    \draw (-7.0, 1.5) to[R, l=$R_1$] (-7.0,-1.5){} to[red,short,i=$I_{DC}$] (-7.0,-2.0); %\node [] at (-7.5,1.0) {x}; % component "res" "R1" 
    \draw (-3.5, -3.5) to[C, l=$C_1$] (-1.5,-3.5){}; % component "cap" "C1" 
    %\node [] at (-1.5,-3.0) {x}; % component "cap" "C1" 
    \draw (5.5, 4.5) to[C, l=$C_2$] (3.5,4.5){}; % component "cap" "C2" 
    %\node [] at (5.5,5.0) {x}; % component "cap" "C2" 
    \draw (6.0, 1.5) to[R, l=$R_2$] (3.5,1.5){}; %\node [] at (6.5,2.0) {x}; % component "res" "R2" 
    \draw (-3.0, -7.5) to[R, l=$R_3$] (-3.0,-10.0){}; %\node [] at (-3.5,-7.0) {x}; % component "res" "R3" 
    \draw (-3.0, -11.0) to[R, l=$R_4$] (-3.0,-13.5){}; %\node [] at (-3.5,-10.5) {x}; % component "res" "R4" 
    \draw (1.5, -13.5) to[C, l=$C_3$] (1.5,-11.5){}; % component "cap" "C3" 
    %\node [] at (2.0,-13.5) {x}; % component "cap" "C3" 
    \node (VCC) [] at (-7.0,2+0.5) {$V_\te{CC}$};% label mark % label "" "VCC" lbl37 
    \node (Vb) [right] at (1.5,-10) {$V_\te{B}$};
    \node (VCC) [] at (-3.0,-7.0+0.5) {$V_\te{CC}$};% label mark % label "" "VCC" lbl40 
    \node (Vout) [] at (11.0+1,-4.0) {$V_{\te{mic,ADC}}$};
    \node (Vout) [] at (-11.0,-9.0) {$V_\te{G}$};
    \node (lbl88) [lttotitextcolor, align=left] at (-11,-8) {Electret microphone\\ model};% text mark % text "" "Electret microphone model lbl88 " 
    \draw [lttotitextcolor, line width=0.4pt, dashed] (-15.0,-14.5) rectangle (-6.0,-7.0); % sch Rect % schLine "SchRect" (-736, 368)->(-160, 128) style=1
\end{circuitikz}
\caption{Microphone and analog front-end circuit}
\label{fig:circuit_AFE}
\end{figure}

The amplification circuit presented in Figure~\ref{fig:circuit_AFE} is typical for condenser electret microphones~\cite{tidu765}. It allows converting the microphone current $I_\te{AC}$ into an output voltage $V_{\te{mic,ADC}}$ which sweeps the input of a further ADC.

The current in the microphone $I_\te{mic}$ has a DC component ($I_\te{DC}$) necessary to put the internal JFET in the saturation region, and an
AC component ($I_\te{AC}$) caused by sound waves. If the impedance of capacitor $C_1$ is much less than $R_1$ at audio frequencies, then $I_\te{AC}$ will flow through $C_1$ and not $R_1$. The op-amp acts as a transimpedance amplifier, and attempts to hold its inverting input at a constant voltage $V_\te{B}$ by varying its output. The resistors and capacitors of the circuit will be further designed such that in the audio sound frequency band, $C_2$ and $C_3$ are open-circuited, and  $C_1$ is short-circuited.
In this case, the output voltage of the op-amp is simply given by
\[
 V_{\te{mic,ADC}} = R_2\, I_\te{AC} + V_\te{B} \quad \si{[V]}
\]
in this frequency band (see Appendix~\ref{appendix:transimpedance} for details).

Because capacitor $C_3$ is chosen to have a very low impedance at audio frequencies, the voltage at the drain of the microphone JFET ($V_\te{DS}$) varies very little, potentially reducing distortion caused by channel length modulation in the JFET. This makes the circuit very convenient since the drain current $I_\te{mic}$ only depends on the JFET gate voltage $V_\te{G}$, and not the constant voltage $V_\te{DS}$.


Designing this amplification circuit requires more attention than for the microphone since it induces consequent noise which is mainly due to the operational amplifier. The next computations will introduce a trade-off between the noise reduction and the power consumption of common operational amplifiers.

\subsection*{Amplification circuit design}

The parameters of the AOM-5024L-HD-R microphone selected for this design are summed up in Table~\ref{tab:selected_mic_charac} with the experimental current measurements.

\begin{table}[H]
\centering
\scalebox{0.95}{
\begin{tabular}{lcc}
\toprule
 Op. current      & $I_{\te{mic}}$        & \SI{210}{\micro A}                        \\
 Op. voltage      & $V_{\te{mic}}$        & \SI{2}{V}                                 \\
 Sensitivity      & $S_{\te{mic,dB}}$     & \SI{-24}{dB}                              \\
 SNR              & $\te{SNR}_{\te{mic}}$ & \SI{80}{dB}                               \\
 Output impedance & $R_{\te{L,mic}}$      & \SI{2.2}{k\ohm}                           \\
 Frequency range  &                       & \SI{50}{Hz} -- \SI{16}{kHz}               \\
 Temperature      &                       & \SI{-20}{\degree C} -- \SI{60}{\degree C} \\
 \bottomrule
\end{tabular}
}
\caption{Characteristics of the selected microphone: AOM-5024L-HD-R}
\label{tab:selected_mic_charac}
\end{table}

The microphone self-noise is given by $p_{\te{SN,dB}} = \SI{14}{dB}$ and $ p_{\te{SN}} = \SI{100}{\micro Pa}$.

\subsubsection*{Gain calculation}

First, the dB value of the sensitivity must be converted to a linear value, which is
\[
 S_{\te{V,mic}} = 10^{S_{\te{mic,dB}}/20} = \SI{63.1}{mV/Pa}
\]
expressed in volts per Pascal of air pressure.

Because the preamplifier is a transimpedance type, this must be converted to a value of current per Pascal of air pressure. It can be converted thanks to the microphone impedance, which was used to measure the microphone sensitivity. The output current per Pascal of air pressure is
\[
 S_{\te{I,mic}} = \frac{S_{\te{V,mic}}}{R_{\te{L,mic}}} = \SI{28.7}{\micro A/Pa}.
\]
Then, one has to map the minimum detected input sound pressure to the minimum detected output voltage of the amplifier.

The minimum input sound pressure, determined at the beginning of the chapter, is given by
\[
 L_{p,\te{min}} = \SI{16}{dB_{SPL}} \quad \Rightarrow \quad p_\te{min} = p_0 \, 10^{L_{p,\te{min}}/20} = \SI{126}{\micro Pa},
\]
which is expressed in RMS value. It corresponds to a minimum drain current in the microphone of 
\[
 I_{\te{mic,min,RMS}} = S_{\te{I,mic}} \, p_\te{min} = \SI{3.63}{nA}.
\]
The minimal output voltage depends on the ADC resolution of the microcontroller unit. The STM32L15 has a 12-bit resolution and the operating voltage $V_\te{CC}$ is \SI{2.5}{V} (see Section~\ref{section:operating_voltage}). The ADC resolution is thus
\[
 V_{\te{ADC,res}} = \frac{V_\te{CC}}{2^{12}} = \SI{610}{\micro V}.
\]
In order for the input signal to be read with sufficient precision (6 bits) by the ADC, it has to vary higher than $2^6 \,V_{\te{ADC,res}}$. Based on Figure~\ref{fig:ADC_res}, one can deduce the minimum RMS voltage:
\[
 2^6 \, V_{\te{ADC,res}} = 2 \sqrt{2} \, V_\te{ADC,RMS} \quad \Rightarrow \quad V_\te{ADC,RMS} = 2^4 \sqrt{2} \, V_{\te{ADC,res}} = \SI{13.8}{mV}
\]
or $V_{\te{ADC,RMS}} = \SI{-37.2}{dBV}$.

\begin{figure}[H]
\centering
\begin{tikzpicture}[scale=1]
% Axes:
\draw [->] (-3,0) -- (4,0) node [right]  {$t$};
\draw (-3,0.5) -- (3,0.5) ;
\draw[dashed] (-3,1.5) -- (3,1.5) ;
\draw (-3,2.5) -- (3,2.5) ;
\draw[red] (-3,1.5) sin (-2,2.8) cos (-1,1.5) sin (0,0.2) cos (1,1.5) sin (2,2.8) cos (3,1.5);
\draw[<->] (-3.2,0.5) -- (-3.2,2.5);
\node (Vres) [] at (-4.5,1.5) {$2^6 \, V_{\te{ADC,res}}$};
\draw[<->,brown] (2,1.5) -- (2,2.8);
\node (Vadc) [brown] at (2.5,1.1) {$\sqrt{2} \, V_\te{ADC,RMS}$};
\node (Vadc) [red] at (4,2) {$V_\te{ADC}(t)$};
\end{tikzpicture}
\caption{Resolution and RMS values of ADC voltage}
\label{fig:ADC_res}
\end{figure}

Then, one can compute the transimpedance gain, which maps the RMS values of the input current to the output voltage:
\[
 R_2 = \frac{V_\te{ADC,RMS}}{I_{\te{mic,min,RMS}}} = \SI{3.81}{M\ohm}.
\]
The maximum microphone RMS current appears when the ADC voltage is maximum:
\[
 I_{\te{mic,max,RMS}} = \frac{V_\te{CC}/(2\sqrt{2})}{R_2} = \SI{232}{nA},
\]
corresponding to a maximal input sound pressure of
\[
   p_\te{max} = \frac{I_{\te{mic,max,RMS}}}{S_{\te{I,mic}}} = \SI{8.1}{mPa} \quad \Rightarrow \quad L_{p,\te{max}} = 20\log_{10}\left(\frac{p_\te{max}}{p_0}\right) = \SI{52.1}{dB_{SPL}}.
\]
The input spreads from \SI{16}{dB_{SPL}} to \SI{52.1}{dB_{SPL}}, giving a variation of \SI{36.1}{dB}. It is worth noting that, when expressed in dB, the input variation is exactly equal to the 6-bit output variation\footnote{This is the difference between the bit resolution of the ADC (12) and the number of bits used for the minimum detectable signal (6).} since 
\[
 20\log_{10}\left(2^{6}\right) = \SI{36.1}{dB}.
\]
Thereby, there is a trade-off between the number of bits dedicated to the minimum ADC signal (6 bits) and the input pressure range (6 bits) since they sum to the ADC resolution (12 bits). Still, the maximum input sound pressure of \SI{52.1}{dB_{SPL}} suits quite well the requirements of this work, for which a louder sound is rarely produced by birds (about \SI{60}{dB_{SPL}} at the source~\cite{10.1007/s00265-009-0743-4}).
Figure~\ref{fig:mic_scales} depicts the three main variables of the sensing subsystem expressed in dB scale: the input sound pressure $p$, the microphone voltage $V_{\te{mic}}$ and the output voltage $V_\te{ADC}$.

\begin{figure}[H]
\centering
\begin{tikzpicture}[scale=1]
\def\SPLmin{1.6}
\def\res{3.61}
\def\vmin{3.72}
\def\Sens{2.4}
\draw[dashed, brown] (-4,\SPLmin) -- (4,\SPLmin) ;
\draw[dashed, brown] (-4,\SPLmin+\res) -- (4,\SPLmin+\res) ;
\draw[<->,brown] (-5,\SPLmin) -- (-5,\SPLmin+\res);
\node (Vadc) [brown,align=left] at (-6,\SPLmin+\res/2) {Input\\pressure\\range};
\draw[<->,brown] (5,\SPLmin) -- (5,\SPLmin+\res);
\node (Vadc) [brown,align=left] at (6,\SPLmin+\res/2) {Output\\voltage\\range};
\draw[->](-4,0)--(-4,10)node[font=\small,above]{$p$ [\si{dB_{SPL}}]};
\foreach\y in {10,20,...,90}{
 \draw[](-4,\y/10)--(-4.1,\y/10)node[left,font=\small]{$\y$};
}
\draw[->](-2,0)--(-2,10)node[font=\small,above]{$p$ [\si{dB}]};
\foreach\y in {-90,-80,...,0}{
 \draw[](-2,\y/10+9.4)--(-2.1,\y/10+9.4)node[left,font=\small]{\y};
}
\draw[->](1,0)--(1,13)node[font=\small,above]{$V_\te{mic}$ [\si{dBV}]};
\foreach\y in {-110,-100,...,0}{
 \draw[](1,\y/10+9.4+\Sens)--(0.9,\y/10+9.4+\Sens)node[left,font=\small]{\y};
}
\draw[->](4,0)--(4,10)node[font=\small,above]{$V_\te{ADC}$ [\si{dBV}]};
\foreach\y in {-40,-30,...,40}{
 \draw[](4,\y/10+\SPLmin+\vmin)--(3.9,\y/10+\SPLmin+\vmin)node[left,font=\small]{\y};
}
\draw[dashed, purple] (-2,9.4) -- (-0.5,9.4) ;
\draw[dashed, purple] (-0.5,9.4+\Sens) -- (2.5,9.4+\Sens) ;
\draw[latex-, purple](-0.5,9.4+\Sens)--(-0.5,9.4);
\draw[latex-, purple](2.5,\SPLmin+\vmin)--(2.5,9.4+\Sens);
\draw[dashed, purple] (2.5,\SPLmin+\vmin) -- (3.5,\SPLmin+\vmin) ;
\node (Vadc) [purple,align=left] at (1.8,\SPLmin+\res+3.5) {$G_{\te{V,dB}}$};
\node (Vadc) [purple,align=left] at (-1.5,\SPLmin+\res+6) {$S_{\te{mic,dB}}$};
\draw[->,dashed] (-2,12.0) to [out=70,in=190] (-0.4,13.2) ;
\draw[->,dashed] (2.2,13.2) to [out=-20,in=100] (3.7,11.5) ;
\node (Vadc) [] at (-2,13.5) {Microphone};
\node (Vadc) [align=left] at (4.5,13.5) {Amplification\\circuit};
\node (Vadc) [teal,align=left] at (-6,1.2) {Microphone\\self-noise};
\draw[dashed, teal] (-4.8,1.4) -- (-4,1.4) ;
\end{tikzpicture}
\caption{Range of $p$, $V_{\te{mic}}$ and $V_\te{ADC}$ along the dB scale}
\label{fig:mic_scales}
\end{figure}

The output ADC voltage has been fixed by the microcontroller specifications.
The minimum input sound pressure, expressed both in \si{dB} and \si{dB_{SPL}}, has then been mapped to the minimum ADC voltage and in turn fixed the maximum input sound pressure.

The only remaining degree of freedom for the microphone and amplification circuit lies in the relative position of the scale in between, characterizing the microphone voltage. This voltage is obtained from the input sound through the microphone sensitivity $S_{\te{mic,dB}}$, and is converted to the ADC voltage through the voltage gain of the amplification circuit:
\[
 G_{V,\te{dB}} = \frac{V_\te{ADC,RMS}}{V_\te{mic,RMS}} = \frac{R_2 \, I_\te{mic,RMS}}{V_\te{mic,RMS}} = \frac{R_2}{R_\te{L}} \quad \si{[dB]}.
\]
Since the input/output relation is given by
\begin{align*}
  p_\te{dB} + S_{\te{mic,dB}} + G_{\te{V,dB}} &= V_\te{ADC,RMS} \quad \si{[dB]},\\
  \SI{16}{dB} - \SI{94}{dB} + S_{\te{mic,dB}} + G_{\te{V,dB}} &= 
  \SI{-37.2}{dB},
\end{align*}
the scale of the microphone voltage needs to be adapted according to
\[
 S_{\te{mic,dB}} + G_{\te{V,dB}} = \SI{40.8}{dB}.
\]
This relation is useful for a parallel optimization of both the microphone and amplification circuit aiming at selecting the best noise/current consumption characteristic. However, the previous microphone selection has fixed the sensitivity at \SI{-24}{dB} and leads directly to a voltage gain of \SI{64.8}{dB}.

Finally, the self-noise for this microphone (\SI{14}{dB_{SPL}}) is below the minimum input sound pressure. Brought back to the input pressure domain, the AFE noise will also be computed and added to this intrinsic microphone noise.

\iffalse
\[
 V_\te{N,mic,ADC} = 10^{-\te{SNR}/20} \, S_{\te{mic}} \, G_{\te{V}} = \SI{205}{\micro V}
\]
is not much detected since it is less than the ADC resolution.
This microphone output noise voltage is then compared to the ADC voltage resolution, expressed as peak values:
\[
 \te{Microphone Noise Ratio} = \frac{\sqrt{2} \, V_\te{N,mic,ADC}}{V_{\te{ADC,res}}/2} = \SI{79}{\%}.
\]
\fi

The feedback capacitor $C_2$ compensates for parasitic capacitance at the op-amp inverting input which can cause instability. It also forms a high frequency pole with resistor $R_2$ in the response of the amplifier. According to the frequency range specified for the input sound pressure, the frequency of this pole must be $f_\te{H} = \SI{20}{kHz}$. The feedback capacitor value can then be calculated as
\[
 C_2 = \frac{1}{2 \pi \, f_\te{HF} \, R_2} = \SI{2.09}{pF}.
\]

\subsubsection*{Microphone bias resistor and coupling capacitor}

The internal JFET of the electret microphone being biased by resistor $R_1$, the value of this resistor can be calculated from the desired supply voltage ($V_\te{CC}$), and the microphone operating voltage ($V_\te{mic}$) and current consumption ($I_\te{mic}$):
\[
 R_1 = \frac{V_\te{CC} - V_\te{mic}}{I_\te{mic}} = \SI{2.38}{k\ohm}.
\]
Resistor $R_1$ and capacitor $C_1$ form a high-pass filter. The corner frequency of this filter must be low enough not to attenuate low-frequency sound waves. As specified in the input frequency range, a corner frequency of $f_\te{L} = \SI{20}{Hz}$ is used to calculate the value of $C_1$:
\[
 C_1 = \frac{1}{2 \pi \, f_\te{L} \, R_1} = \SI{3.34}{\micro F}.
\]
One can see that reducing $R_1$ (for a higher and thus better microphone operating voltage) requires a larger capacitance (implying more space and cost).

\subsubsection*{Operational amplifier}

The required slew rate of the amplifier can be determined by calculating the maximum rate of change at the op-amp output, arising  for a sine wave at $f_\te{max} = \SI{20}{kHz}$ and an amplitude of $V_\te{CC}/2$ which sweeps the full output range. For sine waves, it can be shown\footnote{This is the highest slope of a sine function, appearing when the signal crosses 0.} that the slew rate is computed as
\[
 \te{SR} = 2 \pi f_\te{max} \frac{V_\te{CC}}{2} = \SI{0.188}{V/\micro s}.
\]
As a conservative rule, it is advised to select ten times this slew rate to eliminate any possibility of slew-induced distortion, which is very important in the analysis of microphone data. This sets the required slew rate to \SI{1.88}{V/\micro s}.

The op-amp is selected such that it adds the lowest noise possible to the output of the amplification circuit, avoiding the degradation of the data processing. However, such low-noise operational amplifiers consume a lot of power. One thus has to analyze and compare several state-of-the-art op-amps in order to choose the one which suits the best this noise/power consumption trade-off for this application.

The related op-amp parameters that need to be well selected are the current consumption (quiescent current $I_\te{Q}$), the input current noise spectral density $I_\te{N}$, and the input voltage noise spectral density $E_\te{NV}$.

The ADC voltage noise at the output is based on three noise contributions. The first noise is the thermal noise from resistors $R_1$ and $R_2$:
\[
 E_\te{NR} = \sqrt{4 \, k_\te{B} \, T \, (R_1 \parallelsum R_2)} = \SI{6.26}{nV/\sqrt{Hz}}
\]
where $T = \SI{300}{K}$ is the temperature and $k_\te{B} = \SI{1.38e-23}{J/K}$ is the Boltzmann constant.

The second noise contribution is the op-amp input current noise:
\[
 E_\te{NI} = I_\te{N} \, (R_1 \parallelsum R_2) \quad \left[\si{V/\sqrt{Hz}}\right]
\]
where $I_\te{N}$ op-amp input current noise spectral density. The last noise supply is due to the op-amp input voltage noise $E_\te{NV}$.

The output noise spectral density of the amplifier circuit is then given by
\[
 E_\te{N,ADC} = A_\te{N} \sqrt{E_\te{NR}^2 + E_\te{NI}^2 + E_\te{NV}^2} \quad \left[\si{V/\sqrt{Hz}}\right]
\]
for which
\[
 A_\te{N} = 1 + \frac{R_2}{R_1} = 1600
\]
is the noise gain of the op-amp (see Appendix~\ref{appendix:noise_gain} for details). Since the signal gain is directly determined by $R_2$, a very low supply voltage $V_\te{CC}$ decreases the value of $R_1$, which increases the noise gain of the op-amp. Hence, the noise/power consumption trade-off also appears in the design of $R_1$.

Finally, the RMS output noise voltage can be computed by multiplying the output noise spectral density by the square of the bandwidth of integration (spreading over an A-weighting curve). An A-weighting curve can be approximated using a \SI{13.5}{kHz} noise bandwidth $B_\te{A}$, the RMS output noise voltage is thus (in RMS value)
\[
 V_\te{N,ADC} = \sqrt{B_\te{A}} \, E_\te{N,ADC} \quad [\si{V}].
\]
This noise contribution is then brought back to the input pressure domain, the \textit{input-referred noise} from the AFE is thus given by
\begin{align*}
  p_\te{IRN,AFE} &= \frac{V_\te{N,ADC}}{R_2\,S_{\te{I,mic}}}\\
   &= \frac{\sqrt{B_\te{A}}}{R_2\,S_{\te{I,mic}}} \left(1 + \frac{R_2}{R_1}\right) \sqrt{4 \, k_\te{B} \, T \, (R_1 \parallelsum R_2) + I_\te{N}^2 \, (R_1 \parallelsum R_2)^2 + E_\te{NV}^2} \quad \si{[Pa]}.
\end{align*}
One can directly see that this noise is roughly independent from the gain $R_2$ since $(1+R_2/R_1)/R_2\simeq 1/R_1$ in our design and the contribution from $I_\te{N}$ is typically negligible compared to $E_\te{NV}^2$.

\iffalse
As for the microphone noise, this output noise voltage is compared to the ADC voltage resolution, expressed as peak values:
\[
 \te{Op Amp Noise Ratio} = \frac{\sqrt{2} \, V_\te{N,ADC}}{V_{\te{ADC,res}}/2} \quad [\%].
\]
\fi

Since the total input-referred noise is composed of non-correlated sources (from the microphone $p_{\te{SN}}$ and the AFE $ p_\te{IRN,AFE}$), their noise powers add up to give
\[
 p_\te{IRN} = \sqrt{p_{\te{SN}}^2 + p_\te{IRN,AFE}^2} \quad \si{[Pa]}.
\]

Figure~\ref{fig:output_noise_op_amp} presents this input-referred noise with respect to the current consumption for several operational amplifiers. Clearly, the input-referred noise must not exceed the minimum signal sound pressure of \SI{16}{dB_{SPL}}.

\begin{figure}[H]
    \centering
    \input{img/input_noise.tex}
    \caption{Comparison of input-referred noise and current consumption for several operational amplifiers}
    \label{fig:output_noise_op_amp}
\end{figure}

The ultra-low-power LMV551 op-amp has a quiescent current of only \SI{37}{\micro A}, but the input-referred noise of \SI{17.85}{dB_{SPL}} exceeds the minimum detectable input pressure.
In order to keep the noise voltage not much detected from the ADC, the input-referred noise typically needs to be smaller than the minimum input signal (as depicted in Figure~\ref{fig:ADC_res_noise}).

\begin{figure}[H]
\centering
\begin{tikzpicture}[scale=1]
% Axes:
\draw [->] (-3,0) -- (4,0) node [right]  {$t$};
\draw (-3,0.5) -- (3,0.5) ;
\draw[dashed] (-3,1.5) -- (3,1.5) ;
\draw (-3,2.5) -- (3,2.5) ;
\draw[purple] (-3,1.5) sin (-2.5,1.7) cos (-2,1.5) sin (-1.5,1.3) cos (-1,1.5) sin (-0.5,1.7) cos (0,1.5) sin (0.5,1.3) cos (1,1.5) sin (1.5,1.7) cos (2,1.5) sin (2.5,1.3) cos (3,1.5);
\draw[<->] (-3.2,0.5) -- (-3.2,2.5);
\node (Vres) [align=left] at (-4.5,1.5) {Min range\\of $p_{\te{signal}}$};
\node (Vadc) [purple] at (4,2) {$p_\te{IRN}(t)$};
\end{tikzpicture}
\caption{Voltage noise and resolution at the amplification output}
\label{fig:ADC_res_noise}
\end{figure}

The OPA2834 has an input-referred noise of $p_\te{IRN,OA} = \SI{14.22}{dB_{SPL}}$ while keeping a particularly small current consumption of \SI{170}{\micro A}. One finally selects this op-amp since it has the lowest noise in the group of three op-amps which belong to an acceptable range of quiescent current (from \SI{100}{\micro A} to \SI{200}{\micro A}).

%Summing the noise contributions from the microphone and the operational amplifier leads to a total output voltage of 90\% compared to the ADC resolution. One thus expects a maximum digitized error of 1 consecutive code level introduced by the ADC quantization.

In the end, the OPA2834 op-amp characteristics are given in Table~\ref{tab:selected_op_amp}. The slew rate of \SI{26}{V/\micro s} is well above the limit of \SI{1.88}{V/\micro s}.

\begin{table}[H]
\centering
\scalebox{0.95}{
\begin{tabular}{lccc}
\toprule
 Criteria            & Required    & OPA2834  & Units             \\ \midrule
 Supply voltage      & 2.7 -- 5.4  & 2.5      & V                 \\
 Quiescent current   & < 200       & 170      & \si{\micro A}     \\
 Input voltage noise & < 27        & 12       & \si{nV/\sqrt{Hz}} \\
 Input current noise & N/A         & 0.2      & \si{pA/\sqrt{Hz}} \\
 Slew rate           & > 1.88      & 26       & \si{V/\micro s}   \\
 \bottomrule
\end{tabular}
}
\caption{Characteristics of the selected operational amplifier: OPA2834}
\label{tab:selected_op_amp}
\end{table}


\subsubsection*{AFE noise voltage}

The noise voltage from the AFE can be theoretically computed over an A-weighting curve of bandwidth $B_\te{A} = \SI{13.5}{kHz}$ as
\[
 V_\te{N,ADC,theor} = \sqrt{B_\te{A}} \, E_\te{N,ADC} = \SI{2.52}{mV}
\]
where $E_\te{N,ADC}$ depends on the voltage and current noise of the OPA2834.

As a validation of the amp op selection, Figure~\ref{fig:output_noise_op_amp_freq} describes the noise voltage spectral density at the amplification output. 
This noise is the combination of flicker (or $1/f$) noise and thermal (flat band) noise. Hence it depends on the frequency and is higher for frequencies below the $1/f$ corner frequency: \SI{150}{Hz} for the voltage noise and \SI{900}{Hz} for the current noise, as given in the op-amp datasheet. Since audio signals contain frequencies that are particularly low, the noise is sadly impinged by flicker noise. For a frequency of \SI{22}{Hz}, the noise reaches \SI{37}{\micro V/\sqrt{Hz}}.

Since the noise contribution from the microphone is not represented in the simulation, this simulated noise can be compared to the theoretical value of the AFE noise (\SI{2.52}{mV}). Due to the frequency dependence, one needs to integrate the noise power spectral density over the whole frequency range in order to obtain the output noise voltage:
\[
 V_\te{N,ADC,simu} = \sqrt{\int_{0}^{\infty} E_\te{N,ADC}(f)^2 \, \te{d}f} = \SI{2.37}{mV}.
\]
As expected, the result is very similar to the theoretical one, hence not impinging the previous conclusions for the choice of the best operational amplifier.

%This small contribution compared to the microphone noise makes the total voltage noise in the order of the ADC resolution (104\%), which still allows a low-noise digitization.

\begin{figure}[H]
    \centering
    \input{img/output_noise_freq.tex}
    \caption{Noise voltage spectral density from AFE at the amplification output (from \textsc{LTspice})}
    \label{fig:output_noise_op_amp_freq}
\end{figure}

\subsubsection*{Total noise voltage}

One can then compute the total noise voltage $V_\te{N,tot,theor}$ at the amplification output, resulting from the microphone noise and the AFE noise:
\[
 V_\te{N,tot,theor} = p_\te{IRN} \, R_2\,S_{\te{I,mic}} = \SI{11.2}{mV}.
\]


\subsubsection*{Op amp bias network}

Resistors $R_3$ and $R_4$ center the op-amp input and output at the midpoint between the power supplies to allow the widest possible output signal swing. Therefore $R_3 = R_4$ for $V_\te{B} = V_\te{CC} / 2$. The value of these resistors needs to be very high in order to limit the power supply current drawn by this voltage divider. However, the non-zero op-amp input bias current prevents the bias voltage $V_\te{B}$ to be exactly at $V_\te{CC} / 2$, and this variation worsens with the value of the bias resistors. A reasonable choice consists to set a maximum bias voltage variation of 1\%:
\[
 \Delta V_\te{B} = R_3 \, I_\te{b+} < 0.01 V_\te{B} \quad \Rightarrow \quad R_3 < 0.01 \frac{V_\te{CC}}{2I_\te{b+}} = \SI{179}{k\ohm}
\]
where $I_\te{b+} = \SI{70}{nA}$ for the selected op-amp. A final value of
\[
 R_3 = R_4 = \SI{150}{k\ohm}
\]
is finally chosen, which implies a current in the voltage divider of approximately
\[
 I_\te{B} = \frac{V_\te{CC}}{R_3 + R_4} = \SI{8.33}{\micro A}.
\]
This current is small (less than 5\%) compared to the microphone bias current, and is a good trade-off between the power consumption and the bias voltage stability.

Capacitor $C_3$ is included to filter thermal noise created by the resistors and any noise which may be present on the power supply. The corner frequency of the low-pass filter is formed by $R_3$, $R_4$ and $C_3$. It should be well below the operating frequency range in order to prevent noise from affecting the audio performance of the design. A corner frequency of $f_\te{B} = \SI{5}{Hz}$ is selected:
\[
 C_3 = \frac{1}{2 \pi \, f_\te{B} \, (R_3 \parallelsum R_4)} = \SI{424}{nF}.
\]

\subsubsection*{Summary}

Table~\ref{tab:selected_values_microphone} summarizes the theoretical values for the amplification circuit as well as the values actually put on the experimental device depending on the available components.

\begin{table}[H]
\centering
\begin{tabular}{lcc}
\toprule
             & \multicolumn{2}{c}{Value}                \\
             & Theoretical         & Real               \\ \midrule
 $R_1$       & \SI{2.38}{k\ohm}    & \SI{2.37}{k\ohm}   \\
 $R_2$       & \SI{3.81}{M\ohm}    & \SI{3.83}{M\ohm}   \\
 $R_3$       & \SI{150}{k\ohm}     & \SI{150}{k\ohm}    \\
 $R_4$       & \SI{150}{k\ohm}     & \SI{150}{k\ohm}    \\
 $C_1$       & \SI{3.34}{\micro F} & \SI{3.3}{\micro F} \\
 $C_2$       & \SI{2.09}{pF}       & \SI{2}{pF}         \\
 $C_3$       & \SI{424}{nF}        & \SI{470}{nF}       \\ \bottomrule
\end{tabular}
\caption{Final values for the amplification circuit}
\label{tab:selected_values_microphone}
\end{table}

Figure~\ref{fig:microphone_AC} presents the AC transfer function of the amplification circuit, which confirms a bandwidth ranging from \SI{20}{Hz} to \SI{20}{kHz}. The important phase variations (with additional poles) are due to the intrinsic behavior of the electret microphone.

\begin{figure}[H]
    \centering
    \input{img/microphone_AC.tex}
    \caption{AC transfer function of the amplification circuit (from \textsc{LTspice})}
    \label{fig:microphone_AC}
\end{figure}

As stated before, the classical trade-off between noise and power consumption was not worth considering in the microphone selection since the other microphones suffer from too high noise. However, if the constraint on the minimum detectable sound wave were relaxed, the choice of the microphone and operational amplifier would have to be optimized conjointly by computing the input-referred noise and power consumption of the whole sensing subsystem.


\chapter{Data processing and transceiver}

Data are processed in a microcontroller and received/transmitted in a transceiver. For this work, a CMWX1ZZABZ chip from Murata is used, which combines an STM32L072 microcontroller and an SX1276 transceiver. Its operation voltage range is \SI{2.2}{V} -- \SI{3.6}{V}.

\section{Microcontroller}

The STM32L072 is an ultra-low-power microcontroller incorporating an Arm Cortex-M0+ 32-bit RISC core operating at a 32 MHz frequency, embedded memories (192 Kbytes of Flash program memory, 6 Kbytes of data EEPROM and 20 Kbytes of RAM), a 12-bit ADC with hardware oversampling,\dots It operates from a \SI{1.8}{V} to \SI{3.6}{V} power supply~\cite{STM32L072xx}.

\subsection*{ADC characteristics}

A 12-bit analog-to-digital converter (ADC) has been used to digitize two signals: the analog microphone voltage and supercap voltage. The resolution of an $N$-bit ADC is given by $V_\te{DD}/2^N$ where $V_\te{DD}$ is the supply voltage. One might be interested to improve the ADC resolution up to 14 bits via diverse techniques (such as SAR, etc). This would allow the reading of a smaller input sound pressure (\SI{12}{dB} below) and make possible to process a sound pressure of \SI{4}{dB_{SPL}} (increasing the distance between the sensor and the source). However, the signal quality would not benefit from this increased ADC resolution because the microphone self-noise is still \SI{14}{dB_{SPL}}.

A typical code would alternate between an energy-intensive run mode (to sample sound) and a low-power sleep mode. The duty cycle between these modes will be determined in the section characterizing the power consumption (Section~\ref{section:power_consumption}).

\subsection*{Status of supercapacitor charge}

In order to know the status of the supercapacitor charge and adapt the MCU code to a possible overdischarge, the ADC reads the supercap voltage. Since this voltage is higher than the ADC supply voltage, a voltage divider is required. The supercap voltage is thus divided by two with two resistors $R_\te{SC}$ of the same value, which has to be determined according to the impedance recommendations at the ADC input. Provided in the datasheet, the maximum input impedance for an error below 1/4 of LSB is given by (derived from the charge equation of the sample-and-hold capacitor)
\[
 R_\te{AIN,max} = \frac{T_\te{S}}{f_\te{ADC}\,C_\te{ADC}\,\ln(2^{N+2})} - R_\te{ADC} = \SI{257}{k\ohm}
\]
where $T_\te{S} = 160.5$ is the number of cycles per sample, $f_\te{ADC} = \SI{8}{MHz}$ is the ADC clock frequency, $C_\te{ADC} = \SI{8}{pF}$ is the internal sample-and-hold capacitor, $N=12$ is the number of resolution bits and $R_\te{ADC} = \SI{1}{k\ohm}$ is the sampling switch resistance. To increase $R_\te{AIN,max}$ and thus reduce power consumption, parameters such as $T_\te{S}$ and $f_\te{ADC}$ are pushed towards a low sampling frequency (the delay being not important since the supercapacitor undergoes small variations).

Because $R_\te{AIN,max}$ corresponds to $R_\te{SC}/2$, one selects a resistance of $R_\te{SC} = \SI{475}{k\ohm}$. This value produces a negligible current consumption of
\[
 I_\te{SC,ADC} = \frac{V_\te{SC}}{2R_\te{SC}} = \SI{4.7}{\micro A}
\]
when the supercapacitor is fully charged at \SI{4.5}{V}.

Finally, the ADC input leakage current provided in the datasheet is maximum $I_\te{in,ADC} = \SI{50}{nA}$. The ADC voltage due to the non-zero input current is thus $(V_\te{SC} - R_\te{SC}\,I_\te{in,ADC})/2$ instead of $V_\te{SC}/2$, leading to a maximum relative error of
\[
 E_\te{rel} = \frac{R_\te{SC}\,I_\te{in,ADC}}{V_\te{SC}} = \SI{0.85}{\%}
\]
when the supercapacitor is fully discharged (\SI{2.8}{V}). This error is negligible.


\section{Transceiver}

The SX1276 transceiver features the LoRa long-range modem that provides ultra-long range spread spectrum communication~\cite{SX1276}. LoRa has been increasingly used in the IoT domain thanks to their compromise between range, interference immunity and energy consumption~\cite{SINHA201714}. The transceiver chip is connected to an external ISM (industrial, scientific and medical purposes) antenna in the range \SI{790}{MHz} -- \SI{960}{MHz}.

The receiver is used for over-the-air (OTA) updates and thus implies that the MCU has reconfiguration capabilities to keep up with application, security and communication protocol updates. During such updates, the challenge is the instantaneous power consumption when the wireless radio is in receive mode combined and the microcontroller is reprogramming its internal Flash memory (recall that the maximum current consumption at the PMU output is \SI{80}{mA} and that the energy storage is very limited). To lower this peak power, a smart decomposition of the firmware packets will be required.

The transmitter is used to send data to a gateway, mainly information about the analyzed input sound pressure and hence bird species. All data are handled in the RAM memory of the MCU, but important data that need to be transmitted are stored in the FLASH memory in order to prevent them from being erased after an unexpected shutdown.

The radio-frequency communication for this smart sensor, including power consumption and security in LoRaWAN networks, has been carefully discussed and optimized in a concurrent master thesis~\cite{Hess2020}.


\chapter{Power supply}

In this chapter, the total current consumption is evaluated. The solar cells and supercapacitor are then sized accordingly.

\section{Power consumption}
\label{section:power_consumption}

The power consumption will be computed separately for each block. Since the voltage regulator inside the PMU is an LDO, the current drawn in the circuit is the same as the current drawn in the supercapacitor. For each subsystem, it thus makes sense to provide the current consumption $I$ instead of the power consumption since the latter is higher from the supercap point of view ($V_\te{SC}\,I$) than from the subsystem point of view ($V_\te{DD}\,I$).


\subsection*{Sensing}

As seen in Figure~\ref{fig:circuit_AFE}, the current consumption from the sensing subsystem is composed of
\begin{itemize}
 \item the current through the microphone branch (with $R_1$): $I_{\te{mic}} = \SI{358}{\micro A}$ (see Table~\ref{tab:op_point_mic}),
 \item the op-amp quiescent current: $I_\te{Q} = \SI{170}{\micro A}$,
 \item and the current through the voltage divider with $R_3$ and $R_4$ to bias the op-amp: $I_\te{B} = \SI{8.33}{\micro A}$.
\end{itemize}

This leads to a current consumption of $I_\te{sensing} = \SI{536}{\micro A}$.

\subsection*{Power Management}

The current consumption of the power management subsystem is composed of
\begin{itemize}
 \item the leakage current of the supercapacitor: typically $I_\te{Q,SC} = \SI{500}{\micro A}$ (will be refined in Section~\ref{supercap_sizing}),
 \item the voltage divider to read the supercap voltage at the ADC input $I_\te{SC,ADC} = \SI{4.7}{\micro A}$,
 \item and the PMU quiescent current: $I_\te{Q,PMU} = \SI{0.6}{\micro A}$.
\end{itemize}

This leads to a current consumption of $I_\te{power} = \SI{505}{\micro A}$.


\subsection*{Data processing and transceiver}

%The power supply $VDD_{STM32}$ required for the STM32 being between \SI{1.8}{V} and \SI{3.6}{V}, one has to choose a trade-off between a small power consumption (small voltage) and a high signal resolution from the microphone (high voltage). A voltage of $VDD_{STM32} = \SI{3}{V}$ has finally been selected.

For this part, it is possible to adapt the code in the microcontroller to match the best capabilities of the system.
In view of the power consumption from the previous parts and the typical harvested power from solar cells, one will aim to keep the MCU/TX/RX consumption below \SI{2}{mA}. 

\subsubsection*{First case without transceiver}

As a first approximation, a run mode that only processes data is considered (that is, without transmission or reception). A typical scheme for this application is to alternate a run mode and standby mode.

Addressing a simple scheme allows using a simulation tool (Wisebatt) in order to estimate the power consumption. As seen in Figure~\ref{fig:wisebatt1}, Wisebatt estimates the run mode at \SI{2.74}{mA} and the standby mode at \SI{3.64}{\micro A}. With a duty cycle of $1/3$, one obtains an average current consumption of
\[
 i_\te{avg} = \frac{1}{3} \, \SI{2.74}{mA} + \frac{2}{3} \, \SI{3.64}{\micro A} = \SI{0.913}{mA}.
\]

By assuming that it takes \SI{50}{ms} to sample and process the data, it leads to a cycle duration of \SI{150}{ms}. However, the simulation tool misses the FFT operation that is achieved inside the microcontroller, which significantly reduces the current consumption. To refine this poor model, experimental measurements of the current consumption have been achieved (see Figure~\ref{fig:consumption_fft}). With a duty cycle of $1/3$, they show an average current consumption of \SI{3.88}{mA} since the run mode consumes \SI{10.1}{mA}. An MCU current consumption of \SI{3.88}{mA} will be kept as reference for designing further components, it allows keeping a precise track of the input sound wave (one third of the time at high run/sleep cycle frequency) with sufficiently low power consumption. The increase in current consumption before each sleep mode is due to the microcontroller which saves the data by writing in its registers.

\begin{figure}[H]
\begin{subfigure}{.49\textwidth}
  \centering
    \input{img/wisebatt1.tex}
    \caption{Wisebatt simulation}
    \label{fig:wisebatt1}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
  \centering
  \input{img/current_consumption_FFT.tex}
  \caption{Experimental results}
  \label{fig:consumption_fft}
\end{subfigure}
\caption{Current consumption of the CMWX1ZZABZ without TX/RX}
\end{figure}


\subsubsection*{Second case with transceiver}

First, one considers the power consumption related to the transceiver part. Figure~\ref{fig:current_consumption_MCU_RF_lorawan_TX} shows the current consumption for sending one packet of 51 bytes, with a peak current of \SI{49.5}{mA} for \SI{130}{ms}. One verifies that this peak current never exceeds the maximum output current of \SI{80}{mA} from the PMU (see Table~\ref{tab:AEM10941}).

\begin{figure}[H]
    \centering
    \input{img/current_consumption_MCU_RF_lorawan_TX.tex}
    \caption{Current consumption for sending one packet of 51 bytes}
    \label{fig:current_consumption_MCU_RF_lorawan_TX}
\end{figure}

Second, data reception is characterized through an over-the-air firmware update (FUOTA). Figures~\ref{fig:current_consumption_MCU_RF_FUOTA} show the current consumption of a typical FUOTA. The first figure corresponds to the packets reception (in Class-C\footnote{Class-C endpoints use the most power but have the shortest latency.}) with a constant current of \SI{12}{mA}. Only a part of the consumption is shown, it is a periodic profile during \SI{259}{s}.

The second figure is related to the packets processing of the FUOTA, composed of three steps: hash computation of the received fragment to ensure its validity (i.e. no data corruption during the transmission), computation of the reverse delta (i.e. the firmware that has changed), and computation of the new firmware image based on the previous image and the delta. Receiving and processing the packets consume \SI{14.1}{mA} on average for \SI{301}{s}, that is an energy of \SI{10.6}{J}. Since these updates appear sporadically, they are achieved when the device does not process audio data (i.e. during the night) and are thus not taken into account in the power budget hereafter.

\begin{figure}[H]
\begin{subfigure}{.49\textwidth}
  \centering
  \input{img/current_consumption_MCU_RF_FUOTA.tex}
  \caption{Packets reception}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
  \centering
  \input{img/current_consumption_MCU_RF_FUOTA_processing.tex} 
  \caption{Packets processing}
\end{subfigure}
\caption{Current consumption for a FUOTA}
\label{fig:current_consumption_MCU_RF_FUOTA}
\end{figure}


\subsection*{Total power consumption}

Table~\ref{tab:power_consumption_theor} summarizes the power budget for the whole system. As expected, the most energy-intensive part is the microcontroller and radio-frequency subsystem.


\begin{table}[H]
\centering
\begin{tabular}{lc}
\toprule
                     & Current [\si{mA}] \\ \midrule
 Data processing     & 3.88              \\
 Power management    & 0.50              \\
 Sensing             & 0.54              \\ \midrule
 Total               & 4.92              \\ \bottomrule
\end{tabular}
\caption{Description of the theoretical power consumption in the system}
\label{tab:power_consumption_theor}
\end{table}

Depending on the supercapacitor voltage, the total power consumption finally varies linearly between \SI{13.8}{mW} (at \SI{2.8}{V}) and \SI{22.1}{mW} (at \SI{4.5}{V}) according to $P_\te{tot} = V_\te{SC} \, I_\te{tot}$.


\section{Solar cells}
\label{section:solar_cells}

Solar cells are electrical devices that convert the energy of light into electricity by the photovoltaic effect. The current generated by such cells is decreasing with the voltage. It leads to a maximum of the harvested power (see Figure~\ref{fig:solar_IV}), which is called the MPP (for Maximum Power Point).

The main figures of merit for solar cells are thus the current and voltage at the maximum power point, as well as the surface area since the goal is to maximize the harvested power per unit area and thus minimize the area on the PCB. It is worth noting that the current and power are provided at one sun (\SI{1}{mW/mm^2}), and the power is the electric power generated by the solar cells.

\begin{figure}[H]
    \centering
    \input{img/solar_IV.tex}
    \caption{IV and PV curves of a typical solar cell: SM141K06L}
    \label{fig:solar_IV}
\end{figure}

%\textcolor{green}{Add measurement of this IV curve in lab + lux on cell? experimental validation of given power} 

A great advantage of solar cells is their ability to combine them easily in series (doubling the voltage) or in parallel (doubling the current), provided that the total voltage does not exceed the voltage limit of \SI{5}{V} for the Power Management Unit. Based on the comparison depicted in Table~\ref{tab:solar_comparison} between three cells of different sizes, the SM141K06L model is selected for its high power per unit area of \SI{0.1905}{mW/mm^2}. Alternatively, this electric power per unit area can be validated by computing the product between the sun intensity and the efficiency of the solar cells (approximated to 25\% in the datasheet compared to 19.05\% computed here).

\begin{table}[H]
\centering
\scalebox{0.9}{
\begin{tabular}{lccc}
\toprule
                                   & KXOB25-14X1F & SM141K06L    & SLMD481H08L  \\ \midrule
Current [mA]                       & 55           & 55.1          & 178          \\
MPP Voltage [V]                        & 0.56         & 3.35         & 4            \\
Power [mW]                         & 30.7         & 184          & 714          \\
Surface [mm x mm]               & \SI{23x8}{}  & \SI{42x23}{} & \SI{89x55}{} \\
Power per unit area [\si{mW/mm^2}] & 0.1668       & 0.1905       & 0.1459       \\ \bottomrule
\end{tabular}
}
\caption{Comparison of several solar cells}
\label{tab:solar_comparison}
\end{table}

This model is a set of six single solar cells in series, raising the MPP voltage from \SI{0.56}{V} to \SI{3.35}{V}. Figure~\ref{fig:solar_IV} provides the IV/PV curves for one of the single cells.

Now that the cell with the best power par unit area is selected, the following of this section is dedicated to the computation of the required number of such cells in order to daily provide enough energy to the whole circuit via the supercapacitor. For this purpose, a model of the harvested energy from the sun is required.


\subsection*{Illuminance}

The luminosity profile over a whole day needs to be measured in order to estimate the harvested solar energy. For this purpose, a light meter (model \textit{testo 540}) has been used\footnote{Smartphone applications such as \textit{Physics Toolbox} also exist but provide imprecise results.}. It is a precise light sensor but the measurement is only shown on a screen, preventing the user to continuously record the data over a whole day. Figure \ref{fig:daily_luminosity} thus presents the measurements made at regular intervals in a shady place of Louvain-la-Neuve (to replicate a place similar to a forest). The weather was cloudy, which gives an illuminance very near the worst-case scenario and hence allows the solar cells to be selected based on the darkest days.

\begin{figure}[H]
    \centering
    \input{img/daily_luminosity.tex}
    \caption{Daily luminosity (Louvain-la-Neuve, from March 3 to March 6, 2020)}
    \label{fig:daily_luminosity}
\end{figure}

These data are extremely variable, mainly due to the motion of clouds. A polynomial regression of second order $L(t)$ allows better representing the trend over a day (in dashed blue).

\iffalse
The mean luminosity $<L>_{\te{exp}}$ over a full day (24 hours) is computed from the integral of the approximated curve $L(t)$:
\[
 <L>_{\te{exp}} = \frac{\int_0^{24} L(t)\, \te{d}t}{24} = \SI{806}{lm}.
\]
\[
 <L>_{\te{min}} = \frac{8}{11} <L>_{\te{exp}} = \SI{586}{lm}.
\]
\fi

The data have been taken during days with 11 hours of sunlight (averaged between March 3 and March 6, 2020), while the sensor has to work under smaller periods of sunlight (down to eight hours in the winter~\cite{sunlight}). Assuming that the daily harvested energy is proportional to the duration of sunlight, the following computations will be done accordingly by horizontally shrinking the graph by $8/11$ (in red).

More rigorously, one should also shrink the graph vertically since the sunlight is weaker in winter. Indeed, the same incoming sunlight is distributed over a larger area at higher latitudes (see Figure~\ref{fig:sunlight_png}). However, scaling the device to the very worst scenario (less than 10\% of the year) is not advisable since it would imply significant overscaling (of the solar cells and supercapacitor). Consequently, the microcontroller algorithms will be less resource-intensive for winter in order to match the specifications of energy harvesting and storage, which is coherent with the fact that fewer birds are active during this period.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{sunlight.png}
    \caption[Sunlight towards Earth at the equinox]{Sunlight towards Earth at the equinox~\cite{ackerman2007meteorology}}
    \label{fig:sunlight_png}
\end{figure}


\subsection*{Power conversion}

From this solar energy, solar cells generate a current which is proportional to the illuminance. Most of the solar cell datasheets provide an IV curve at a fixed illuminance of $\SI{1}{sun} = \SI{1e3}{W/m^2}$. Since $\SI{1}{lux} = \SI{0.0079}{W/m^2}$ for the solar spectrum, the harvested current $I_\te{cell}(t)$ from one solar cell is given by
\[
  \frac{I_\te{cell}(t)}{L_\te{sun}(t)} = \frac{I_{1\te{sun}}}{1} \quad \Rightarrow \quad I_\te{cell}(t) = I_{1\te{sun}}\,L_\te{sun}(t) = \SI{0.0079e-3}{}\,I_{1\te{sun}}\,L(t) \quad \si{[A]}
\]
where $L(t)$ and $L_{\te{sun}}(t)$ are the instantaneous illuminance (resp. expressed in lux and sun) and $I_{1\te{sun}}$ is the current generated at the MPP under \SI{1}{sun} (provided in the datasheet).

\begin{figure}[H]
    \centering
    \input{img/P_cell.tex}
    \caption{Daily view of the harvested power with SM141K06L solar cells}
    \label{fig:P_cell}
\end{figure}

For the selected solar cells, Figure~\ref{fig:P_cell} gives the harvested power throughout the day\footnote{As mentioned previously, notice that the graph is shrunk such that the day benefits from sunlight for only eight hours.}: 
\[
 P_\te{cell}(t) = I_\te{cell}(t)\,V_\te{cell} = \SI{0.0079e-3}{}\,I_{1\te{sun}}\,V_\te{cell}\,L(t) \quad \si{[W]}
\]
with $V_\te{cell} = \SI{3.35}{V}$ and $I_{1\te{sun}} = \SI{55.1}{mA}$.

\subsection*{Charge of the supercapacitor}

The next paragraphs will discuss how the power management unit transforms the input and output powers with two different voltage regulators.

The input power from the solar cells is independent from the supercapacitor voltage. Indeed, the voltage at the maximum power point is converted to the current battery voltage through a boost converter with efficiency $\eta_\te{boost,PMU}=\SI{92}{\%}$ derived in Section~\ref{section:PMU}. The input power is thus constant according to
\[
 P_\te{in,solar}(t) = n_\te{¢ell} \, I_\te{cell}(t)\,V_\te{cell} = \frac{1}{\eta_\te{boost,PMU}} I_\te{in,SC}(t) \, V_\te{SC}(t) \quad [\si{W}]
\]
where $n_\te{¢ell}$ is the number of solar cells required for the device, $I_\te{in,SC}(t)$ is the input current through the supercapacitor and $V_\te{SC}(t)$ is the voltage across the supercapacitor.

Regarding the energy consumption, the PMU converts the supercapacitor voltage to a constant voltage $V_\te{CC}= \SI{2.5}{V}$ via a linear dropout regulator (LDO). Neglecting the quiescent current, LDOs keep the same current while the voltage is reduced. The output power is thus reduced, this is why it is important to maintain a small dropout (voltage difference between the input and output). Hence, the output current is independent from the supercapacitor voltage and not the output power since the ratio of output power fed to the circuit over the output power actually retrieved from the supercapacitor is given by
\[
 \frac{P_\te{out,circuit}}{P_\te{out,SC}} = \frac{I_\te{out} \, V_\te{CC}}{I_\te{out} \, V_\te{SC}} = \frac{V_\te{CC}}{V_\te{SC}}.
\]

\begin{figure}[H]
    \centering
    \input{img/P_in_I_out.tex}
    \caption{Input power and output current for six solar cells and a typical profile of cyclic consumption}
    \label{fig:P_in_I_out}
\end{figure}

In the end, Figure~\ref{fig:P_in_I_out} depicts the input and output variables which are independent from the supercapacitor voltage. These are thus the only quantities which can be plotted without measuring the supercapacitor voltage. The input power is given with six solar cells. The output current has the cyclic profile from the MCU analyzed in Figure~\ref{fig:consumption_fft} on which a current consumption of \SI{1.04}{mA} has been added for the remaining of the system (as computed in Table~\ref{tab:power_consumption_theor}). Since the following components are designed for the worst case scenario, the input power is not sufficient to maintain the microcontroller in operation at night. It is thus limited to a typical time window of bird activity (from \SI{7}{h} to \SI{17}{h}). When days have longer sunlight time, the device will receive more energy and thus either support longer processing periods (up to \SI{24}{h} per day) or allow more frequent radio-frequency communication (for both data transmission and firmware update).

\subsubsection*{First-order non-linear differential equation for the supercapacitor voltage}

Having two different quantities (the power and the current) conserved when the supercapacitor voltage changes leads to slightly more complicated computations of the supercapacitor voltage over one day\footnote{Having the input and output currents independent from the supercapacitor voltage would lead to the simple equation: $$V_\te{SC}(t) = V_\te{SC}(t_0) + \frac{1}{C} \int_{t_0}^t (I_\te{in,SC}(t) - I_\te{out,SC}(t))\, \te{d}t.$$

Likewise, having the input and output powers independent from the supercapacitor voltage would lead to the equation: $$E_\te{SC}(t) = E_\te{SC}(t_0) + \int_{t_0}^t \big(P_\te{in,SC}(t) - P_\te{out,SC}(t)\big)\, \te{d}t$$ where $E_\te{SC} = C\, V_\te{SC}^2 / 2$ to obtain the voltage.}. The rigorous approach consists to write the equation for the charge of a capacitor:
\begin{align*}
 \frac{\te{d}V_\te{SC}}{\te{d}t} &= \frac{1}{C} \left( I_\te{in,SC}(t) - I_\te{out,SC}(t) \right) \\
 &= \frac{1}{C} \left( \eta_\te{boost,PMU} \, \frac{P_\te{in,solar}(t)}{V_\te{SC}(t)} - I_\te{out,SC}(t) \right) \\
 &= \frac{1}{C} \left( \eta_\te{boost,PMU} \, n_\te{¢ell} \, I_\te{cell}(t) \frac{V_\te{cell}}{V_\te{SC}(t)} - I_\te{out,SC}(t) \right)
\end{align*}
which is a non-linear first-order differential equation for the variable $V_\te{SC}(t)$. Nonetheless, one can notice that the equation is written as
\[
 \frac{\te{d}V_\te{SC}}{\te{d}t} = f(V_\te{SC}, t)
\]
where $f(V_\te{SC}, t)$ is a function of $V_\te{SC}$ and $t$. It can thus be easily solved numerically for example via the forward Euler method: 
\begin{align*}
 V_\te{SC}(t + \te{d}t) &= V_\te{SC}(t) + \te{d}t \, f(V_\te{SC}(t), t) \\
 &= V_\te{SC}(t) + \frac{\te{d}t}{C} \left( \eta_\te{boost,PMU} \, n_\te{¢ell} \, I_\te{cell}(t) \frac{V_\te{cell}}{V_\te{SC}(t)} - I_\te{out,SC}(t) \right).
\end{align*}
starting with $V_\te{SC}(t_0) = V_\te{CC} + 0.3 = \SI{2.8}{V}$ which is the minimum voltage across the supercapacitor due to a minimum dropout of \SI{0.3}{V}. The value $t_0$ is thus the time for which the supercapacitor begins to charge, in other words, when the input power starts to exceed the output power: $\eta_\te{boost,PMU} \, n_\te{¢ell} \, I_\te{cell}(t_0)\,V_\te{cell} = I_\te{out}(t_0) \, V_\te{SC}(t_0)$.

Finally, Figure~\ref{fig:Supercap_voltage} depicts the numerical solution of the supercapacitor voltage throughout the day for three different numbers of cells. At night, the voltage is linearly decreasing due to the stable current consumption of the sensing and power subsystems. When the microcontroller is activated in the morning, a wavy and amplified diminution appears until the sun provides enough energy to recharge the supercap voltage in the middle of the day. One can see the small ripple due to the sharp transitions of the consumed current when the microcontroller alternates between run and sleep mode.

The number of cells is chosen to come back to the minimum voltage after one day (close the loop). If there are not enough cells, the voltage will fall below this minimal voltage and the circuit will be shut down during a few hours. If there are too many cells, the voltage will be higher day after day. The optimal number of cells is thus 6, as the curve in red (Figure~\ref{fig:Supercap_voltage}) is perfectly suited for the current consumption.

\begin{figure}[H]
    \centering
    \input{img/Supercap_voltage.tex}
    \caption{Voltage across the supercapacitor for three numbers of cells}
    \label{fig:Supercap_voltage}
\end{figure}

\section{Supercapacitor sizing}
\label{supercap_sizing}

Although the size of the supercapacitor appears inside the charge equation in the previous computations, its impact is small compared to the impact of the number of solar cells. This small impact comes from the charge equation stating that $C$ changes the slope of $V_\te{SC}(t)$ (applying a vertical stretching of the curve). This increase in supercap voltage induces a higher dropout in the output voltage conversion, decreasing the efficiency of the regulation. It is then required to size the supercapacitor such that the maximum voltage set by the PMU (\SI{4.5}{V}) is never exceeded.

Figure~\ref{fig:Supercap_voltage_C} provides the simulation results for three different capacitances. One can first see that the maximal voltage is reached for $C = \SI{50}{F}$ but it fails to be active during one day since the voltage drops below the \SI{2.8}{V}, the minimum capacitance for this work is thus between \SI{50}{F} and \SI{100}{F}.

\begin{figure}[H]
    \centering
    \input{img/Supercap_voltage_C.tex}
    \caption{Voltage across the supercapacitor for three different capacitances}
    \label{fig:Supercap_voltage_C}
\end{figure}

\iffalse
\[
 \frac{C\,V_\te{batt}^2(t)}{2} = \frac{C\,V_\te{min}^2}{2} + E_\te{supp}(t) \quad \Rightarrow \quad V_\te{batt}(t) = \sqrt{V_\te{min}^2 + \frac{2\,E_\te{supp}(t)}{C}} \quad \si{[V]}
\]
\fi

A common (and possibly the only one in Europe) manufacturer for such high capacitances is Vishay, it has a broad range of supercapacitor from \SI{4}{F} to \SI{90}{F} and from \SI{1.8}{V} to \SI{8.4}{V}. The minimal voltage matching the specifications of this work is \SI{4.2}{V} since the operating voltage range must lie inside the PMU range (\SI{2.8}{V} to \SI{4.5}{V}). Table~\ref{tab:SC_comparison} provides a comparison between the two best solutions: a supercapacitor of \SI{90}{F} and a set of four supercapacitors of \SI{15}{F}.

\begin{table}[H]
\centering
\begin{tabular}{lcc}
\toprule
                                 & MAL219690101E3     & MAL219691213E3 ($\times 4$)  \\ \midrule
 Capacitance [F]                 & 90                 & $15 \times 4 = 60$           \\
 Rated voltage [V]               & 4.2                & 4.2                          \\ 
 Leakage current [\si{\micro A}] & 500                & $120 \times 4 = 480$         \\ 
 Volume [mm x mm x mm]           & \SI{35x26.5x15}{}  & $(\SI{14x10x12}{}) \times 4$ \\
 Cost [\$]                       & 19.16              & $8.93 \times 4 = 35.72$      \\ \bottomrule
\end{tabular}
\caption{Comparison of several supercapacitors}
\label{tab:SC_comparison}
\end{table}

As shown in Figure~\ref{fig:hvc}, these typical supercapacitors present a linear discharge under constant current only locally in a range between \SI{4.4}{V} and \SI{5.4}{V} for a \SI{5.6}{V} supercapacitor. Below \SI{4.4}{V}, the supercap voltage drops very fast and falls below its operation voltage. Selecting a capacitance of \SI{5.6}{V} would thus not allow the PMU, limited to \SI{4.5}{V}, to charge the supercap in its operating voltage range. Even if it is below the \SI{4.5}{V} of the PMU, a \SI{4.2}{V} supercapacitor is thus required to work in the range where most of the energy is actually stored (between \SI{3.1}{V} and \SI{4}{V}). One can finally notice that the leakage current is not negligible, making this type of supercap unsuited for ultra-low-power devices.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.6\textwidth]{196hvc-12.pdf}
    \caption[Constant current charge and discharge: \SI{90}{F} / \SI{5.6}{V}]{Constant current charge and discharge: \SI{90}{F} / \SI{5.6}{V}~\cite{Vishay}}
    \label{fig:hvc}
\end{figure}

The all-in-one supercapacitor of \SI{90}{F} is selected because its capacitance is 50\% higher and its cost is lower with not much additional leakage current and space on the board. It thus allows more power consumption (namely processing in the microcontroller) during periods of higher sunlight without saturating the supercapacitor voltage. Based on Figure~\ref{fig:Supercap_voltage_C}, it is expected that the voltage follows the red curve and thus reaches a peak at \SI{3.8}{V}.

Figure~\ref{fig:Supercap_voltage_voltage_split} gives the voltage split for a \SI{90}{F} / \SI{4.2}{V} supercap, which perfectly fits into the PMU and supply specifications.

\begin{figure}[H]
\centering
\begin{tikzpicture}[scale=1.5]
% Axes:
\draw[->](0,2)--(0,5);
\draw[](-0.1,4.5)--(0,4.5)node[left,font=\small]{\SI{4.5}{V} \, };
\draw[](-0.1,4.2)--(0,4.2)node[left,font=\small]{\SI{4.2}{V} \, };
\draw[](-0.1,2.8)--(0,2.8)node[left,font=\small]{\SI{2.8}{V} \, };
\draw[](-0.1,2.5)--(0,2.5)node[left,font=\small]{\SI{2.5}{V} \, };
\draw[fill=blue!30] (0.1,2.8) rectangle ++(2.9,1.4);
\draw[](0,4.5)--(3,4.5);
\draw[](0,2.5)--(3,2.5);
\node () [] at (1.5,2.63) {PMU voltage drop};
\node () [] at (4.5,2.5) {Supply voltage};
\node () [] at (4.5,3.5) {Active range};
\node () [] at (4.5,4.5) {PMU max voltage};
\end{tikzpicture}
\caption{Voltage split for a \SI{90}{F} / \SI{4.2}{V} supercap coupled with the AEM10941}
\label{fig:Supercap_voltage_voltage_split}
\end{figure}


\chapter{Final model}

\section{Description}

Figure~\ref{fig:electronics_diagram} presents the electronics diagram of the final model.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{electronics_diagram.pdf}
    \caption{Electronics diagram of the final model}
    \label{fig:electronics_diagram}
\end{figure}

The final model is a stack of two boards: a board for data processing and transmission on top of a board for sensing and power management.

\section{Design}

The design of the final model is given in Figure~\ref{fig:final_model_picture}. One can see the six solar cells, the supercapacitor in blue, the microphone in light gray, as well as five headers for current/voltage measurements. The components are placed such that the solar cells receive the maximum of sunlight.

\begin{figure}[H]
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.9\linewidth]{real_PCB.png}  
  \caption{Without MCU/TX board}
\end{subfigure}
\begin{subfigure}{.48\textwidth}
  \centering
  \includegraphics[width=.9\linewidth]{real_PCB_with_MCU.png}  
  \caption{With MCU/TX board}
\end{subfigure}
\caption{Pictures of the final model}
\label{fig:final_model_picture}
\end{figure}

\subsection*{Prototyping}

The PCB schematic and layout are available in Appendix~\ref{appendix:schematic}.

\section{Validation}

This section describes the experimental results obtained with the real device.

\subsection*{Power consumption}

The current consumption measured in the different parts is given in Table~\ref{tab:val_current_cons}. These measurements have been made with a Source Measure Unit: Keithley 2400~\cite{Keithley}.

\begin{table}[H]
\centering
\begin{tabular}{lc}
\toprule
                     & Current [\si{\micro A}]  \\ \midrule
 Supercap leakage    & 95                       \\
 Sensing             & 904                     \\
 PMU                 & 50                       \\
 MCU                 & 470                      \\ \midrule
 Total               & 1645                     \\ \bottomrule
\end{tabular}
\caption{Description of the current consumption in the system}
\label{tab:val_current_cons}
\end{table}

When the supercapacitor is fully disconnected, a leakage current of \SI{95}{\micro A} is noticed, which is indeed below the maximum value of \SI{500}{\micro A} in the datasheet.

In the AFE, the microphone consumes \SI{380}{\micro A}. The op-amp consumes \SI{524}{\micro A}, which is more than expected since it has two channels. One should have chosen an op-amp with only one channel.

As given in the datasheet, the PMU quiescent current is \SI{50}{\micro A}.

The current consumption for a basic code in the MCU (FFT operations without RF and  duty cycle run/deepsleep mode of 10\%) is \SI{470}{\micro A}, corresponding to a run mode with \SI{4.7}{mA}.

\subsection*{Solar cells}

Table~\ref{tab:val_current_solar_sel} compares the harvested power from the solar cells in function of the MMP ratio under a fixed interior lighting. The voltage is fixed by the SMU while it measures the current. The highest power is achieved at 70\% of the open-circuit voltage (\SI{4.15}{V}), which is selected in hardware via a header connected to the PMU. For low supercap voltage (below \SI{3.3}{V}), this \SI{2.9}{V} MPPT voltage will not lead to the best PMU efficiency since it exceeds the \SI{2.4}{V} derived in Section~\ref{section:PMU}, but the gain in solar power at this MPP compensates for the loss of efficiency.

\begin{table}[H]
\centering
\begin{tabular}{lccc}
\toprule
  MPPT ratio & Voltage [V] & Current [mA] & Power [mW]  \\ \midrule
 70\%        & 2.9         & 20.2         & 58.6        \\
 75\%        & 3.11        & 17.9         & 55.7        \\
 85\%        & 3.53        & 11.1         & 39.1        \\
 90\%        & 3.73        & 3.5          & 13.1        \\ \bottomrule
\end{tabular}
\caption{Harvested power from the solar cells in function of the MMP ratio}
\label{tab:val_current_solar_sel}
\end{table}


Table~\ref{tab:val_current_harvested} gives the harvested current under different lighting from the solar cells at the MMP voltage (\SI{2.9}{V}). Since the data were taken at noon, they show more harvesting energy than for the theoretical analysis (see Figure~\ref{fig:daily_luminosity}).

\begin{table}[H]
\centering
\begin{tabular}{lc}
\toprule
                     & Current [\si{mA}]  \\ \midrule
 In the shade        & 30                 \\
 Cloudy              & 50                 \\
 Sunny               & 150                \\ \bottomrule
\end{tabular}
\caption{Harvested current under different lighting from the solar cells at the MMP voltage}
\label{tab:val_current_harvested}
\end{table}

\subsection*{Supercapacitor}

Figure~\ref{fig:discharge_supercap_exp} provides the supercapacitor discharge under a constant current of \SI{500}{mA} (to compare with Figure~\ref{fig:hvc}) after being charged to its maximum voltage (\SI{4.2}{V}) and kept at this voltage for 30 minutes (as recommended in the datasheet). It can be noted that the voltage is around \SI{3.1}{V} for the most important part of the operation, which is beneficial since the LDO in the PMU has a low-dropout in this case (and thus a good efficiency). Additionally, the supercapacitor is not in operation under \SI{2.5}{V}, which proves that the best type of DC-DC converter for this application is an LDO (and not a Buck-Boost converter which would allow stepping up the voltage as well). The total energy stored in this \SI{90}{F}/\SI{4.2}{V} supercapacitor is computed as
\[
 E_\te{SC} = \int_0^\infty P_\te{SC}(t) \, \te{d} t = I_\te{discharge} \int_0^\infty V_\te{SC}(t) \, \te{d} t = \SI{851.6}{J}.
\]

\begin{figure}[H]
    \centering
    \input{img/Discharge_supercap_exp.tex}
    \caption{Supercapacitor discharge under a constant current of \SI{500}{mA}}
    \label{fig:discharge_supercap_exp}
\end{figure}


\subsection*{Sound analysis}

\subsubsection*{Pure sine wave}

To validate the sensing subsystem, a first test is achieved with a pure sine wave at \SI{1}{kHz} generated from a laptop speaker. Figure~\ref{fig:sine_sound} presents the results in the time and frequency domains, this sound is fully detected by the microcontroller. The voltage decrease is probably due to the ADC discharging the node by drawing some current when it samples the signal.

\begin{figure}[H]
\begin{subfigure}{.5\textwidth}
  \centering
  \input{img/sine_temp.tex}
  \caption{In the temporal domain}
\end{subfigure}
\begin{subfigure}{.48\textwidth}
  \centering
  \input{img/sine_freq.tex}
  \caption{In the frequency domain}
\end{subfigure}
\caption{Analysis of a pure sine wave at \SI{1}{kHz}}
\label{fig:sine_sound}
\end{figure}


\subsection*{Noise}

Figure~\ref{fig:noise_sound} shows the digitized signal under a quiet environment in order to determine the intrinsic noise of the sensing system. The RMS noise value, in terms of LSBs, is given by
\[
 E_\te{RMS} = \sqrt{\frac{1}{N}\sum_n{\left(x[n]-\te{E}[x]\right)^2}} = \SI{23.6}{LSBs}
\]
where $N$ is the number of samples, $x[n]$ is the $n$-th ADC digitized value and $\te{E}[x]$ is the mean of $x$. This value can be compared to the theoretical value, $E_\te{RMS} = \SI{18.7}{LSBs}$ since $V_\te{N,tot,theor} = \SI{11.2}{mV}$ and one LSB is $V_\te{CC} / 2^{12} = \SI{0.6}{mV}$. The excess noise is due to the environmental noise that remains at the microphone input, which is always present except in an anechoic chamber.

\begin{figure}[H]
    \centering
    \input{img/ADC_noise_temp.tex}
    \caption{Noise at the ADC input}
    \label{fig:noise_sound}
\end{figure}


%\subsection*{...}

%\textcolor{green}{ Current consumption over a whole period with/without Tim's board (material: SMU for 2-3 days)​}

    
\subsection*{Requirements review}

Finally, one will review the requirements stated at the beginning of this work (see Section~\ref{section:requirements}). Requirements related to bird classification will be discussed in the next chapter.

\subsubsection*{Lifetime}

The lifetime is limited by the supercapacitor, which is expected to work about \SI{11200}{h} at \SI{60}{\degree C}~\cite{Vishay}.   The 10-degrees-rule for electrolytic capacitors can be used for estimating supercapacitor lifetimes. This rule employs the Arrhenius equation, and states that for every \SI{10}{\degree C} reduction in operating temperature, the estimated life doubles. The expected lifetime $L$ at \SI{20}{\degree C} is thus given by
\[
 L = L_0 \, 2^{\frac{T_0-T}{\SI{10}{\degree C}}} = \SI{179200}{h}
\]
which corresponds to 20.5 years. It can even be increased above 20 years with additional equalization methods~\cite{4494753}. As required, the sensor is working fully autonomously (day and night) for more than 15 years.

\subsubsection*{Volume and cost}

The total volume is inside the \SI{143 x 82 x 25}{mm} constraint: \SI{200 x 200 x 50}{cm}.

The overall cost, including the PCB, is below the limit of 80 euros: 74.28 euros. The most important costs are the solar cells (30.4 euros), the supercapacitor (17.5 euros) and the PCB (20 euros).


\subsubsection*{Sound detection}

Determining the detection distance is probably the most difficult requirement to precisely characterize. It can be based on real-time songs but birds are singing intermittently and with different sound amplitude. It can also be characterized by a speaker emitting bird songs, but the sound pressure cannot either be known without a sound level meter. Still, the device has been able to detect pure sine waves with speakers at reasonable distance.

    
\chapter{Inference algorithm}

This chapter will present different algorithms aiming to discriminate bird types based on the microphone signal. This temporal signal is often transformed into its dual domain: the spectral (or frequency) domain. Representing a signal in the spectral domain is done through the Fourier transform, which is in fact a fast Fourier transform (FFT) for sampled data (such as data stored in a microcontroller).

The requirements in Section~\ref{section:requirements} state that the sensor has to discriminate among four very common birds in Belgian forests. These species are the pigeon, blackbird, great tit, and blue tit. The remaining of the section will demonstrate the ability of the sensor node to find the correct species with sufficient precision.

\section{Peak frequency extraction}

The first algorithm will process bird songs based on the frequency at which the signal has the most power. Because the FFT size is limited by computation time, it is not possible to record and process sound over an entire bird song duration (typically \SI{2}{s}). On the other, one cannot decrease the sampling frequency below \SI{20}{kHz} in order to detect useful frequencies below \SI{10}{kHz}\footnote{The Nyquist–Shannon sampling theorem then states that, to avoid loss of information during a sampling process, a sampling frequency larger than twice the maximum frequency contained in the signal is required.}, which would give \SI{40000}{} samples during a typical song duration. It is thus required to spread the sampling duration over multiple time windows. For example, Figure~\ref{fig:peak_frequency} shows the peak frequency for each time window (\SI{32}{ms} whose \SI{6.4}{ms} to retrieve 128 samples at \SI{20}{kHz}) of a great tit song. One can roughly see two sounds spaced by \SI{4}{ms} and oscillating between \SI{3}{kHz} and \SI{4.5}{kHz}. Based on the graph, it is thus possible to discriminate visually between species with substantially different frequency profiles, but formalizing further embedded processing to extract meaningful information from this peak frequency graph is less trivial. It is also worth noting that there is only one point (i.e. frequency) associated with each time sample.

\begin{figure}[H]
    \centering
    \input{img/peak_frequency.tex}
    \caption{Peak frequencies associated with a great tit song}
    \label{fig:peak_frequency}
\end{figure}

Although this algorithm shows good visual results, this kind of algorithm misses important information for different reasons.

First, most bird songs present several high frequency at the same time, these weaker frequencies are never detected. This means that several bird songs with the same peak frequency but different secondary frequencies are never discriminated.

Second, several birds present different frequency profiles during their song, that is to say the FFT is varying with time (e.g. \SI{3}{kHz} and \SI{4.5}{kHz} for the song presented in Figure~\ref{fig:peak_frequency}). Thereby, characterizing birds based on one FFT over a short period of time misses non-harmonious (or non-periodic) bird songs and cannot discriminate two birds with the same frequency peak in the beginning of their song, for example.


\section{Spectogram decomposition}

From the previous remarks, it is more convenient to represent the signal with a spectrogram: the visual representation of the spectrum of frequencies of a signal as it varies with time. Creating a spectrogram using the FFT is a digital process. Digitally sampled data, in the time domain, is broken up into chunks, which usually overlap, and Fourier transformed to calculate the magnitude of the frequency spectrum for each chunk. Each chunk then corresponds to a vertical line in the image, which provides the magnitude versus frequency for a specific moment.

A smaller (shorter) window will produce more accurate results in timing, at the expense of precision of frequency representation.
This leads to the consideration of trade-offs between time
and frequency resolution in audition: the bandwidth can only be narrowed (i.e. the frequency resolution increased) if the temporal resolution is decreased, because narrower filters have longer time constants.
In the design of linear filters, the uncertainty principle fixes a
limit on the resolution that can be attained (the Gabor limit\footnote{It is nothing else than the Heisenberg's uncertainty principle applied in the context of signal processing to time and frequency (2 dual physical quantities).}),
giving a lower bound for the product of the variance in time
and the variance in frequency for a single linear filter~\cite{Stowell}.

Some birds have several typical songs. For example, Figure~\ref{fig:blue_tit} presents the spectrogram for two common songs of the blue tit. As human perception of sound intensity is logarithmic~\cite{Psychoacoustics}, the graphs are given in the form of log scale.

\begin{figure}[H]
\begin{subfigure}{.48\textwidth}
  \centering
  \input{img/blue_tit1.tex}
  \caption{Bird chirp}
\end{subfigure}
\begin{subfigure}{.48\textwidth}
  \centering
  \input{img/blue_tit2.tex}
  \caption{Bird song}
\end{subfigure}
\caption{Spectrograms of two sounds from the blue tit computed with this sensor node}
\label{fig:blue_tit}
\end{figure}

Due to the limited memory, the signal has to be processed at each time window. This considerably increases the delay between adjacent time windows, given by \SI{26.5}{ms} for an FFT size of $N = 128$ (see Table~\ref{tab:spec_data_proc}).

\begin{table}[H]
\centering
\begin{tabular}{lc}
\toprule
                     & Time [\si{ms}] \\ \midrule
 Data sampling       & 1.28           \\
 FFT                 & 25             \\
 Data storage        & 0.2            \\ \midrule
 Total               & 26.5           \\ \bottomrule
\end{tabular}
\caption{Processing time for one spectrogram data chunk with 128 samples}
\label{tab:spec_data_proc}
\end{table}

In this case, the sampling period is set to \SI{10}{\micro s}, corresponding to a sampling frequency $f_\te{s} = \SI{100}{kHz}$. Hence, the frequency resolution in the spectrogram is given by
\[
 \Delta f = \frac{f_\te{s}}{N} = \SI{781}{Hz}
\]
with a maximum analyzed frequency of $f_\te{s}/2 = \SI{50}{kHz}$. One can finally see the trade-off appearing on the frequency resolution, which cannot be improved (that is, decreased) without 
\begin{itemize}
 \item increasing $N$, which would require more memory storage and processing time (the FFT time evolving according to $\mathcal{O}(N^2)$, or $\mathcal{O}(N \log N)$ with optimized algorithms~\cite{QIU1999159}),
 \item or decreasing $f_\te{s}$, which would increase the sampling time (impinging on the time window length).
\end{itemize}

Figure~\ref{fig:4birds} provides the time--frequency comparison of four different bird songs. As discussed, the frequency resolution is also \SI{781}{Hz}. This makes discrimination among the birds very difficult since some peak frequencies are identical for several birds.

\begin{figure}[H]
\begin{subfigure}{.49\textwidth}
  \centering
  \input{img/Pigeon.tex}
  \caption{Pigeon}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
  \centering
  \input{img/Blackbird.tex}
  \caption{Blackbird}
\end{subfigure}
\newline
\begin{subfigure}{.49\textwidth}
  \centering
  \input{img/Great_tit.tex}
  \caption{Great tit}
  \label{fig:great_tit}
\end{subfigure}
\begin{subfigure}{.49\textwidth}
  \centering
  \input{img/blue_tit2.tex}
  \caption{Blue tit}
\end{subfigure}
\caption{Spectrograms of four different bird songs computed with this sensor node}
\label{fig:4birds}
\end{figure}

To illustrate the difference, Figure~\ref{fig:greattit_full} shows the spectrogram of the great tit when the signal does not significantly suffer from the time-frequency trade-off (that is, the graph has been computed from an audio file at \SI{44.1}{kHz}). One can clearly see four songs oscillating between \SI{3}{kHz} and \SI{6}{kHz}, which is not detected by the embedded low-resource microcontroller (see Figure~\ref{fig:great_tit}). It will thus be needed to work on specific characteristics of the signal instead of the whole spectrogram pattern.

\begin{figure}[H]
    \centering
    \input{img/greattit_full.tex}
    \caption{Precise spectrogram of the great tit song (from a bird song database)}
    \label{fig:greattit_full}
\end{figure}

\subsubsection*{Feature extraction}

Now that the signal has been converted into meaningful information via its spectrogram form, some features need to be extracted from it. Typical features for bird recognition are specific frequencies for each time window, the median as well as the 5 and 95 percentiles which are robust measures of minimum and maximum frequency~\cite{Stowell}. The bandwidth can also be extracted, defined as the difference between the 5 and 95 percentiles. 

For this work, the average frequency weighted by the intensity is analyzed because of its simplicity. In a spectrogram, let $f[i]$ be the vector of discrete frequencies ($y$-axis) with size $N/2$, $t[j]$ be the vector of discrete time samples ($x$-axis) with size $M$ (depending on the audio recording time and the window overlap) and $s[i,j]$ be the intensity of the $i$-th frequency component during the $j$-th time period, then the average intensity for the $i$-th frequency component throughout the time period is
\[
 s_\te{avg}[i] = \frac{1}{M} \sum_{j=1}^{M} s[i,j] \quad [\si{dB/Hz}]
\]
and the weighted average frequency is given by
\[
 f_\te{avg} = \frac{\sum_{j=1}^{L} s_\te{avg}[i] \, f[i]}{\sum_{j=1}^{L} s_\te{avg}[i]} \quad [\si{Hz}]
\]
where $L$ is the index corresponding to a frequency of \SI{10}{kHz} in order to remove high-frequency noise. The spectrogram has frequencies above this range if $f_\te{max} > \SI{10}{kHz}$, that is $f_\te{s} > \SI{20}{kHz}$. It is always the case for this work, with $f_\te{s} = \SI{100}{kHz}$ for the node sensor and $f_\te{s} = \SI{44.1}{kHz}$ for the MP3 audio files analyzed offline.

During calibration, the mean background noise (expressed as power spectral density) is characterized for each frequency, resulting in a combination of $1/f$ and white noise. It is then removed from the intensity $s[i,j]$ when a real signal is analyzed. The algorithm is also tuned by an intensity threshold to output a bird species only when the signal sufficiently exceeds the background noise, meaning that a sound has been produced.

\subsubsection*{Feature selection}

Additionally, feature selection is used to evaluate the predictive power that a feature has with respect to some attribute.
In information gain feature selection, each feature is evaluated by measuring the information gain with respect to the species label, which is the amount by which the feature reduces the uncertainty in the label. To reduce the problem complexity, the weighted average frequency is kept in this work. The problem thus becomes a 1D classification.

\subsubsection*{Inference}

The final step consists to infer the species based on the selected feature. A simple machine-learning model for this purpose is the support vector machine (SVM), but it requires much offline preprocessing beforehand. Since only one feature is analyzed, a machine-learning algorithm has little interest. The classifier used for this work is based on a $k$-nearest neighbors algorithm (KNN) with $k=5$, meaning that the class (i.e. the species) associated with a new sample is classified by a plurality vote among the $k$ nearest data according to the feature (i.e. the weighted average frequency).

A learning phase now consists to analyze several songs from the six species previously mentioned, and extract the weighted average frequency for all these learning samples. Figure~\ref{fig:weighted_average_frequency} shows the repartition of the weighted average frequency among the species learning samples, based on the spectrogram of six different audio samples for each species\footnote{The audio files come from a collaborative and open-source database of bird songs (\textit{xeno-canto}~\cite{xeno}).}.

\begin{figure}[H]
    \centering
    \input{img/weight_mean_freq.tex}
    \caption{Repartition of the weighted average frequency among the species learning samples}
    \label{fig:weighted_average_frequency}
\end{figure}

One can deduce that the weighted average frequency is actually a pertinent feature with useful information since it discriminates quite well between the different species.

Then, these frequencies are stored inside the sensor node in order to infer the species of a newly recorded song. The microcontroller launches a KNN classifier by selecting the species which is the most similar to the new sample (that is, which has the nearest weighted average frequency).

\subsubsection*{Experimental results}

To validate the theoretical work, bird songs are generated from a laptop speaker in the area around the sensor node.
Based on the KNN algorithm and these thresholds encoded in the microcontroller, Table~\ref{tab:predictions_birds} provides the number of right predictions on the learning samples with the very-low-precision algorithm inside the microcontroller. Surprisingly, it manages to retrieve the correct species with more than 94\% of precision on average.

\begin{table}[H]
\centering
\begin{tabular}{lc}
\toprule
 Species   & Number of correct predictions \\ \midrule
 Pigeon    & 6/6                           \\
 Blackbird & 6/6                           \\
 Great tit & 6/6                           \\
 Blue tit  & 4/6                           \\ \bottomrule
\end{tabular}
\caption{Number of right predictions on the learning samples with the sensor node}
\label{tab:predictions_birds}
\end{table}

It is now possible to test the algorithm on new samples, which can either be additional audio files in a database or real-time songs from birds in the vicinity. One will focus on the former since real-time songs are too sporadic to be precisely characterized. For each species, positions of three testing samples are given in Figure~\ref{fig:test_freq_detection}. One can see that the KNN algorithm is able to find the correct for all new samples.

\begin{figure}[H]
    \centering
    \input{img/test_freq_detection.tex}
    \caption{Predictions on new samples with the sensor node}
    \label{fig:test_freq_detection}
\end{figure}


\chapter{Improvement perspectives}
\label{chapter:improvements}

\section{Refinement of inference algorithms}

The majority of discrimination algorithms are done thanks to machine-learning algorithms applied on the time--frequency texture. Typical models use convolutional neural networks (CNNs) and/or recurrent neural networks (RNNs).
With deep learning, bird detection can achieve very high retrieval rates in remote monitoring data, with no manual recalibration, and no pretraining of the detector for the target species or the acoustic conditions in the target environment~\cite{Stowell2018}.

Other less resource-intensive models use feature extraction performed by matching the time-frequency plane with a number of time-frequency blocks previously learned. The minimum matching energy of the blocks makes a feature vector of the audio signal and is sent to a classifier for song discrimination~\cite{4959924}.
However, these models require a substantial amount of memory and speed, which is impractical for embedded applications. Still, one could optimize these memory/time/energy-intensive algorithms based on the microcontroller capabilities in order to extract meaningful information.

Additionally, the present algorithm is not able to find other species. It will thus output one of the four species even for other species and external sounds (such as traffic noise), creating so-called false positive detections. The algorithms previously mentioned would greatly help solve this issue.

\section{Robustness under difficult conditions}

The device can be further designed to integrate a robust protection against difficult environmental conditions. One can for example cite a waterproof case which supports high temperature variations. Potting the entire PCB would also help reduce oxidation and support shocks/vibration which are paramount for an expected lifetime exceeding 15 years.


\chapter{Conclusion}
\label{chapter:conclusion}

The Internet-of-Things (IoT) is predicted to lead to the deployment of a very large number of connected smart sensors for various applications, which is not environmentally sustainable if the devices are frequently replaced.
Additionally, rising climate change due to ecosystem destruction demands to automatically monitor forests in order to analyze and preserve the ecosystem.

In this master thesis, the focus is on the development of an autonomous and efficient audio smart sensor continuously analyzing the forest ecosystem. To fulfill the energy constraints implied by its total autonomy, this sensor harvests energy from the environment through miniaturized photovoltaic cells sized according to the sun illuminance throughout days and seasons, using an environmentally-friendly and non-toxic supercapacitor as energy storage.
With a 15+ year lifetime, this fully autonomous device operates at an optimized \SI{2.5}{V} supply voltage reaching \SI{22.1}{mW} of average power harvesting/consumption. An electret condenser microphone collects a signal as low as \SI{16}{dB_{SPL}} (compared to a \SI{14.22}{dB_{SPL}} input-referred noise), which is then amplified in the full bird emission frequency range (\SI{20}{Hz} -- \SI{20}{kHz}) by a low-noise and low-power analog front-end. This signal is further processed in an ultra-low-power chip embedding a microcontroller, alternating between run and sleep modes with a $1/3$ duty cycle, and a transceiver optimized for IoT applications with LoRaWAN networks. 

The microcontroller detects sounds when birds are active (typically during the day for more than 12 hours) and ensures the radio-frequency communication at night depending on the supercapacitor voltage that is carefully monitored in real time. It sends the information about the bird species encountered during the day, as well as their apparition frequency. In case of firmware update, this device receives the associated fragments when its energy is sufficient and automatically changes the firmware with energy-optimized software requiring only \SI{10.6}{J} for the whole update.

By computing the weighted average frequency of the received sounds, the smart sensor is able to discriminate between four common birds in Belgium: the pigeon, blackbird, great tit and blue tit. For each species, several songs have been analyzed and used to train a $k$-nearest neighbors (KNN) classifier working in the real-time embedded system. Its precision, defined as the likelihood to find the correct species, reaches 94\% for songs coming from the previously learned database. For newly analyzed sounds, the detection algorithm performs likewise. More complex machine-learning algorithms could finally be further designed to discriminate between more species.


\subsection*{SWOT analysis}

A SWOT analysis is a strategic technique used to help  identify strengths, weaknesses, opportunities, and threats related to a concept~\cite{HILL199746}. Depicted in Table~\ref{tab:SWOT}, it concludes this work by summarizing the principal characteristics of this smart sensor which have all been well detailed in Chapters~\ref{chapter:improvements} and \ref{chapter:conclusion}.

\begin{table}[H]
\centering
 \begin{tabular}{p{0.02\textwidth}|p{0.45\textwidth}|p{0.45\textwidth}}
 & \multicolumn{1}{c|}{\textit{Positive}} & \multicolumn{1}{c}{\textit{Negative}} \\ \midrule
 \parbox[t]{3mm}{\multirow{5}{*}{\rotatebox[origin=c]{90}{\textit{Internal}}}} 
 & \textbf{Strengths}: & \textbf{Weaknesses}:\\
 & \tabitem Fully autonomous and low power & \tabitem Resource-limited inference algorithm\\
 & \tabitem Long lifetime (15+ years) & \tabitem Size of the sensor node\\
 & \tabitem Eco-friendly & \tabitem Production cost\\
 & \tabitem Bird classification & \\
 \midrule
\parbox[t]{3mm}{\multirow{5}{*}{\rotatebox[origin=c]{90}{\textit{External}}}}
 & \textbf{Opportunities}: & \textbf{Threats}:\\
 & \tabitem High demand for sustainable sensors & \tabitem Harsh environmental conditions\\
 & \hspace{4mm} and forest monitoring & \\
 & \tabitem Rising of low-power & \\
 & \hspace{4mm} machine-learning algorithms & \\
 \end{tabular}
\caption{SWOT analysis of this smart sensor}
\label{tab:SWOT}
\end{table}


\appendix

\chapter{Transimpedance amplifier}
\label{appendix:transimpedance}

Figure~\ref{fig:circuit_AFE_appendix} presents the transimpedance amplification circuit simplified in the audio frequency.

\begin{figure}[H]
\centering
\begin{circuitikz}[scale=0.5]
    \draw (3.5,-4) node[op amp, scale = 0.5](opamp){} 
        (opamp.+) node[left] {}
        (opamp.-) node[left] {}
        (opamp.out) node[right] {}
        (opamp.down) node[ground] {}
        (opamp.up) ++ (0,.5) node[above] {$VCC$}
        -- (opamp.up); 
    \draw (3.5,1.5)-- (1.0,1.5);% wire w6
    \draw (8.5,1.5)-- (6.0,1.5);% wire w8
    \node (A) at (-10,1) {};
    \draw (1.0,-3.5)-- (1.0,1.5);% wire w13
    \draw (1.0,-3.5) to[short, i=$I_{AC}$] (-1.5,-3.5);% wire w14
    \draw (opamp.-)-- (1.0,-3.5);
    \draw (8.5,-4.0)-- (8.5,1.5);% wire w16
    \draw (8.5,-4.0)-- (opamp.out);% wire w17
    \draw (10.0,-4.0)-- (8.5,-4.0);% wire w18
    \draw (opamp.+) --  (1.5,-4.5) -- (1.5,-10.5);
    \draw (-3.0,-7.5)-- (-3.0,-7.0);% wire w24
    \draw (-3.0,-10.5)-- (-3.0,-10.0);% wire w28
    \draw (1.5,-10.5)-- (-3.0,-10.5);% wire w30
    \draw (-3.0,-11.0)-- (-3.0,-10.5);% wire w31
    \draw (-3.0,-14.5)-- (-3.0,-13.5);% wire w33
    \draw (-3.0,-15.0)-- (-3.0,-14.5);% wire w36
    \draw (-3.0, -15.0) node[ground, xscale=1, yscale=1, rotate=0, ] (undefined) {};
    \draw (6.0, 1.5) to[R, l=$R_2$] (3.5,1.5){};
    \draw (-3.0, -7.5) to[R, l=$R_3$] (-3.0,-10.0){};
    \draw (-3.0, -11.0) to[R, l=$R_4$] (-3.0,-13.5){};
    \node (VCC) [] at (-3.0,-7.0+0.5) {$V_\te{CC}$};
    \node (Vout) [] at (11.0,-4.0) {$V_\te{o}$};
    \node (Vb) [] at (2.5,-10.5) {$V_\te{B}$};
\end{circuitikz}
\caption{Simplified transimpedance amplification circuit}
\label{fig:circuit_AFE_appendix}
\end{figure}

The voltage at the negative terminal of the op-amp is given by
\[
 V_{-} = V_\te{o} - R_2 \, I_\te{AC} \quad \si{[V]}.
\]
Since the positive and negative terminals of an op-amp are identical (ideally), the relation becomes
\[
 V_\te{B} = V_\te{o} - R_2 \, I_{AC} \quad \Rightarrow \quad V_\te{o} = V_\te{B} + R_2 \, I_\te{AC} \quad \si{[V]},
\]
which is the transimpedance transfer function of the circuit.

\chapter{Noise gain of the microphone amplifier}
\label{appendix:noise_gain}

Figure~\ref{fig:circuit_AFE_appendix_noise} presents the transimpedance amplification circuit simplified in the audio frequency. The supply voltage (DC) is grounded and the microphone (input current source) is open-circuited. Noise gain is referred to the noise source, which is connected to the noninverting input by definition.

\begin{figure}[H]
\centering
\begin{circuitikz}[scale=0.5]
    \draw (3.5,-4) node[op amp, scale = 0.5](opamp){} 
        (opamp.+) node[left] {}
        (opamp.-) node[left] {}
        (opamp.out) node[right] {}
        (opamp.down) node[ground] {}
        (opamp.up) ++ (0,.5) node[above] {$V_\te{CC}$}
        -- (opamp.up); 
    \draw (3.5,0)-- (1.0,0);% wire w6
    \draw (8.5,0)-- (6.0,0);% wire w8
    \node (A) at (-10,0) {};
    \draw (1.0,-3.5)-- (1.0,0);% wire w13
    \draw (opamp.-)-- (-3,-3.5) to[R, l=$R_1$] (-3,-7) node[ground] (undefined) {};
    \draw (8.5,-4.0)-- (8.5,0);% wire w16
    \draw (8.5,-4.0)-- (opamp.out);% wire w17
    \draw (10.0,-4.0)-- (8.5,-4.0);% wire w18
    \draw (opamp.+) --  (1.5,-4.5);
    \draw (1.5,-7) to[sV=$V_\te{i}$] (1.5,-4.5);
    \draw (6.0, 0) to[R, l=$R_2$] (3.5,0){};
    \node (Vout) [] at (11.0,-4.0) {$V_\te{o}$};
    \draw (1.5,-7) node[ground] (undefined) {};
\end{circuitikz}
\caption{Simplified transimpedance amplification circuit for the noise gain}
\label{fig:circuit_AFE_appendix_noise}
\end{figure}

The voltage at the negative terminal of the op-amp is given by
\[
 V_{-} = \frac{R_1}{R_1 + R_2} V_\te{o} \quad \si{[V]}.
\]
Since the positive and negative terminals of an op-amp are identical (ideally), the relation becomes
\[
 \frac{V_\te{o}}{V_\te{i}} = 1 + \frac{R_2}{R_1} \quad \si{[V]},
\]
which is the noise gain of the circuit.


\chapter{PCB layout and schematic}
\label{appendix:schematic}

The PCB layout (see Figure~\ref{fig:PCB_lay}) and schematic (see Figure~\ref{fig:PCB_sch}) were designed with KiCad. The PCB is composed of four layers, of which two are for GND and VDD.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{sensing_PMU_layout.pdf}
    \caption{PCB layout}
    \label{fig:PCB_lay}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{sensing_PMU_schematic.pdf}
    \caption{PCB schematics}
    \label{fig:PCB_sch}
\end{figure}


\bibliographystyle{unsrt}
\bibliography{biblio.bib}

% Back cover page
\backcoverpage

\end{document}
