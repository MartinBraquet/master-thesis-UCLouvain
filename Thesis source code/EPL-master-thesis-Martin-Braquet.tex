% EPL master thesis covers template
\documentclass{EPL-master-thesis-covers-EN}

\usepackage{parskip}
\usepackage{siunitx}
\usepackage{float}
\usepackage{textcomp}
\usepackage{amsmath}
\usepackage{subcaption}
\usepackage{pgfplots}
\pgfplotsset{compat=1.15}
\usepackage[hidelinks]{hyperref}
\definecolor{lttotitextcolor}{rgb}{0, 0.4, 0.25}
\usepackage{natbib}

\graphicspath{{img/}}

\newgeometry{top=3cm,bottom=3cm,left=2cm,right=2cm}

\usepackage[americanresistors, RPvoltages, american voltages]{circuitikz}
\tikzstyle{sensor}=[draw, fill=blue!20, text width=5em, 
    text centered, minimum height=2.5em, rounded corners]
\tikzstyle{ann} = [above, text width=5em]
\tikzstyle{afes} = [sensor, text width=6em, fill=red!20, 
    minimum height=4em, rounded corners]
\def\edgedist{2.5}

\usetikzlibrary{external}
\tikzexternalize
\tikzsetexternalprefix{tikz_figures/}


\newcommand{\parallelsum}{\mathbin{\!/\mkern-5mu/\!}}
\newcommand{\te}[1]{\textrm{#1}}


% Please fill in the following boxes
% Title of the thesis
\title{Design of an ultra-low-power energy-harvesting audio sensor for ecosystem monitoring}

% Subtitle - remove this line if not applicable
%\subtitle{Microphone design for biodiversity inventory in forest}

% Name of the student author(s)
\author{Martin \textsc{Braquet}}
%\secondauthor{Firstname \textsc{Lastname}}		% remove if not applicable
%\thirdauthor{Firstname \textsc{Lastname}}			% remove if not applicable

% Official title of the master degree (copy/paste from list below)
% Master [120] in Biomedical Engineering
% Master [120] in Chemical and Materials Engineering
% Master [120] in Civil Engineering
% Master [120] in Computer Science
% Master [120] in Computer Science and Engineering
% Master [120] in Cybersecurity
% Master [120] in Data Sciences Engineering
% Master [120] in Data Science: Information technology
% Master [120] in Electrical Engineering
% Master [120] in Electro-mechanical Engineering
% Master [120] in Mathematical Engineering
% Master [120] in Mechanical Engineering
% Master [120] in Physical Engineering
% Master [60] in Computer Science
% Specialised master in nanotechnologies
% Specialised master in nuclear engineering
\degreetitle{Master [120] in Electro-mechanical Engineering}

% Name of the supervisor(s)
\supervisor{David \textsc{Bol}}
\secondsupervisor{Ramin \textsc{Sadre}}		% remove if not applicable
%\thirdsupervisor{Firstname \textsc{Lastname}}		% remove if not applicable

% Name of the reader(s)
\readerone{Rémi \textsc{Dekimpe}}
\readertwo{Denis \textsc{Flandre}}			% remove if not applicable
%\readerthree{Firstname \textsc{Lastname}}			% remove if not applicable
%\readerfour{Firstname \textsc{Lastname}}			% remove if not applicable
%\readerfive{Firstname \textsc{Lastname}}			% remove if not applicable

% Academic year (update if necessary)
\years{2019--2020}


% Document
\begin{document}

% Front cover page
\hypersetup{pageanchor=false}

\maketitle

\begin{abstract}

On one hand, the Internet-of-Things (IoT) is predicted to lead to the deployment of a very large number (possibly trillions) of connected smart sensors for various applications. Such a massive deployment of smart sensors is not environmentally sustainable if the smart sensors are replaced every 2 years because of the pressure they put on natural resources and the ecotoxicity of the e-waste they generate. Therefore, it is required to fight obsolescence in the IoT domain by enabling a 10+ year lifetime for the smart sensors.

On the other hand, the rising climate change due to ecosystem destruction involves monitoring forests in order to analyze and preserve the ecosystem. Such monitoring is typically achieved manually via a person who samples the data less than once a day, which fails to provide strong results and needs human presence during the data acquisition.

The objective of this master thesis is thus to find a way to continuously analyze the forest ecosystem via an autonomous audio sensor. To fulfill the energy constraints implied by its total autonomy, this sensor requires harvesting energy from the environment through miniaturized photovoltaic cells, using eco-friendly and non-toxic energy storage elements, and having reconfiguration capabilities to keep up with application, security and communication protocol updates.

The result of this development is a prototype measuring sounds up to 50m around, and classifying a bird song among the ten most common ones.
\end{abstract}

\renewcommand{\abstractname}{Acknowledgements}
\begin{abstract}
This thesis has been written throughout my last year at UCLouvain. It gave me the opportunity to have a first glimpse into an important work required for the obtention of a master's degree in engineering.  During this important work, I would like to thank the following people, starting with the most meaningful ones, for their important hints and source of motivation.

First of all, I would like to thank my main supervisor, Prof. D. Bol, for his precious information. In his works, I really appreciated his way to approach a problem, starting with a technological/ecological/social need and then solving it by considering all the factors in the process (systemic approach). His maturity, sensibility and motivation to handle such problems made one of the most important marks on me throughout my studies at UCLouvain. 

Second, I would like to thank Tim Hess who wrote his thesis on the same topic and was focused on the programming/software part. We have had great collaborations to produce the final prototype for this work. He gave me important advice for the overall design of the PCB, more specifically on the handling of KiCad (a PCB design tool).

Third, I would like to thank the members of the ECS group\footnote{Electrical Circuits and Systems group lead by D. Bol and D. Flandre at UCLouvain.} and more specifically Rémi Dekimpe for his constant supervision through the year. He proved his availability at any time and had precious hints.

I would also like to thank my second supervisor, Prof. R. Sadre, for his availability. I want to thank Prof. D. Flandre in advance for the reading of this thesis, as well as for his interesting courses given during my curriculum. More generally, I need to thank all the people who contributed to this work, e.g. for the access to the electronics lab and the ordering of the required materials.
\end{abstract}

\tableofcontents

\listoffigures

\listoftables

\newpage

\hypersetup{pageanchor=true}


\chapter{Introduction}

\section*{Context}

!!! public implicitement visé, l'introduction au sujet et aux notations

\section*{Contributions}

In this master thesis,

All the files used for the simulations as well as the source code of this thesis are fully open-source under the \textit{MIT} license\footnote{Provided that the reader gives appropriate credit, he is free to copy and redistribute the material in any medium or format under the same license as the original. He has the permission to remix, transform, and build upon the material for any purpose, even commercially.} at \url{https://github.com/MartinBraquet/master-thesis-UCLouvain}.

\section*{Structure}

The structure of this thesis has been carefully build to replicate the design process of this sensor. Indeed, the chapters totally mimic the real chronology throughout the year, in such a way that each chapter is only based on the design choices of the previous chapters. 

Chapter 1 ...



\chapter{Use case}

\section{State-of-the-art of audio monitoring}

+ oiseaux foret

Noeuds de capteur + circuits (custom micro, AFE...)​


\section{Requirements analysis}

\begin{itemize}
 \item Range or 50 m for microphone
 \item storage element volume
 \item Life time: 20 years
 \item Toxicity
\end{itemize}



\section{General architecture}


+ General architecture of this type of sensor

briefly explain each block/component.

It is expected that the parts with the most power consumption are the MCU and the microphone, the other parts are designed to be negligible compared to the formers.

Schema de flow (déroulement du mémoire)

\chapter{Energy storage}

Energy storage has an important role in sensor applications. First, this role can be identified as either a unique power for the application, or as a temporary storage of energy provided by the energy harvester. In the framework of this thesis, the latter is considered since solar cells (energy harvester) will bring energy to the system, which is stored in an energy storage element.

Then, one has to characterize the main figures of merits such as the energy density, the maximum self-discharge and application conditions, as well as financial and environmental considerations.

In order to answer the previous requirements, common energy storage types are analyzed and the most suited type for this work is detailed.

\section{Primary batteries}

Primary batteries are non-rechargeable, they thus have only one life cycle. However, they can sometimes still have their place in IoT applications when the power consumption and the sensor lifetime are particularly reduced. Primary batteries are mainly based on three technologies.

\subsection*{Zn-MnO${}_{\textbf{2}}$ batteries}

Zn-MnO${}_2$ batteries are composed of a combination of metallic zinc (oxidation) and a manganese dioxide electrode (reduction). They exist under the form of zinc-carbon cells and alkaline batteries and differ according to the electrolyte inside.

The voltage window is between \SI{0.9}{V} and \SI{1.5}{V}. The energy density of a typical AA (approximately \SI{8}{cm^3}) zinc-carbon cell is \SI{100}{mWhcm^3}, whereas a commercial alkaline cell reaches at present up to \SI{400}{mWhcm^3}~\cite{doi:10.1002/er.2949}.

These batteries are very well known and low cost, but present a high self-discharge rate.

\subsection*{Lithium primary batteries}

Lithium primary batteries have an anode made of metallic lithium and a cathode made of several materials such as MnO${}_2$ or FeS${}_2$.

Batteries integrating MnO${}_2$ commonly deliver a total cell voltage of around \SI{3}{V}. These batteries work with the oxidation of lithium and reduction of manganese, with a typical energy density of \SI{650}{mWhcm^3}.

The second type of lithium battery is based on FeS${}_2$. It has a practical voltage of \SI{1.5}{V} and is therefore compatible with alkaline and zinc-carbon cells. It has an energy density of approximately \SI{550}{mWhcm^3}.

Overall, it is capable of delivering high currents and has a quite flat voltage profile upon discharging. Moreover, it performs well at low temperatures and has a significantly lighter weight than alkaline cells.

\subsection*{Zn-air batteries}

Zn-air batteries are a class of batteries that employ metallic zinc particles as its anode and an aqueous liquid electrolyte. With a voltage of \SI{1.4}{V}, this
battery is commercially available as button cells with an energy density of around \SI{1500}{mWhcm^3}.

Other disadvantages of this type of batteries are that the catalyst that is required for the reduction of oxygen usually consists of expensive noble metals and that the battery is unable to deliver high peak currents. This type of battery is therefore commonly used in applications where only low
currents are required from a battery with a small volume~\cite{doi:10.1002/er.2949}.

\section{Secondary batteries}

Secondary batteries are rechargeable, they thus have a certain number of life cycles (usually more than 500). Only battery types that are suitable in the IoT domain are presented in this thesis.

\subsection*{Batteries with liquid or polymer gel electrolytes}


\subsubsection*{Nickel metal hydride batteries}

Nickel metal hydride batteries (NiMH) combine nickel at the positive electrode and hydrogen (metal hybride) at the negative electrode.  During discharge, a proton, obtained from the electrolyte, occurs in reduction of nickel oxyhydroxide. The loss of protons in the electrolyte produces hydroxide anions which will recombine with a proton from the metal hybride.

The cells typically work at around \SI{1.2}{V}, allowing interchangeability with alkaline batteries. However, they have a higher self-discharge rate and a narrow temperature window (0 to \SI{45}{\degree C}). The energy density is around 250 and \SI{380}{mWhcm^3}.

\subsubsection*{Li-ion batteries}

Lithium-ion batteries are composed of lithium metal oxyde at the positive electrode (LiCoO${}_2$) and a material storing lithium in a neutral form such as graphite at the negative electrode. The charge process is based on the motion of lithium ions from the metal oxyde to the electrolyte, where they are stored in graphite.

Compared to NiMH batteries, hey have higher energy density (between 300 and \SI{500}{mWhcm^3}), lower self-discharge rate and larger temperature window (-20 to \SI{60}{\degree C}). They are however easily damaged in case of overdischarging or overcharging, thus requiring a special protective electric circuit for the power management.

However, liquid electrolytes have high volatilility and have been the source of explosions in lithium batteries. Research has thus been done on the design of solid electrolytes.

\subsection*{Solid-state batteries}

Solid-state batteries use solid electrodes and a solid electrolyte, such as ceramics (e.g. oxides, sulfides, phosphates) or a solid polymer. They are potentially safer than batteries with liquid electrolytes, with higher energy densities, but at a much higher cost.
However, these efforts have faced a number of issues.

One of the biggest problems is that when the battery is charged up, atoms accumulate inside the lithium metal, causing it to expand. These repeated changes in the metal’s dimensions make it difficult for the solids to maintain constant contact, and tend to cause the solid electrolyte to fracture or detach.

Another problem is that none of the proposed solid electrolytes are truly chemically stable while in contact with the highly reactive lithium metal, and they tend to degrade over time.

\section{Supercapacitors}

Supercapacitor are high-capacity capacitors storing energy in an electric field, rather than in a chemical reaction, like batteries. This allows high power density for short-term energy storage\footnote{They can provide very high currents during a short time.}, almost instant recharging and very long lifetimes. Made of porous carbon (electrodes) and liquid salts (electrolyte), they are not composed of harmful\footnote{Failing in a nice way, they will never overrun or start a fire.} chemicals or toxic metals.
Since the supercapacitor is non-chemical, the voltage is free to rise until the dielectric fails (often in the form of a short circuit). It is thus needed to avoid going higher than the specified voltage, which is characterized by a lower voltage limit than batteries.

Due to their behaviour in between electrolytic capacitors and batteries, they are particularly well suited for IoT applications. Indeed, they typically store 10 to 100 times more energy per unit volume or mass than electrolytic capacitors. They can also accept and deliver charge much faster than batteries, and tolerate many more charge and discharge cycles than rechargeable batteries. Nevertheless, care needs to be paid to their significant leakage current which is proportional to the value of the supercap.

Instead of using a conventional solid dielectric, supercapacitors use electrostatic double-layer capacitance and electrochemical pseudocapacitance~\cite{2019JPS...414..420B}.

\subsection*{Electrostatic double-layer capacitors}

Electrostatic double-layer capacitors (EDLCs) are the most common type of supercapacitors. They use carbon electrodes or derivatives with much higher electrostatic double-layer capacitance than electrochemical pseudocapacitance, achieving separation of charge in a Helmholtz double layer at the interface between the surface of a conductive electrode and an electrolyte.

\subsection*{Electrochemical pseudocapacitors}

Electrochemical pseudocapacitors use metal oxide or conducting polymer electrodes with a high amount of electrochemical pseudocapacitance additional to the double-layer capacitance. They store charge chemically through redox reactions where one species transfers electrons to another, similar to a battery. While pseudocapacitors store more energy, their widespread use has been hampered by their narrow electrochemical voltage window, which is the voltage range where the electrode materials are stable.

Additionally, there exist hybrid capacitors, such as the lithium-ion capacitors, using electrodes with different characteristics: one exhibiting mostly electrostatic capacitance and the other mostly electrochemical capacitance.

\section{New developments}

New promising methods are also developed in research laboratories.

\subsection*{3D electrodes for electrochemical energy storage}

Superior energy or power density for batteries is typically achieved only in ultrathin electrodes with low mass loadings. To realize the full potential of these electrode materials, new electrode architectures allow more efficient charge transport beyond the limits of traditional electrodes. Working on the design and synthesis of 3D electrodes is promising to address charge transport limitations in thick electrodes. Such 3D porous architectures could enable composite electrodes with an unprecedented combination of energy and power densities~\cite{Sun2019}.

In addition to the recent development of Li-Ion batteries with  flexible, bendable, or foldable characteristics, some researches have been focused on batteries with advanced feature of stretchability in which the systems are able to accommodate large mechanical strain and still maintain their functions. Such sponge-inspired electrodes for stretchable Li-Ion Batteries show no specific capacity reduction when bended, unlike the cells using conventional electrodes~\cite{doi:10.1002/adma.201505299}.

\subsection*{Lithium metal anode}

Recent research has been achieved on lithium metal anodes that could improve the longevity and energy density of future batteries~\cite{10.1038/s41586-020-1972-y}.

Most attempts to overcome the problems of solid-state batteries have focused on designing solid electrolyte materials that are absolutely stable against lithium metal, which turns out to be difficult.  Instead, the researchers adopted an unusual design that utilizes two additional classes of solids, “mixed ionic-electronic conductors” (MIEC) and “electron and Li-ion insulators” (ELI), which are absolutely chemically stable in contact with lithium metal. 

They developed a three-dimensional nanoarchitecture in the form of a honeycomb-like array of hexagonal MIEC tubes, partially infused with the solid lithium metal to form one electrode of the battery, but with extra space left inside each tube. When the lithium expands in the charging process, it flows into the empty space in the interior of the tubes, moving like a liquid even though it retains its solid crystalline structure. This flow, entirely confined inside the honeycomb structure, relieves the pressure from the expansion caused by charging, but without changing the electrode’s outer dimensions or the boundary between the electrode and electrolyte. The other material, the ELI, serves as a crucial mechanical binder between the MIEC walls and the solid electrolyte layer.

\section{Shape}

In addition to the electrical and thermal characteristics, the form of the storage element is particularly important for IoT devices where the full sensor size is often limited. The main trade-off thus appears between the charge capacity and the size of the energy storage element.

The main shapes of micro-batteries are button cells, pouch cells and thin film batteries.

\section{Comparison}

Table~\ref{tab:comparison_energy_storage} presents the main figures of merit for the previously described types of energy storage.

\begin{table}[H]
\centering
\scalebox{0.66}{
\begin{tabular}{l|ccc|ccc}
\hline
                          & \multicolumn{3}{c}{Capacitors} & \multicolumn{3}{c}{Batteries} \\ \hline
                          & Ceramic & Electrolytic & Supercap & Non-rechargeable & \multicolumn{2}{c}{Rechargeable} \\
                          &  &  & EDLC & Alkaline & NiMH & Lithium ion \\ \hline
 Power density [W/g]      &  & > 100 & 2 -- 10 &  & 2.5 -- 10 & 1 -- 3  \\
 Energy density [mWh/g]   & 0.1~\cite{DEKIMPE20198} & 0.01 -- 0.3  & 5 &  & 60 -- 120  & 120 -- 240 \\
 Self-discharge rate [per month]     & 100\% & \SI{100}{h} & 50\% & < 0.3\% & 0.08 – 2.9\% & 5\% \\
 Leakage current          & 1 -- 100 \si{nA/\micro F}  &  & 2 -- 5 \si{fA/\micro F}~\cite{DMF3Z5R5H474M3DTA0}~\cite{Vishay} &  &  & 5 \si{\micro A}~\cite{DEKIMPE20198} \\
 Service life [years]     & 25~\cite{DEKIMPE20198} & 15 & 10 -- 15 & 5 -- 10 &  & 5 --10 \\
 Life cycles              & unlimited~\cite{DEKIMPE20198} & unlimited & \SI{1000000}{} & 1 & 180 -- 2000 & 500 \\
 Degradation              & negligible &  & -80\% in 10 years &    &  & -50\% in 500 cycles     \\
 Charge time              &    &  & 1 -- \SI{10}{s} &    &  & 10 -- \SI{60}{min}     \\
 Cell voltage [V]             &    & 4 -- 630 & 2.3 -- 2.75 & 1.5   & 1.2 & 3.6     \\
 Charge T° [\si{\degree C}] &  & -40 -- 70 & -40 -- 65 & & & 0 -- 45 \\
 Discharge T° [\si{\degree C}             &  & -40 -- 70 & -40 -- 65 & & & -20 -- 60 \\
 Discharge efficiency     &   & 99\% & 95\% &    & 66\% -- 92\% & 90\%     \\
 Toxicity                 &    &  & low &    &  & middle \\ \hline
\end{tabular}
}
\caption{Comparison of various types of energy storage}
\label{tab:comparison_energy_storage}
\end{table}

In this table, the life cycle is the number of complete charge/discharge cycles that the battery is able to support before its capacity falls under 80\% of its original capacity.
Although the deployment of such sensors would imply the fabrication of several thousands of energy storage element, the impact of the toxicity is small for such projects lasting more than 20 years without replacement. The degradation corresponds to the decrease of its maximum energy storage throughout its life.

The overall efficiency is computed as
\[
 \eta = \frac{E_\te{O}}{E_\te{I}}
\]
where $E_\te{O}$ is the energy delivered during the whole life of the energy storage element, and $E_\te{I}$ is the total energy fed to the energy storage, composed of both the fabrication energy and the recharge energy. It is difficult to compute this efficiency due to the lack of information about the fabrication energy (typically not given by manufacturers). However, Li-ion batteries (\SI{50.17}{kWh/kg} for electric vehicles~\cite{manufacturing_lithium}) require more manufacturing energy than supercapacitors (\SI{50.17}{kWh/kg} for electric vehicles~\cite{manufacturing_lithium}).


\subsection*{Criticality}
\iffalse
Criticality (environmental and societal impact) + rarity

Lithium-ion components [6]:
    • Metal oxide compound: 
        ◦ Lithium: extracted from brine or rock.
        ◦ Nickel
        ◦ Cobalt
    • Graphite (= C) (could be replaced with silicon, in research, could multiply energy density by 4): container with high electrochemical potential (storage of e- and lithium ions when charged)
    • Electrolyte
    • Plates (copper + aluminium)

NiMH components [7]:
    • Nickel oxide hydroxide (NiOOH): positive electrode
    • Hydrogen-absorbing alloy (Rare-earth or nickel alloys with many metals:V, Ti, Zr, Ni, Cr, Co, and (!) Fe ): negative electrode
    • Alkaline potassium hydroxyde: electrolyte
    • Plates (copper + aluminium)

EDLC components:
    • Porous carbon (film, activated carbon paste or carbon fabric) (Activated carbon (AC), carbon nanotubes (CNT) and carbon aerogels) (Only Carbon) (electrodes) [8]: build from graphite (not rare?)
    • Liquid salts (water with ions) (electrolyte)
    • Polymeric membrane forming a microporous layer (separator) (very small)

Rare earth elements:
    • 

    \fi
    
\section{Selection}

Based on the results, a supercapacitor is chosen for its sustainability... The sizing of this supercapacitor will be achieved in Chapter~\ref{supercap_sizing} when the whole power comsumption is fully determined. 

Approx energy available based on normal volume of supercap -> guideline through the design -> compared with this value and check that small parts draw less than 1 percent of this energy.

\chapter{Power management}

purpose

\section{Operating voltage design}
\label{section:operating_voltage}

mesures du MCU à différentes tensions et comparer. Check on web if already done or simulator.

rendement de conversion de l'AEM (LDO -> write equations, Vhv/Vbatt, same current) qui est différent en fonction de la tension de sortie (voir graphes)

\section{Power management unit}

required tasks

\subsection*{Battery configuration}

Set custom Vovdis, Vovch, Vchrdy, by R1 to R6

LED on status[0] to see when the battery is OK

\subsection*{Linear-Dropout Regulator configuration}

Vhv

Vlv disabled


\subsection*{Maximum Power Point Tracking}

 for solar panels
 
 Open Circuit Voltage Based Maximum Power Point Tracking for Photovoltaic System
 
 The open circuit Voltage algorithm is the simplest MPPT control method. This technique is also known as constant voltage method.
 
 Choose first Vmppt/Voc = 0.76 ()
 and then experimental calibration with sensor (jumper on pins?)
 
 The main disadvantage of this method is that there is
momentary power loss due to the disconnection of the load
from the PV array for the sampling of its open circuit voltage \cite{10.1109/ICSTE.2010.5608868}
 
+ power efficiency of AEM between solar panel and battery (Vboost)

``Typical voltage to supply sensor and MCU is 3.3V (see Section 2.3 and 2.4), it is considered to be
the supply voltage needed by the system. The AEM from E-peas is a power management unit
(see section 2.2.4) which claims 0.3V of voltage drop between the supply voltage and the voltage
over the storage element. So, the voltage on the supercapacitor should not go under 3.6V. The
maximal voltage depends on the supercapacitor and on the power management unit limitation.
The AEM from E-peas is limited to 4.5V.''






\section{Startup behaviour?}

At cold start, the PMU needs to charge the supercapacitor up to Vchrdy (more or less 3.1V) in order to enable the LDOs (Low-Dropout Regulator). Considering an empty supercapacitor, one can theoretically compute the startup time corresponding to the time delay between the start of the sensor and the power supply of the different subsystems.



\chapter{Sensing subsystem}

Sound waves are generated by the variation of a physical characteristics, the pressure. This deviation propagates via vibrations in the environment in such a way that sound can be measured by a microphone from a distance of the source.

Sound waves are often described in terms of sinusoidal plane waves (see Figure~\ref{fig:sound_wave}). Hence, they have a direction of propagation, a speed $v$, a frequency $f$ and an amplitude $A$. 

\begin{figure}[H]
\centering
\begin{tikzpicture}[x={(-10:1cm)},y={(90:1cm)},z={(210:1cm)}]
    % Axes
    \draw (-1,0,0) node[above] {$x$} -- (5,0,0);
    \draw (0,0,0) -- (0,2,0) node[above] {$y$};
    \draw (0,0,0) -- (0,0,2) node[left] {$z$};
    % Propagation
    \draw[->,ultra thick] (5,0,0) -- node[above] {$v$} (6,0,0);
    % Waves
    \draw[thick] plot[domain=0:4.5,samples=200] (\x,{cos(deg(pi*\x))},0);
    % Arrows
    \foreach \x in {0.1,0.3,...,4.4} {
        \draw[->,help lines] (\x,0,0) -- (\x,{cos(deg(pi*\x))},0);
    }
    % Labels
    \node[above right] at (0,1,0) {$A$};
    \node[below] at (0,0,1) {};
\end{tikzpicture}
\caption{General sound wave description}
\label{fig:sound_wave}
\end{figure}

The amplitude of sound pressure corresponds to the loudness of a sound and is typically expressed as the root mean square (RMS) amplitude, called sound
pressure level (SPL). Let the RMS sound pressure be $p=A/\sqrt{2}$ for sine waves, the SPL amplitude is given by
\[
 L_p = 20\log_{10}\left(\frac{p}{p_0}\right) \simeq 20\log_{10}(p) + 94 \quad [\si{dB_{SPL}}]
\]
where $p_0=\SI{20}{\micro Pa}$ is the reference RMS pressure (hearing threshold of humans at \SI{1}{kHz}).

Additionally, the sound SPL amplitude changes over the distance (from $r_1$ to $r_2$) according to the propagation of spherical waves:
\[
 L_{p_2} = L_{p_1} + 20\log_{10}\left(\frac{r_2}{r_1}\right) \quad [\si{dB_{SPL}}].
\]

Tabke~\ref{tab:sound_levels} gives typical sound pressure levels.

\begin{table}[H]
\centering
\scalebox{1}{
\begin{tabular}{lcc}
\hline
  Source of sound & Distance & Sound pressure [dB] \\ \hline
  Jet engine           & \SI{1}{m}   & 150 \\
  Trumpet              & \SI{0.5}{m} & 150 \\
  Traffic on busy road & \SI{10}{m}  & 90  \\
  Passenger car        & \SI{10}{m}  & 70  \\
  Quiet room           & ambient     & 25  \\ \hline
\end{tabular}
}
\caption{Typical sound pressure levels}
\label{tab:sound_levels}
\end{table}

In this work, the sensor is required to detect the song of a bird (around \SI{50}{dB_{SPL}} at \SI{1}{m} of the source) located \SI{50}{m} away. The minimum detected sound pressure is thus
\[
 L_{p_\te{min}} = 50 - 20\log_{10}(50) = \SI{16}{dB_{SPL}}.
\]
Sound production from several bird species have been measured to peaks of about \SI{95}{dB_{SPL}} and are generally greater for larger birds~\cite{FHWA}. The sensor thus needs to detect sounds of at least
\[
 L_{p_\te{max}} = 95 - 20\log_{10}(50) = \SI{61}{dB_{SPL}}.
\]

The frequency range of human hearing is often reported to be between 20 and \SI{20000}{Hz}, but the ability to hear higher frequencies decreases with age. For this reason, a correction, called A-weighting, is applied to instrument-measured sound levels to account for the relative loudness perceived by the human ear as a function of the frequency (see Figure~\ref{fig:a_weighting}).

\begin{figure}[H]
    \centering
    \input{img/a_weighting.tex}
    \caption{A-weighting curve}
    \label{fig:a_weighting}
\end{figure}

Many bird songs have frequency ranges between 1,000 Hz and 8,000 Hz, which places them in the sweet spot of human hearing. However, some birds can produce sounds at frequencies as low as \SI{23}{Hz}~\cite{10.2307/4090277} or as high as \SI{15}{kHz}~\cite{doi:10.1111/j.1474-919X.1962.tb08647.x}. Since the presented sensor aims to mainly analyze bird sounds, it has to match the frequency specifications ranging between \SI{20}{Hz} and \SI{20}{kHz}.

\textcolor{green}{Doppler effect on speed ?}

In the end, the characteristics of the sound wave at the sensor are summed up in Table~\ref{tab:wave_charact_sensor}.

\begin{table}[H]
\centering
\scalebox{1}{
\begin{tabular}{lcc}
\hline
  Pressure range & 16 -- 61 & \si{dB_{SPL}} \\
  Frequency range  & 20 -- 20000 &  Hz      \\ \hline
\end{tabular}
}
\caption{Sound wave characteristics at the sensor}
\label{tab:wave_charact_sensor}
\end{table}


As depicted in Figure~\ref{fig:sensing_subsystem}, the sensing subsystem is composed of a microphone and a signal conditioning circuit called analog front-end. This block handles the signal transmission from the input sound pressure detected by the microphone to an analog voltage $V_{\te{ADC,mic}}$ further processed by a microcontroller.

\begin{figure}[H]
\centering
\begin{tikzpicture}
    \node (afe) [afes] {Analog Front-End};
    \path (afe.0)+(-6,0) node (mic) [sensor] {Microphone};
    \path [draw, ->] (mic) -- node [above] {$I_{\te{mic,AC}}$} (afe.west |- mic) ;
    \draw [->] (afe.0) -- node [ann] {} + (1,0) node[right] {$V_{\te{mic,ADC}}$};
\end{tikzpicture}
\caption{Block diagram of the sensing subsystem}
\label{fig:sensing_subsystem}
\end{figure}

\section{Microphone}

A microphone is a device that converts sound into an electrical signal (also called transducer). Generally, they mimic the inner workings of human ear by using a diaphragm which vibrates with the sound pressure. There exist several types of microphones for which the most important characteristics, called figures of merit, need to be compared.


\subsection*{Main types of microphone}

Microphones are categorized by their transducer principle, corresponding to the way they detect the variation of input sound pressure.

\subsubsection*{Carbon microphones}

Carbon microphones were the first created type of electrical microphone. They are based on the variation of an electrical resistance between two plates due to the motion of a diaphragm on one of these plates. This type of microphone is less used because of its limited frequency response and high noise level (background and crackling noise~\cite{background.noise}).

\subsubsection*{Optical microphones}

Optical microphones use the moving diaphragm as a reflection plate for the light of a laser. The intensity of the light, dependent on the deformation of the diaphragm, is converted to an electrical signal through a photo-diode. Their high power consumption (more than \SI{5}{mW}, \SI{5.4}{mW} in~\cite{optical_microphone})  prevents them from being used in IoT applications.

\subsubsection*{Condenser microphones}

Condenser microphones are based on a parallel-plate capacitor for which one of the plates is the diagram. For a fixed charge $Q$ on the capacitor, the voltage across the capacitor varies with the capacitance according to
\[
V = \frac{Qd}{\varepsilon A}
\]
where $s$ is the distance between the plates, $A$ is area of the plate, and $\varepsilon$ is the electric permittivity of the medium inside the plates.

This type can be further divided in active and passive condenser microphones.

Active condenser microphones require biasing circuitry to charge the capacitor and perform first stage amplification. In this group belong microelectromechanical systems (MEMS) microphones which are small package condenser microphones made using semiconductor production techniques. Typically, they already integrate an ADC inside. The small size and the rather low power consumption (\SI{10}{\micro W} to  \SI{1}{mW}~\cite{ICS40720},~\cite{10.3390/mi9070323}) of MEMS microphones is ideal for IoT applications.
 
Passive condenser microphones do not require biasing of the capacitor. For instance, condenser electret microphones have an electret material as diaphragm, a material that has a permanent electrical charge on it. Passive microphones are also appealing for their low power consumption and reduced complexity.
 
\subsubsection*{Piezoelectric microphones}

Piezoelectric microphones directly translate the sound pressure into a voltage through the use of a piezoelectric crystal, which redistributes the charges in the crystal under a deformation. They can be packaged in MEMS microphones and have a low power consumption (about \SI{300}{\micro W}~\cite{PMM-3738-VM1000-R}). However, their high impedance makes them sensitive to electrostatic pick-up of hum\footnote{Mains hum electric hum is a sound associated with alternating current at the frequency of the mains electricity (\SI{50}{Hz}).}, which decreases its performance in the presence of mains-powered audio equipment or AC electromagnetic fields from nearby appliance.

\subsubsection*{Inductive microphones}

Inductive microphones are passive microphones working via electromagnetic induction. The vibrations of the diaphragm move a permanent magnet through a coil, inducing an electrical current. They are generally less sensitive, especially at picking up high frequencies and short, detailed sounds. They are also unable to pick up distant sounds laterally and from the back of the microphone, which may lead to flatter audio (unidirectionality). They are thus not suited for this application.


\subsection*{Figures of merit}

In order to select the most suited type of microphone for this application, one has to characterize the main microphone's figures of merit.

\subsubsection*{Power consumption}

For both active and passive microphones, the operation current and voltage are of essential importance in IoT applications. The standard operation voltage $V_{\te{mic}}$ is the voltage needed by the microphone to operate with full functionality, so that the microphone can amplify and record signals fully. The maximum current consumption is often specified to provide a rough upper limit. However, one is more interested in the measurement of the microphone IV curve which allows to deduce the operation current $I_{\te{mic}}$ at the operation voltage.

\subsubsection*{Sensitivity}

Sensitivity is the electrical response at the microphone output to a given standard acoustic input. The standard reference input signal for microphone sensitivity measurements is a \SI{1}{kHz} sine wave at \SI{94}{dB_{SPL}}, or \SI{1}{Pa}. It is expressed in \si{V/Pa} or in \si{dB}.

\subsubsection*{Signal-to-noise ratio}

In the microphone's framework, the signal-to-noise ratio (SNR) specifies the ratio of a reference signal to the noise level of the microphone output. Brought back in the input, the SNR is the difference in decibels between a standard \SI{1}{kHz}, \SI{94}{dB_{SPL}} reference signal and a microphone pressure noise. It is an image of the noise generated inside the microphone, called self-noise. Expressed in \si{dB_{SPL}}, self-noise acts like a theoretical external noise source placed at the input of an ideal microphone. The relation between the self-noise and the SNR is thus given by
\[
 \te{SNR} = 94 - \te{self-noise} \quad \si{[dB]}.
\]
SNR is calculated by measuring the noise output of the microphone in a quiet, anechoic environment. This specification is typically presented over a \SI{20}{kHz} bandwidth as an A-weighted value.

\subsubsection*{Frequency response}

The frequency response describes the output level across the frequency spectrum. The high and low frequency limits are described as the points at which the microphone response is \SI{3}{dB} below the reference output level at \SI{1}{kHz}, which is customarily normalized to \SI{0}{dB}. As for the SNR, the frequency response characterization requires precise measurements in anechoic chamber. Typical microphone frequency ranges lie in the human hearing range.

\iffalse
\subsubsection*{Output impedance}

The output impedance is a measurement of the AC resistance (at \SI{1}{kHz}) looking back into the microphone.
\fi

\subsubsection*{Directionality}

Directionality describes the pattern in which the microphone’s sensitivity changes when the sound source changes position in space. Most of the analyzed microphones are omnidirectional.


Finally, the main figures of merit associated with a microphone are summarized below:

\begin{itemize}
 \item $I_{\te{mic}}$: rated current (in [A]),
 \item $V_{\te{mic}}$: rated voltage (in [V]),
 \item $S$: sensitivity from the input sound pressure to the output voltage (in [dB]),
 \item $\te{SNR}_{\te{mic}}$: signal-to-noise ratio (in [dB]),
% \item $R_\te{L}$: output impedance (in [\si{\ohm}]),
 \item the frequency range (in [Hz]),
 \item the directionality,
 \item and the operating temperature (in [\si{\degree C}]).
\end{itemize}


\subsection*{Microphone type selection}

IoT devices are limited by their size, cost and energy requirements. Table~\ref{tab:mic_types_comparison} quantitatively summarizes the two main characteristics for each type of microphone.

\begin{table}[H]
\centering
\scalebox{0.98}{
\begin{tabular}{lcccc}
\hline
  Type                 & Reference      & Noise [\si{dB_{SPL}}] & Power cons. [\si{\micro W}]             \\ \hline
  Condenser (MEMS)     & ICS-40720  & 24 & 570     \\
  Condenser (Electret) & AOM-5024L-HD-R & 14 & 420     \\
  Piezoelectric        & PMM-3738-WP-R  & 33 & 300     \\ \hline
\end{tabular}
}
\caption{Comparison of several types of microphone}
\label{tab:mic_types_comparison}
\end{table}

A piezoelectric microphone is not considered due to its sensitivity to electrostatic pick-up of hum. MEMS and electret condenser microphones are very similar and well suited for this application, but MEMS microphones already have the amplification circuit inside.
Finally, an electret condenser microphone is selected for this work since it allows a precise design of the amplification circuit, optimizing the whole noise and power consumption.

\subsection*{Electret condenser microphone selection}

Considering the main figures of merit stated above, Table~\ref{tab:mic_comparison} compares several state-of-the-art electret condenser microphones.

\begin{table}[H]
\centering
\scalebox{0.95}{
\begin{tabular}{lccc}
\hline
                              & ABM-707-RC  & CMC-6027-24L100 & AOM-5024L-HD-R \\ \hline
 Current [\si{\micro}A]       & 500         & 500             & 500            \\
 Voltage [V]                  & 1.5         & 2               & 2              \\
 Sensitivity [dB]             & -41         & -24             & -24            \\
 SNR [dB]                     & 60          & 70              & 80             \\
 Output impedance [\si{\ohm}] & 2.2         & 2.2             & 2.2            \\
 Frequency range [Hz]         & 50 -- 16000 & 100 -- 20000    & 20 -- 20000    \\
 Temperature [\textdegree C]  & -20 -- 60   & -20 -- 70       & -30 -- 70      \\ \hline
\end{tabular}
}
\caption{Comparison of several electret condenser microphones}
\label{tab:mic_comparison}
\end{table}

The AOM-5024L-HD-R microphone has been selected since it surpasses the others in terms of the most important parameters, the self-noise (related to the SNR) and the sensitivity, while keeping roughly the same power consumption.With its self-noise of \SI{14}{dB_{SPL}}, it is in fact the only microphone allowing the stay below the \SI{16}{dB_{SPL}} limit for the minimum detectable sound wave.

However, one has to characterize more precisely the current and voltage characteristics because the values given in the datasheets are very general (current of \SI{500}{\micro A} and voltage of \SI{2}{V}). The IV curve of the AOM-5024L-HD-R and the ABM-707-RC\footnote{The ABM-707-RC, which was initially available in the laboratory, served as a first measurement to characterize the microphone and the analog front-end.} is given in Figure~\ref{fig:IV_mic}.

\begin{figure}[H]
    \centering
    \input{img/IV_mic.tex}
    \caption{IV curve of several microphones}
    \label{fig:IV_mic}
\end{figure}

\textcolor{green}{Retest SMU with less noise (adapt correct range of measurement) -> K2400}

\textcolor{green}{For AOM-5024L: test variation of audio sensitivity with the operating voltage (relative compared to 2 V) with a fixed sound source: possible to bias below 2 V ? -> mydaq}

In order to select the best operating voltage, one has to find a trade-off between keeping a low voltage (and thus a low power consumption) and having a sufficient sensitivity by retaining the microphone transistor in saturation. Finally, the operating point given in Table~\ref{tab:op_point_mic} for the AOM-5024L-HD-R will be considered in the following. One can sadly notice a power consumption slightly higher than the reference microphone, this model remains the best suited because of his high precision (the self-noise of the reference microphone is too high to be considered in this work).

\begin{table}[H]
\centering
\begin{tabular}{lcc}
\hline
 Current & $I_{\te{mic}}$   & \SI{358}{\micro A} \\
 Voltage & $V_{\te{mic}}$   & \SI{2}{V}          \\ \hline
\end{tabular}
\caption{Operating point of the AOM-5024L-HD-R microphone}
\label{tab:op_point_mic}
\end{table}

\section{Analog Front-End}

Once the microphone type is selected, one can analyse in more detail the working principle of electret microphones.
The voltage variation across the electret capacitor varies with the capacitance, acting as an ac-coupled voltage source. Because the charge on the microphone capacitor must be fixed, the amplifier circuitry directly in contact with it must have extremely high input impedance, such that no charge can flow through the amplifier circuit. 

For this reason, most electret microphones have an internal junction field effect transistor (JFET) which buffers the microphone capacitor. The voltage signal produced by sound modulates the gate voltage of the JFET ($V_\te{G}$), causing a change in the current flowing between the drain and source of the JFET ($I_{\te{mic}}$). An extremely high resistance may be included to bias the gate of the JFET, but parasitic resistances in the microphone PCB will be sufficient in this work.

\begin{figure}[H]
\centering
\begin{circuitikz}[scale=0.5]
    \draw (3.5,-4) node[op amp, scale = 0.5](opamp){} 
        (opamp.+) node[left] {}
        (opamp.-) node[left] {}
        (opamp.out) node[right] {}
        (opamp.down) node[ground] {}
        (opamp.up) ++ (0,.5) node[above] {$V_\te{CC}$}
        -- (opamp.up);
    \draw (3.5,4.5) --  (1.0,4.5) -- (1.0,1.5); % wire w3_w5 polyline 
    \draw (3.5,1.5)-- (1.0,1.5);% wire w6
    \draw (8.5,1.5)-- (6.0,1.5);% wire w8
    \draw (8.5,1.5) --  (8.5,4.5) -- (5.5,4.5); % wire w4_w7 polyline 
    \draw (-7.0,1.5)-- (-7.0,2.0);% wire w9
    \draw (-7.0,-3.5)-- (-7.0,-2.0);% wire w11
    \draw (-8.5,-6.0)-- (-8.5,-6.0);% wire w21_w22 end
    \draw (-7.0,-3.5) to [red,short,i_=$I_{\te{mic}}$] (-7,-5) to[Tnjfet,n=jfet,mirror] (-7.0,-13.0);
    \node (A) at (-10,1) {};
    \draw (jfet.G) -- (A |- jfet.G) to[C] (-10,-13) -- (-7,-13);
    \draw (-3.5,-3.5)to[red,short, i=$I_\te{AC}$] (-7.0,-3.5);% wire w12
    \draw (1.0,-3.5)-- (1.0,1.5);% wire w13
    \draw (1.0,-3.5)-- (-1.5,-3.5);% wire w14
    \draw (opamp.-)-- (1.0,-3.5);% wire w15
    \draw (8.5,-4.0)-- (8.5,1.5);% wire w16
    \draw (8.5,-4.0)-- (opamp.out);% wire w17
    \draw (10.0,-4.0)-- (8.5,-4.0);% wire w18
    \draw (2.5,-4.5)-- (2.5,-4.5);% wire w19_w29 start
    \draw (1.5,-10.5)-- (1.5,-10.5);% wire w19_w29 end
    \draw (opamp.+) --  (1.5,-4.5) -- (1.5,-10.5); % wire w19_w29 polyline
    \draw (-3.0,-7.5)-- (-3.0,-7.0);% wire w24
    \draw (-8.5,-7.5)-- (-8.5,-7.5);% wire w23_w25 end
    \draw (-3.0,-10.5)-- (-3.0,-10.0);% wire w28
    \draw (1.5,-10.5)-- (-3.0,-10.5);% wire w30
    \draw (-3.0,-11.0)-- (-3.0,-10.5);% wire w31
    \draw (1.5,-11.5)-- (1.5,-10.5);% wire w32
    \draw (-3.0,-14.5)-- (-3.0,-13.5);% wire w33
    \draw (1.5,-13.5) --  (1.5,-14.5) -- (-3.0,-14.5); % wire w34_w35 polyline 
    \draw (-3.0,-15.0)-- (-3.0,-14.5);% wire w36
    \draw (-3.0, -15.0) node[ground, xscale=1, yscale=1, rotate=0, ] (undefined) {};%  (undefined)++(0.0,0.0) node {undefined }; % component "circuiTikz\\gnd" "undefined" 
    \draw (-7.0, -13.0) node[ground, xscale=1, yscale=1, rotate=0, ] (undefined) {};%  (undefined)++(0.0,0.0) node {undefined }; % component "circuiTikz\\gnd" "undefined" 
    \draw (-7.0, 1.5) to[R, l=$R_1$] (-7.0,-1.5){} to[red,short,i=$I_{DC}$] (-7.0,-2.0); %\node [] at (-7.5,1.0) {x}; % component "res" "R1" 
    \draw (-3.5, -3.5) to[C, l=$C_1$] (-1.5,-3.5){}; % component "cap" "C1" 
    %\node [] at (-1.5,-3.0) {x}; % component "cap" "C1" 
    \draw (5.5, 4.5) to[C, l=$C_2$] (3.5,4.5){}; % component "cap" "C2" 
    %\node [] at (5.5,5.0) {x}; % component "cap" "C2" 
    \draw (6.0, 1.5) to[R, l=$R_2$] (3.5,1.5){}; %\node [] at (6.5,2.0) {x}; % component "res" "R2" 
    \draw (-3.0, -7.5) to[R, l=$R_3$] (-3.0,-10.0){}; %\node [] at (-3.5,-7.0) {x}; % component "res" "R3" 
    \draw (-3.0, -11.0) to[R, l=$R_4$] (-3.0,-13.5){}; %\node [] at (-3.5,-10.5) {x}; % component "res" "R4" 
    \draw (1.5, -13.5) to[C, l=$C_3$] (1.5,-11.5){}; % component "cap" "C3" 
    %\node [] at (2.0,-13.5) {x}; % component "cap" "C3" 
    \node (VCC) [] at (-7.0,2+0.5) {$V_\te{CC}$};% label mark % label "" "VCC" lbl37 
    \node (Vb) [right] at (1.5,-10) {$V_\te{B}$};
    \node (VCC) [] at (-3.0,-7.0+0.5) {$V_\te{CC}$};% label mark % label "" "VCC" lbl40 
    \node (Vout) [] at (11.0+1,-4.0) {$V_{\te{mic,ADC}}$};
    \node (Vout) [] at (-11.0,-9.0) {$V_\te{G}$};
    \node (lbl88) [lttotitextcolor, align=left] at (-11,-8) {Electret microphone\\ model};% text mark % text "" "Electret microphone model lbl88 " 
    \draw [lttotitextcolor, line width=0.4pt, dashed] (-15.0,-14.5) rectangle (-6.0,-7.0); % sch Rect % schLine "SchRect" (-736, 368)->(-160, 128) style=1
\end{circuitikz}
\caption{Microphone and analog front-end circuit}
\label{fig:circuit_AFE}
\end{figure}

The amplification circuit presented in Figure~\ref{fig:circuit_AFE} is typical for condenser electret microphones~\cite{tidu765}. It allows to convert the microphone current $I_\te{AC}$ into an output voltage $V_{\te{mic,ADC}}$ which sweeps the input of a further ADC.

The current in the microphone $I_\te{mic}$ has a DC component ($I_\te{DC}$) necessary to put the internal JFET in the saturation region, and an
AC component ($I_\te{AC}$) caused by sound waves. If the impedance of capacitor $C_1$ is much less than $R_1$ at audio frequencies, then $I_\te{AC}$ will flow through $C_1$ and not $R_1$. The op amp acts as a transimpedance amplifier, and attempts to hold its inverting input at a constant voltage $V_\te{B}$ by varying its output. The resistors and capacitors of the circuit will be further designed such that in the audio sound frequency band, $C_2$ and $C_3$ are open-circuited, and  $C_1$ is short-circuited.
In this case, the output voltage of the op amp is simply given by
\[
 V_{\te{mic,ADC}} = R_2\, I_\te{AC} + V_\te{B} \quad \si{[V]}
\]
in this frequency band (see Appendix~\ref{appendix:transimpedance} for the details).

Because capacitor $C_3$ is chosen to have a very low impedance at audio frequencies, the voltage at the drain of the microphone JFET ($V_\te{DS}$) varies very little, potentially reducing distortion caused by channel length modulation in the JFET. This makes the circuit very convenient since the drain current $I_\te{mic}$ only depends on the JFET gate voltage $V_\te{G}$, and not the constant voltage $V_\te{DS}$.


Designing this amplification circuit requires more attention than for the microphone since it induces consequent noise which is mainly due to the operational amplifier. The next computations will introduce a trade-off between the noise reduction and the power consumption of common operational amplifiers.

\subsection*{Amplification circuit design}

The parameters of the AOM-5024L-HD-R microphone selected for this design are summed up in Table~\ref{tab:selected_mic_charac} with the experimental current measurements.

\begin{table}[H]
\centering
\scalebox{0.95}{
\begin{tabular}{lccc}
\hline
 Op. current      & $I_{\te{mic}}$  & 210  &  \si{\micro}A \\
 Op. voltage      & $V_{\te{mic}}$  & 2 &  V  \\
 Sensitivity      & $S_{\te{mic,dB}}$  & -24  & dB  \\
 SNR              & $\te{SNR}_{\te{mic}}$        & 80    & dB      \\
 Output impedance & $R_{\te{L,mic}}$ & 2.2 & \si{k\ohm}    \\
 Frequency range  &      & 50 -- 16000 & Hz  \\
 Temperature      &  & -20 -- 60  & \si{\degree C} \\ \hline
\end{tabular}
}
\caption{Characteristics of the selected microphone: AOM-5024L-HD-R}
\label{tab:selected_mic_charac}
\end{table}

The microphone self-noise is given by $p_{\te{SN,dB}} = \SI{14}{dB}$ and $ p_{\te{SN}} = \SI{100}{\micro Pa}$.

\subsubsection*{Gain calculation}

First, the dB value of the sensitivity must be converted to a linear value, which is
\[
 S_{\te{V,mic}} = 10^{S_{\te{mic,dB}}/20} = \SI{63.1}{mV/Pa}
\]
expressed in volts per Pascal of air pressure.

Because the pre-amplifier is a transimpedance type, this must be converted to a value of current per Pascal of air pressure. It can be converted thanks to the microphone impedance, which was used to measure the microphone sensitivity. The output current per Pascal of air pressure is
\[
 S_{\te{I,mic}} = \frac{S_{\te{V,mic}}}{R_{\te{L,mic}}} = \SI{28.7}{\micro A/Pa}.
\]
Then, one has to map the minimum detected input sound pressure to the minimum detected output voltage of the amplifier.

The minimum input sound pressure, determined at the beginning of the chapter, is given by
\[
 L_{p,\te{min}} = \SI{16}{dB_{SPL}} \quad \Rightarrow \quad p_\te{min} = p_0 \, 10^{L_{p,\te{min}}/20} = \SI{126}{\micro Pa},
\]
which is expressed in RMS value. It corresponds to a minimum drain current in the microphone of 
\[
 I_{\te{mic,min,RMS}} = S_{\te{I,mic}} \, p_\te{min} = \SI{3.63}{nA}.
\]
The minimal output voltage depends on the ADC resolution of the microcontroller unit. The STM32L15 has a 12-bit resolution and the operating voltage $V_\te{CC}$ is \SI{2.5}{V} (see Section~\ref{section:operating_voltage}). The ADC resolution is thus
\[
 V_{\te{ADC,res}} = \frac{V_\te{CC}}{2^{12}} = \SI{610}{\micro V}.
\]
In order for the input signal to be read with sufficient precision (6 bits) by the ADC, it has to vary higher than $2^6 \,V_{\te{ADC,res}}$. Based on Figure~\ref{fig:ADC_res}, one can deduce the minimum RMS voltage:
\[
 2^6 \, V_{\te{ADC,res}} = 2 \sqrt{2} \, V_\te{ADC,RMS} \quad \Rightarrow \quad V_\te{ADC,RMS} = 2^4 \sqrt{2} \, V_{\te{ADC,res}} = \SI{13.8}{mV}
\]
or $V_{\te{ADC,RMS}} = \SI{-37.2}{dBV}$.

\begin{figure}[H]
\centering
\begin{tikzpicture}[scale=1]
% Axes:
\draw [->] (-3,0) -- (4,0) node [right]  {$t$};
\draw (-3,0.5) -- (3,0.5) ;
\draw[dashed] (-3,1.5) -- (3,1.5) ;
\draw (-3,2.5) -- (3,2.5) ;
\draw[red] (-3,1.5) sin (-2,2.8) cos (-1,1.5) sin (0,0.2) cos (1,1.5) sin (2,2.8) cos (3,1.5);
\draw[<->] (-3.2,0.5) -- (-3.2,2.5);
\node (Vres) [] at (-4.5,1.5) {$2^6 \, V_{\te{ADC,res}}$};
\draw[<->,brown] (2,1.5) -- (2,2.8);
\node (Vadc) [brown] at (2.5,1.1) {$\sqrt{2} \, V_\te{ADC,RMS}$};
\node (Vadc) [red] at (4,2) {$V_\te{ADC}(t)$};
\end{tikzpicture}
\caption{Resolution and RMS values of ADC voltage}
\label{fig:ADC_res}
\end{figure}

Then, one can compute the transimpedance gain, which maps the RMS values of the input current to the output voltage:
\[
 R_2 = \frac{V_\te{ADC,RMS}}{I_{\te{mic,min,RMS}}} = \SI{3.81}{M\ohm}.
\]
The maximum microphone RMS current appears when the ADC voltage is maximum:
\[
 I_{\te{mic,max,RMS}} = \frac{V_\te{CC}/(2\sqrt{2})}{R_2} = \SI{232}{nA},
\]
corresponding to a maximal input sound pressure of
\[
   p_\te{max} = \frac{I_{\te{mic,max,RMS}}}{S_{\te{I,mic}}} = \SI{8.1}{mPa} \quad \Rightarrow \quad L_{p,\te{max}} = 20\log_{10}\left(\frac{p_\te{max}}{p_0}\right) = \SI{52.1}{dB_{SPL}}.
\]
The input spreads from \SI{16}{dB_{SPL}} to \SI{52.1}{dB_{SPL}}, giving a variation of \SI{36.1}{dB}. It is worth noting that, when expressed in dB, the input variation is exactly equal to the 6-bit output variation\footnote{This is the difference between the bit resolution of the ADC (12) and the number of bits used for the minimum detectable signal (6).} since 
\[
 20\log_{10}\left(2^{6}\right) = \SI{36.1}{dB}.
\]
Thereby, there is a tradeoff between the number of bits dedicated to the minimum ADC signal (6 bits) and the input pressure range (6 bits) since they sum to the ADC resolution (12 bits). Still, the maximum input sound pressure of \SI{52.1}{dB_{SPL}} suits quite well the requirements of this work, for which a louder sound is rarely produced by birds (about \SI{60}{dB_{SPL}} at the source~\cite{10.1007/s00265-009-0743-4}).
Figure~\ref{fig:mic_scales} depicts the three main variables of the sensing subsystem expressed in dB-scale: the input sound pressure $p$, the microphone voltage $V_{\te{mic}}$ and the output voltage $V_\te{ADC}$.

\begin{figure}[H]
\centering
\begin{tikzpicture}[scale=1]
\def\SPLmin{1.6}
\def\res{3.61}
\def\vmin{3.72}
\def\Sens{2.4}
\draw[dashed, brown] (-4,\SPLmin) -- (4,\SPLmin) ;
\draw[dashed, brown] (-4,\SPLmin+\res) -- (4,\SPLmin+\res) ;
\draw[<->,brown] (-5,\SPLmin) -- (-5,\SPLmin+\res);
\node (Vadc) [brown,align=left] at (-6,\SPLmin+\res/2) {Input\\pressure\\range};
\draw[<->,brown] (5,\SPLmin) -- (5,\SPLmin+\res);
\node (Vadc) [brown,align=left] at (6,\SPLmin+\res/2) {Output\\voltage\\range};
\draw[->](-4,0)--(-4,10)node[font=\small,above]{$p$ [\si{dB_{SPL}}]};
\foreach\y in {10,20,...,90}{
 \draw[](-4,\y/10)--(-4.1,\y/10)node[left,font=\small]{$\y$};
}
\draw[->](-2,0)--(-2,10)node[font=\small,above]{$p$ [\si{dB}]};
\foreach\y in {-90,-80,...,0}{
 \draw[](-2,\y/10+9.4)--(-2.1,\y/10+9.4)node[left,font=\small]{\y};
}
\draw[->](1,0)--(1,13)node[font=\small,above]{$V_\te{mic}$ [\si{dBV}]};
\foreach\y in {-110,-100,...,0}{
 \draw[](1,\y/10+9.4+\Sens)--(0.9,\y/10+9.4+\Sens)node[left,font=\small]{\y};
}
\draw[->](4,0)--(4,10)node[font=\small,above]{$V_\te{ADC}$ [\si{dBV}]};
\foreach\y in {-40,-30,...,40}{
 \draw[](4,\y/10+\SPLmin+\vmin)--(3.9,\y/10+\SPLmin+\vmin)node[left,font=\small]{\y};
}
\draw[dashed, purple] (-2,9.4) -- (-0.5,9.4) ;
\draw[dashed, purple] (-0.5,9.4+\Sens) -- (2.5,9.4+\Sens) ;
\draw[latex-, purple](-0.5,9.4+\Sens)--(-0.5,9.4);
\draw[latex-, purple](2.5,\SPLmin+\vmin)--(2.5,9.4+\Sens);
\draw[dashed, purple] (2.5,\SPLmin+\vmin) -- (3.5,\SPLmin+\vmin) ;
\node (Vadc) [purple,align=left] at (1.8,\SPLmin+\res+3.5) {$G_{\te{V,dB}}$};
\node (Vadc) [purple,align=left] at (-1.5,\SPLmin+\res+6) {$S_{\te{mic,dB}}$};
\draw[->,dashed] (-2,12.0) to [out=70,in=190] (-0.4,13.2) ;
\draw[->,dashed] (2.2,13.2) to [out=-20,in=100] (3.7,11.5) ;
\node (Vadc) [] at (-2,13.5) {Microphone};
\node (Vadc) [align=left] at (4.5,13.5) {Amplification\\circuit};
\node (Vadc) [teal,align=left] at (-6,1.2) {Microphone\\self-noise};
\draw[dashed, teal] (-4.8,1.4) -- (-4,1.4) ;
\end{tikzpicture}
\caption{Range of $p$, $V_{\te{mic}}$ and $V_\te{ADC}$ along the dB-scale}
\label{fig:mic_scales}
\end{figure}

The output ADC voltage has been fixed by the microcontroller specifications.
The minimum input sound pressure, expressed both in \si{dB} and \si{dB_{SPL}}, has then been mapped to the minimum ADC voltage and in turn fixed the maximum input sound pressure.

The only remaining degree of freedom for the microphone and amplification circuit lies in the relative position of the scale in between, characterizing the microphone voltage. This voltage is obtained from the input sound through the microphone sensitivity $S_{\te{mic,dB}}$, and is converted to the ADC voltage through the voltage gain of the amplification circuit:
\[
 G_{V,\te{dB}} = \frac{V_\te{ADC,RMS}}{V_\te{mic,RMS}} = \frac{R_2 \, I_\te{mic,RMS}}{V_\te{mic,RMS}} = \frac{R_2}{R_\te{L}} \quad \si{[dB]}.
\]
Since the input/output relation is given by
\begin{align*}
  p_\te{dB} + S_{\te{mic,dB}} + G_{\te{V,dB}} &= V_\te{ADC,RMS} \quad \si{[dB]},\\
  \SI{16}{dB} - \SI{94}{dB} + S_{\te{mic,dB}} + G_{\te{V,dB}} &= 
  \SI{-37.2}{dB},
\end{align*}
the scale of the microphone voltage needs to be adapted according to
\[
 S_{\te{mic,dB}} + G_{\te{V,dB}} = \SI{40.8}{dB}.
\]
This relation is useful for a parallel optimization of both the microphone and amplification circuit aiming at selecting the best noise/current consumption characteristics. However, the previous microphone selection has fixed the sensitivity at \SI{-24}{dB} and leads directly to a voltage gain of \SI{64.8}{dB}.

Finally, the self-noise for this microphone (\SI{14}{dB_{SPL}}) is below the minimum input sound pressure. Brought back in the input pressure domain, the AFE noise will also be computed and added to this intrinsic microphone noise.

\iffalse
\[
 V_\te{N,mic,ADC} = 10^{-\te{SNR}/20} \, S_{\te{mic}} \, G_{\te{V}} = \SI{205}{\micro V}
\]
is not much detected since it is less than the ADC resolution.
This microphone output noise voltage is then compared to the ADC voltage resolution, expressed as peak values:
\[
 \te{Microphone Noise Ratio} = \frac{\sqrt{2} \, V_\te{N,mic,ADC}}{V_{\te{ADC,res}}/2} = \SI{79}{\%}.
\]
\fi

The feedback capacitor $C_2$ compensates for parasitic capacitance at the op amp inverting input which can cause instability. It also forms a high frequency pole with resistor $R_2$ in the response of the amplifier. According to the frequency range specified for the input sound pressure, the frequency of this pole must be $f_\te{H} = \SI{20}{kHz}$. The feedback capacitor value can then be calculated as
\[
 C_2 = \frac{1}{2 \pi \, f_\te{HF} \, R_2} = \SI{2.09}{pF}.
\]

\subsubsection*{Microphone bias resistor and coupling capacitor}

The internal JFET of the electret microphone being biased by resistor $R_1$, the value of this resistor can be calculated from the desired supply voltage ($V_\te{CC}$), and the microphone operating voltage ($V_\te{mic}$) and current consumption ($I_\te{mic}$):
\[
 R_1 = \frac{V_\te{CC} - V_\te{mic}}{I_\te{mic}} = \SI{2.38}{k\ohm}.
\]
Resistor $R_1$ and capacitor $C_1$ form a high-pass filter. The corner frequency of this filter must be low enough to not attenuate low-frequency sound waves. As specified in the input frequency range, a corner frequency of $f_\te{L} = \SI{20}{Hz}$ is used to calculate the value of $C_1$:
\[
 C_1 = \frac{1}{2 \pi \, f_\te{L} \, R_1} = \SI{3.34}{\micro F}.
\]

\subsubsection*{Operational amplifier}

The required slew rate of the amplifier can be determined by calculating the maximum rate of change at the op amp output, arising  for a sine wave at $f_\te{max} = \SI{20}{kHz}$ and an amplitude of $V_\te{CC}/2$ which sweeps the full output range. For sine waves, it can be shown\footnote{This is the highest slope of a sine function, appearing when the signal crosses 0.} that the slew rate is computed as
\[
 \te{SR} = 2 \pi f_\te{max} \frac{V_\te{CC}}{2} = \SI{0.188}{V/\micro s}.
\]
As a conservative rule, it is advised to select 10 times this slew rate to eliminate any possibility of slew-induced distortion, which is very important in the analysis of microphone data. This sets the required slew rate to \SI{1.88}{V/\micro s}.

The op amp is selected such that it adds the lowest noise possible at the output of the amplification circuit, avoiding the degradation of the data processing. However, such low-noise operational amplifiers consume a lot of power. One has thus to analyze and compare several state-of-the-art op amps in order to choose the one which suits the best this noise/power consumption tradeoff for this application.

The related op amp parameters that need to be well selected are the current consumption (quiescent current $I_\te{Q}$), the input current noise spectral density $I_\te{N}$, and the input voltage noise spectral density $E_\te{NV}$.

The ADC voltage noise at the output is based on three noise contributions. The first noise is the thermal noise from resistors $R_1$ and $R_2$:
\[
 E_\te{NR} = \sqrt{4 \, k_\te{B} \, T \, (R_1 \parallelsum R_2)} = \SI{6.26}{nV/\sqrt{Hz}}
\]
where $T = \SI{300}{K}$ is the temperature and $k_\te{B} = \SI{1.38e-23}{J/K}$ is the Boltzmann constant.

The second noise contribution is the op amp input current noise:
\[
 E_\te{NI} = I_\te{N} \, (R_1 \parallelsum R_2) \quad \left[\si{V/\sqrt{Hz}}\right]
\]
where $I_\te{N}$ op amp input current noise spectral density. The last noise supply is due to the op amp input voltage noise $E_\te{NV}$.

The output noise spectral density of the amplifier circuit is then given by
\[
 E_\te{N,ADC} = A_\te{N} \sqrt{E_\te{NR}^2 + E_\te{NI}^2 + E_\te{NV}^2} \quad \left[\si{V/\sqrt{Hz}}\right]
\]
for which
\[
 A_\te{N} = 1 + \frac{R_2}{R_1} = 1600
\]
is the noise gain of the op amp (see Appendix~\ref{appendix:noise_gain} for the details). Since the signal gain is directly determined by $R_2$, a very low supply voltage $V_\te{CC}$ decreases the value of $R_1$, which increases the noise gain of the op amp. Hence, the noise/power consumption tradeoff also appears for the design of $R_1$.

Finally, the RMS output noise voltage can be computed by multiplying the output noise spectral density by the square of the bandwidth of integration (spreading over an A-weighting curve). An A-weighting curve can be approximated using a \SI{13.5}{kHz} noise bandwidth $B_\te{A}$, the RMS output noise voltage is thus (in RMS value)
\[
 V_\te{N,ADC} = \sqrt{B_\te{A}} \, E_\te{N,ADC} \quad [\si{V}].
\]
This noise contribution is then brought back in the input pressure domain, the \textit{input-referred noise} from the AFE is thus given by
\begin{align*}
  p_\te{IRN,AFE} &= \frac{V_\te{N,ADC}}{R_2\,S_{\te{I,mic}}}\\
   &= \frac{\sqrt{B_\te{A}}}{R_2\,S_{\te{I,mic}}} \left(1 + \frac{R_2}{R_1}\right) \sqrt{4 \, k_\te{B} \, T \, (R_1 \parallelsum R_2) + I_\te{N}^2 \, (R_1 \parallelsum R_2)^2 + E_\te{NV}^2} \quad \si{[Pa]}.
\end{align*}
One can directly see that this noise is roughly independent from $R_2$ since $(1+R_2/R_1)/R_2\simeq 1/R_1$ in our design and the contribution from $I_\te{N}$ is typically negligible compared to $E_\te{NV}^2$.

\iffalse
As for the microphone noise, this output noise voltage is compared to the ADC voltage resolution, expressed as peak values:
\[
 \te{Op Amp Noise Ratio} = \frac{\sqrt{2} \, V_\te{N,ADC}}{V_{\te{ADC,res}}/2} \quad [\%].
\]
\fi

Since the total input-referred noise is composed of non-correlated sources (from the microphone $p_{\te{SN}}$ and the AFE $ p_\te{IRN,AFE}$, their noise power add up to give
\[
 p_\te{IRN} = \sqrt{p_{\te{SN}}^2 + p_\te{IRN,AFE}^2} \quad \si{[Pa]}.
\]

Figure~\ref{fig:output_noise_op_amp} presents this input-referred noise with respect to the current consumption for several operational amplifiers.

\begin{figure}[H]
    \centering
    \input{img/input_noise.tex}
    \caption{Comparison of input-referred noise and current consumption for several operational amplifiers}
    \label{fig:output_noise_op_amp}
\end{figure}

The ultra low-power LMV551 op amp has a quiescent current of only \SI{37}{\micro A}, but the input-referred noise of \SI{17.85}{dB_{SPL}} exceeds the minimum detectable input pressure.
In order to keep the noise voltage not much detected from the ADC, the input-referred noise typically needs to be smaller than the minimum input signal (as depicted in Figure~\ref{fig:ADC_res_noise}).

\begin{figure}[H]
\centering
\begin{tikzpicture}[scale=1]
% Axes:
\draw [->] (-3,0) -- (4,0) node [right]  {$t$};
\draw (-3,0.5) -- (3,0.5) ;
\draw[dashed] (-3,1.5) -- (3,1.5) ;
\draw (-3,2.5) -- (3,2.5) ;
\draw[purple] (-3,1.5) sin (-2.5,1.7) cos (-2,1.5) sin (-1.5,1.3) cos (-1,1.5) sin (-0.5,1.7) cos (0,1.5) sin (0.5,1.3) cos (1,1.5) sin (1.5,1.7) cos (2,1.5) sin (2.5,1.3) cos (3,1.5);
\draw[<->] (-3.2,0.5) -- (-3.2,2.5);
\node (Vres) [align=left] at (-4.5,1.5) {Min range\\of $p_{\te{signal}}$};
\node (Vadc) [purple] at (4,2) {$p_\te{IRN}(t)$};
\end{tikzpicture}
\caption{Voltage noise and resolution at the amplification output}
\label{fig:ADC_res_noise}
\end{figure}

The OPA2834 has an input-referred noise of $p_\te{IRN,OA} = \SI{14.22}{dB_{SPL}}$ while keeping a particularly small current consumption of \SI{170}{\micro A}. One finally selects this op amp since it has the lowest noise in the group of 3 op amps which belong to an acceptable range of quiescent current (from \SI{100}{\micro A} to \SI{200}{\micro A}).

%Summing the noise contributions from the microphone and the operational amplifier leads to a total output voltage of 90\% compared to the ADC resolution. One thus expects a maximum digitized error of 1 consecutive code level introduced by the ADC quantization.

In the end, the OPA2834 op amp characteristics are given in Table~\ref{tab:selected_op_amp}. The slew rate of \SI{26}{V/\micro s} is well above the limit of \SI{1.88}{V/\micro s}.

\begin{table}[H]
\centering
\scalebox{0.95}{
\begin{tabular}{lccc}
\hline
 Criteria            & Required    & OPA2834  & Units             \\ \hline
 Supply voltage      & 2.7 -- 5.4  & 2.5      & V                 \\
 Quiescent current   & < 200       & 170      & \si{\micro A}     \\
 Input voltage noise & < 27        & 12       & \si{nV/\sqrt{Hz}} \\
 Input current noise & N/A         & 0.2      & \si{pA/\sqrt{Hz}} \\
 Slew rate           & > 1.88      & 26       & \si{V/\micro s}   \\ \hline
\end{tabular}
}
\caption{Characteristics of the selected operational amplifier: OPA2834}
\label{tab:selected_op_amp}
\end{table}

The noise voltage from the AFE can be theoretically computed over an A-weighting curve of bandwidth $B_\te{A} = \SI{13.5}{kHz}$ as
\[
 V_\te{N,ADC,theor} = \sqrt{B_\te{A}} \, E_\te{N,ADC} = \SI{2.52}{mV}
\]
where $E_\te{N,ADC}$ depends on the voltage and current noise of the OPA2834.

As a validation of the amp op selection, Figure~\ref{fig:output_noise_op_amp_freq} describes the noise voltage spectral density at the amplification output. 
This noise is the combination of flicker (or $1/f$) noise and thermal (flat-band) noise. Hence it depends on the frequency and is higher for frequencies below the $1/f$ corner frequency: \SI{150}{Hz} for the voltage noise and \SI{900}{Hz} for the current noise, as given in the op amp datasheet. Since audio signals contain frequencies that are particularly low, the noise is sadly impinged by flicker noise. For a frequency of \SI{22}{Hz}, the noise reaches \SI{37}{\micro V/\sqrt{Hz}}.

Since the noise contribution from the microphone is not represented in the simulation, this simulated noise can be compared to the theoretical value of the AFE noise (\SI{2.52}{mV}). Due to the frequency dependence, one needs to integrate the noise power spectral density over the whole frequency range in order to obtain the output noise voltage:
\[
 V_\te{N,ADC,simu} = \sqrt{\int_{0}^{\infty} E_\te{N,ADC}(f)^2 \, \te{d}f} = \SI{2.37}{mV}.
\]
As expected, the result is very similar to the theoretical one, hence not impinging the previous conclusions for the choice of the best operational amplifier.

%This small contribution compared to the microphone noise makes the total voltage noise in the order of the ADC resolution (104\%), which still allows a low-noise digitization.

\textcolor{green}{Add input op amp noise on graph?}

\begin{figure}[H]
    \centering
    \input{img/output_noise_freq.tex}
    \caption{Noise voltage spectral density from AFE at the amplification output (from \textsc{LTspice})}
    \label{fig:output_noise_op_amp_freq}
\end{figure}

\subsubsection*{Op amp bias network}

Resistors $R_3$ and $R_4$ center the op amp input and output at the midpoint between the power supplies to allow for the widest possible output signal swing. Therefore $R_3 = R_4$ for $V_\te{B} = V_\te{CC} / 2$. The value of these resistors needs to be very high in order to limit the power supply current drawn by this voltage divider. However, the non zero op amp input bias current prevents the bias voltage $V_\te{B}$ to be exactly at $V_\te{CC} / 2$, and this variation worsens with the value of the bias resistors. A reasonable choice consists to set a maximum bias voltage variation of 1\%:
\[
 \Delta V_\te{B} = R_3 \, I_\te{b+} < 0.01 V_\te{B} \quad \Rightarrow \quad R_3 < 0.01 \frac{V_\te{CC}}{2I_\te{b+}} = \SI{179}{k\ohm}
\]
where $I_\te{b+} = \SI{70}{nA}$ for the selected op amp. A final value of
\[
 R_3 = R_4 = \SI{150}{k\ohm}
\]
is finally chosen, which implies a current in the voltage divider of approximately
\[
 I_\te{B} = \frac{V_\te{CC}}{R_3 + R_4} = \SI{8.33}{\micro A}.
\]
This current is small (less than 5\%) compared to the microphone bias current, and is a good tradeoff between the power consumption and the bias voltage stability.

Capacitor $C_3$ is included to filter thermal noise created by the resistors and any noise which may be present on the power supply. The corner frequency of the low pass filter is formed by $R_3$, $R_4$ and $C_3$. It should be well below the operating frequency range in order to prevent noise from affecting the audio performance of the design. A corner frequency of $f_\te{B} = \SI{5}{Hz}$ is selected:
\[
 C_3 = \frac{1}{2 \pi \, f_\te{B} \, (R_3 \parallelsum R_4)} = \SI{424}{nF}.
\]

\subsubsection*{Summary}

Table~\ref{tab:selected_values_microphone} summarizes the selected values for the amplification circuit.

\begin{table}[H]
\centering
\begin{tabular}{lcc}
\hline
                   & \multicolumn{2}{c}{Value} \\
                   & Theoretical         & Real \\ \hline
 $R_1$             & \SI{4.76}{k\ohm}    & \SI{4.76}{k\ohm} \\
 $R_2$             & \SI{71.4}{k\ohm}    & \SI{71.4}{k\ohm} \\
 $R_3$             & \SI{200}{k\ohm}     & \SI{200}{k\ohm} \\
 $R_4$             & \SI{200}{k\ohm}     & \SI{200}{k\ohm} \\
 $C_1$             & \SI{1.67}{\micro F} & \SI{1.67}{\micro F} \\
 $C_2$             & \SI{111}{pF}        & \SI{111}{pF} \\
 $C_3$             & \SI{64}{nF}         & \SI{64}{nF} \\
 $V_\te{CC}$       & \SI{3}{V}           & \SI{3}{V} \\
 Power consumption & \SI{}{\micro W}     & \SI{}{\micro W} \\
 Output noise      & \SI{329}{\micro V}  & \SI{}{\micro V} \\ \hline
\end{tabular}
\caption{Final values for the amplification circuit}
\label{tab:selected_values_microphone}
\end{table}

Figure~\ref{fig:microphone_AC} presents the AC transfer function of the amplification circuit, which confirms a bandwidth ranging from \SI{20}{Hz} to \SI{20}{kHz}.

\textcolor{green}{Check bandwidth opamp (cause of additional poles ?)​}

\begin{figure}[H]
    \centering
    \input{img/microphone_AC.tex}
    \caption{AC transfer function of the amplification circuit (from \textsc{LTspice})}
    \label{fig:microphone_AC}
\end{figure}

\textcolor{green}{For this pre-amplifier design, it is beneficial to have the largest value for R1 possible for two reasons. First,
the noise gain of op amp U1 is.
But the signal gain is directly determined by R2. Therefore, increasing the value of R1 decreases the noise
gain of the op amp. Second, capacitor C3 must be large enough that its impedance is much less than
resistor R1 at audio frequencies. Increasing the value of R1 allows for smaller capacitances to be used for
C3.}

As stated before, the classical trade-off between noise and power consumption was not worth considering in the microphone selection since the other microphones suffer from a too high noise. However, if the constraint on the minimum detectable sound wave were relaxed, the choice of the microphone and operational amplifier would have to be optimized conjointly by computing the input-referred noise and power consumption of the whole sensing subsystem.

\chapter{Data processing and transmission}



The 12-bit ADC has been used to convert the analog microphone voltage to a digital signal. One might be interested to improve the ADC resolution up to 14 bits via diverse techniques (such as SAR, etc). This would allow the reading of a smaller input sound pressure (\SI{12}{dB} below) and make possible to process a sound pressure of \SI{4}{dB_{SPL}} (increasing the distance between the sensor and the source). However, the signal quality would not benefit from this increased ADC resolution because the microphone self-noise is \SI{14}{dB_{SPL}}.
 

\chapter{Power supply}

\section{Power consumption}

\subsection*{Data processing and transmission}

The power supply $VDD_{STM32}$ required for the STM32 being between \SI{1.8}{V} and \SI{3.6}{V}, one has to choose a trade-off between a small power consumption (small voltage) and a high signal resolution from the microphone (high voltage). A voltage of $VDD_{STM32} = \SI{3}{V}$ has finally been selected.

Graph of first approx consumption wisebatt.

In this Master thesis, we will study the implementation of over-the-air firmware update through wireless communications. The challenge is the instantaneous power consumption when the wireless radio is in receive mode combined and the microcontroller is reprogramming its internal Flash memory. This high power is natively not compatible with the solid-state battery and the energy-harvesting operation. Smart decomposition of the firmware packets will thus be required.

\subsection*{Sensing}



\subsection*{Power Management}

loss in voltage divider: 2 * 1 Mohm resistor ? Problem: load in parallel with R1-> decrease output voltage -> need to compute Rain = 500k (50nA, measure somewhere?): (precision of ...\%) -> current consumption of 4.5/1M = 4.5µA

Compute Rain with formula in ADC datasheet

max error on battery percent: 3\% -> max output variation: ...V

Delay: not important here since the input voltage (Batt) is not varying a lot.

Maybe op amp but with low power or duty-cycler ce diviseur en mettant un MOS à sa base piloté par un GPOUT du MCU

+ PMU

Additionally, the leakage current of the supercapacitor detailed in Section~\ref{supercap_sizing} is \SI{500}{\micro F} at its maximum value.

\subsection*{Total power consumption}

Table with Power buget

\section{Solar cells}

principle, !efficiency!

Solar cells are electrical devices that convert the energy of light into electricity by the photovoltaic effect. The current generated by such cells is decreasing with the voltage. It leads to a maximum for the harvested power (see Figure~\ref{fig:solar_IV}), which is called the MPP (for Maximum Power Point).

\begin{figure}[H]
    \centering
    \input{img/solar_IV.tex}
    \caption{IV and PV curves of a typical solar cell: SM141K06L}
    \label{fig:solar_IV}
\end{figure}

\textcolor{green}{Add measurement of this IV curve in lab + lux on cell? experimental validation of given power} 

The main figures of merit for solar cells are thus the current and voltage at the maximum power point, as well as the surface area since the goal is to maximize the harvested power per unit area and thus minimize the area on the PCB. It is worth noting that the current and power are provided at one sun (\SI{1}{mW/mm^2}), and the power is the electric power generated by the solar cells.

A great advantage of solar cells is their ability to combine them easily in series (doubling the voltage) or in parallel (doubling the current), provided that the total voltage does not exceed the voltage limit of \SI{5}{V} for the Power Management Unit. Based on the comparison depicted in Table~\ref{tab:solar_comparison} between three cells of different sizes, the SM141K06L model is selected for its high power per unit area of \SI{0.1905}{mW/mm^2}. Alternatively, this electric power per unit area can be validated by computing the product between the sun intensity and the efficiency of the solar cells (approximated to 25\% in the datasheet compared to 19.06\% computed here).

\begin{table}[H]
\centering
\scalebox{0.9}{
\begin{tabular}{lccc}
\hline
                                   & KXOB25-14X1F & SM141K06L    & SLMD481H08L  \\ \hline
Current [mA]                       & 55           & 55.1          & 178          \\
MPP Voltage [V]                        & 0.56         & 3.35         & 4            \\
Power [mW]                         & 30.7         & 184          & 714          \\
Surface [mm x mm]               & \SI{23x8}{}  & \SI{42x23}{} & \SI{89x55}{} \\
Power per unit area [\si{mW/mm^2}] & 0.1668       & 0.1905       & 0.1459       \\ \hline
\end{tabular}
}
\caption{Comparison of several solar cells}
\label{tab:solar_comparison}
\end{table}

This model is a set of 6 single solar cells in series, raising the MPP voltage from \SI{0.56}{V} to \SI{3.35}{V}. Figure~\ref{fig:solar_IV} provides the IV/PV curves for one of the single cells.

Now that the cell with the best power par unit area is selected, the following of this section is dedicated to the computation of the required number of such cells in order to daily provide enough energy to the whole circuit via the supercapacitor. For this purpose, a model of the harvested energy from the sun is required.


\subsection*{Illuminance}

The luminosity profile over a whole day needs to be measured in order to estimate the harvested solar energy. For this purpose, a light meter (model \textit{testo 540}) has been used\footnote{Smartphone applications such as \textit{Physics Toolbox} also exist but provide imprecise results.}. It is a precise light sensor but the measurement is only shown on a screen, preventing the user to continuously record the data over a whole day. Figure \ref{fig:daily_luminosity} thus presents the measurements made at regular intervals in a shady place of Louvain-la-Neuve (to replicate a place similar to a forest). The weather was cloudy, which gives an illuminance very near the worst case scenario and hence allows the solar cells to be selected based on the darkest days.

\begin{figure}[H]
    \centering
    \input{img/daily_luminosity.tex}
    \caption{Daily luminosity (Louvain-la-Neuve, from March 3 to March 6, 2020)}
    \label{fig:daily_luminosity}
\end{figure}

These data are extremely variable, mainly due to the motion of clouds. A polynomial regression of second order $L(t)$ allows to better represent the trend over a day (in dashed blue).

\iffalse
The mean luminosity $<L>_{\te{exp}}$ over a full day (24 hours) is computed from the integral of the approximated curve $L(t)$:
\[
 <L>_{\te{exp}} = \frac{\int_0^{24} L(t)\, \te{d}t}{24} = \SI{806}{lm}.
\]
\[
 <L>_{\te{min}} = \frac{8}{11} <L>_{\te{exp}} = \SI{586}{lm}.
\]
\fi

The data have been taken during days with 11 hours of sunlight (averaged between March 3 and March 6, 2020), while the sensor has to work under smaller periods of sunlight (down to 8 hours in the winter~\cite{sunlight}). Assuming that the daily harvested energy is proportional to the duration of sunlight, the following computations will be done accordingly by horizontally shrinking the graph by $8/11$ (in red).

More rigorously, one should also shrink the graph vertically since the sunlight is weaker in winter. Indeed, the same incoming sunlight is distributed over a larger area at higher latitudes (see Figure~\ref{fig:sunlight_png}). However, scaling the device to the very worst scenario (less than 10\% of the year) is not advisable since it would imply significant overscaling (of the solar cells and supercapacitor). Consequently, the microcontroller algorithms will be less resources intensive for winter in order to match the specifications of energy harvesting and storage, which is coherent with the fact that fewer birds are active during this period.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\textwidth]{img/sunlight.png}
    \caption{Sunlight towards Earth at the equinox~\cite{ackerman2007meteorology}}
    \label{fig:sunlight_png}
\end{figure}


\subsection*{Power conversion}

From this solar energy, solar cells generate a current which is proportional to the illuminance. Most of the solar cell datasheets provide an IV curve at a fixed illuminance of $\SI{1}{sun} = \SI{1e3}{W/m^2}$. Since $\SI{1}{lux} = \SI{0.0079}{W/m^2}$ for the solar spectrum, the harvested current $I_\te{cell}(t)$ from one solar cell is given by
\[
  \frac{I_\te{cell}(t)}{L_\te{sun}(t)} = \frac{I_{1\te{sun}}}{1} \quad \Rightarrow \quad I_\te{cell}(t) = I_{1\te{sun}}\,L_\te{sun}(t) = \SI{0.0079e-3}{}\,I_{1\te{sun}}\,L(t) \quad \si{[A]}
\]
where $L(t)$ and $L_{\te{sun}}(t)$ are the instantaneous illuminance (resp. expressed in lux and sun) and $I_{1\te{sun}}$ is the current generated at the MPP under \SI{1}{sun} (provided in the datasheet).

For the selected solar cells, Figure~\ref{fig:P_cell} gives the harvested power throughout the day\footnote{As mentioned previously, notice that the graph is shrunk such that the day benefits from sunlight for only 8 hours.}: 
\[
 P_\te{cell}(t) = I_\te{cell}(t)\,V_\te{cell} = \SI{0.0079e-3}{}\,I_{1\te{sun}}\,V_\te{cell}\,L(t) \quad \si{[W]}
\]
with $V_\te{cell} = \SI{3.35}{V}$ and $I_{1\te{sun}} = \SI{55.1}{mA}$.

\begin{figure}[H]
    \centering
    \input{img/P_cell.tex}
    \caption{Daily view of the harvested power with SM141K06L solar cells}
    \label{fig:P_cell}
\end{figure}

\subsection*{Charge of the supercapacitor}

The next paragraphs will discuss how the power management unit transforms the input and output powers with two different voltage regulators.

The input power from the solar cells is independent from the supercapacitor voltage. Indeed, the voltage at the maximum power point is converted to the current battery voltage through a buck-boost converter. The input power is thus constant according to
\[
 P_\te{in}(t) = n_\te{¢ell} \, I_\te{cell}(t)\,V_\te{cell} = I_\te{in,SC}(t) \, V_\te{SC}(t) \quad [\si{W}]
\]
where $n_\te{¢ell}$ is the number of solar cells required for the device, $I_\te{in,SC}(t)$ is the input current through the supercapacitor and $V_\te{SC}(t)$ is the voltage across the supercapacitor.

Regarding the ernergy consumption, the PMU converts the supercapacitor voltage to a constant voltage $V_\te{CC}= \SI{2.5}{V}$ via a linear dropout regulator (LDO). Neglecting the quescient current, LDOs keep the same current while the voltage is reduced. The output power is thus reduced, this is why it is important to maintain a small dropout (difference of voltage between the input and output). Hence, the output current is independent from the supercapacitor voltage and not the output power since the ratio of output power feeded to the circuit over the output power actually retrieved from the supercapacitor is given by
\[
 \frac{P_\te{out,circuit}}{P_\te{out,SC}} = \frac{I_\te{out} \, V_\te{CC}}{I_\te{out} \, V_\te{SC}} = \frac{V_\te{CC}}{V_\te{SC}} \quad [\si{W}].
\]

In the end, Figure~\ref{fig:P_in_I_out} depicts the input and output variables which are independent from the supercapacitor voltage. These are thus the only quantities which can be plotted without measuring the supercapacitor voltage. The input is power given with 6 solar cells. The input current has a cyclic profile which is typical for the application. It has a run mode of \SI{9}{mA} and a sleep mode of \SI{0.3}{mA} with a duty cycle of $1/7$.

\begin{figure}[H]
    \centering
    \input{img/P_in_I_out.tex}
    \caption{Input power and output current for 6 solar cells and a typical profile of cyclic consumption}
    \label{fig:P_in_I_out}
\end{figure}

Having two different quantities (the power and the current) conserved when the supercapacitor voltage changes leads to slightly more complicated computations of the supercapacitor voltage over one day\footnote{Having the input and output currents independent from the supercapacitor voltage would lead to the simple equation: $$V_\te{SC}(t) = V_\te{SC}(t_0) + \frac{1}{C} \int_{t_0}^t (I_\te{in,SC}(t) - I_\te{out,SC}(t))\, \te{d}t.$$

Likewise, having the input and output powers independent from the supercapacitor voltage would lead to the equation: $$E_\te{SC}(t) = E_\te{SC}(t_0) + \int_{t_0}^t \big(P_\te{in,SC}(t) - P_\te{out,SC}(t)\big)\, \te{d}t$$ where $E_\te{SC} = C\, V_\te{SC}^2 / 2$ to obtain the voltage.}. The rigorous approach consists to write the equation for the charge of a capacitor:
\begin{align*}
 \frac{\te{d}V_\te{SC}}{\te{d}t} &= \frac{1}{C} \left( I_\te{in,SC}(t) - I_\te{out,SC}(t) \right) \\
 &= \frac{1}{C} \left( \frac{P_\te{in}(t)}{V_\te{SC}(t)} - I_\te{out,SC}(t) \right) \\
 &= \frac{1}{C} \left( n_\te{¢ell} \, I_\te{cell}(t) \frac{V_\te{cell}}{V_\te{SC}(t)} - I_\te{out,SC}(t) \right)
\end{align*}
which is a non-linear first-order differential equation for the variable $V_\te{SC}(t)$. Nonetheless, one can notice that that the equation is written as
\[
 \frac{\te{d}V_\te{SC}}{\te{d}t} = f(V_\te{SC}, t)
\]
where $f(V_\te{SC}, t)$ is a function of $V_\te{SC}$ and $t$. It can thus be easily solved numerically for example via the forward Euler method: 
\begin{align*}
 V_\te{SC}(t + \te{d}t) &= V_\te{SC}(t) + \te{d}t \, f(V_\te{SC}(t), t) \\
 &= V_\te{SC}(t) + \frac{\te{d}t}{C} \left( n_\te{¢ell} \, I_\te{cell}(t) \frac{V_\te{cell}}{V_\te{SC}(t)} - I_\te{out,SC}(t) \right).
\end{align*}
starting with $V_\te{SC}(t_0) = V_\te{CC} + 0.3 = \SI{2.8}{V}$ which is the minimum voltage across the supercapacitor due to a minimum dropout of \SI{0.3}{V}. The value $t_0$ is thus the time for which the supercapacitor begins to charge, in other words when the input power starts to overtake the output power: $n_\te{¢ell} \, I_\te{cell}(t_0)\,V_\te{cell} = I_\te{out}(t_0) \, V_\te{SC}(t_0)$.

Finally, Figure~\ref{fig:Supercap_voltage} depicts the numerical solution of the supercapacitor voltage throughout the day for three different numbers of cells. One can see the small ripple due to the sharp transitions of the consumed current. During the night, the input current is null, the net current through the supercapacitor is thus only due to the varying output current implying a wavy discharge at a constant rate.

The number of cells is chosen to come back to the minimum voltage after one day (close the loop). If there are not enough cells, the voltage will fall below this minimal voltage and the circuit will be shut down during a few hours. If there are too many cells, the voltage will be higher day after day. The optimal number of cells is thus 6, as the curve in red (Figure~\ref{fig:Supercap_voltage}) is perfectly suited for the current consumption.

\begin{figure}[H]
    \centering
    \input{img/Supercap_voltage.tex}
    \caption{Voltage across the supercapacitor for three numbers of cells}
    \label{fig:Supercap_voltage}
\end{figure}

\section{Supercapacitor sizing}
\label{supercap_sizing}

Although the size of the supercapacitor appears inside the charge equation in the previous computations, its impact is small compared to the impact of the number of solar cells. This small impact comes from the charge equation stating that $C$ changes the slope of $V_\te{SC}(t)$ (applying a vertical stretching of the curve). This increase of supercap voltage induces a higher dropout in the output voltage conversion, decreasing the efficiency of the regulation. It is then required to size the supercapacitor such that the maximum voltage set by the PMU (\SI{4.5}{V}) is never exceeded.

Figure~\ref{fig:Supercap_voltage_C} provides the simulation results for three different capacitances. One can first see that the maximal voltage is reached for $C = \SI{50}{F}$ but it fails to be active during one day since the voltage drops below the \SI{2.8}{V}, the minimum capacitance for this work is thus between \SI{50}{F} and \SI{100}{F}.

\begin{figure}[H]
    \centering
    \input{img/Supercap_voltage_C.tex}
    \caption{Voltage across the supercapacitor for three differents capacitances}
    \label{fig:Supercap_voltage_C}
\end{figure}

\iffalse
\[
 \frac{C\,V_\te{batt}^2(t)}{2} = \frac{C\,V_\te{min}^2}{2} + E_\te{supp}(t) \quad \Rightarrow \quad V_\te{batt}(t) = \sqrt{V_\te{min}^2 + \frac{2\,E_\te{supp}(t)}{C}} \quad \si{[V]}
\]
\fi

A common (and possibly the only one in Europe) manufacturer for such high capacitances is Vishay, it has a broad range of supercapacitor from \SI{4}{F} to \SI{90}{F} and from \SI{1.8}{V} to \SI{8.4}{V}. The minimal voltage matching the specifications of this work is \SI{4.2}{V} since the operating voltage range must lie inside the PMU range (\SI{2.8}{V} to \SI{4.5}{V}). Table~\ref{tab:SC_comparison} provides a comparison between the two best solutions: a supercapacitor of \SI{90}{F} and a set of 4 supercapacitors of \SI{15}{F}.

\begin{table}[H]
\centering
\begin{tabular}{lcc}
\hline
                                 & MAL219690101E3     & MAL219691213E3 ($\times 4$)  \\ \hline
 Capacitance [F]                 & 90                 & $15 \times 4 = 60$           \\
 Rated voltage [V]               & 4.2                & 4.2                          \\ 
 Leakage current [\si{\micro A}] & 500                & $120 \times 4 = 480$         \\ 
 Volume [mm x mm x mm]           & \SI{35x26.5x15}{}  & $(\SI{14x10x12}{}) \times 4$ \\
 Cost [\$]                       & 19.16              & $8.93 \times 4 = 35.72$      \\ \hline
\end{tabular}
\caption{Comparison of several supercapacitors}
\label{tab:SC_comparison}
\end{table}

As shown in Figure~\ref{fig:hvc}, these typical supercapacitors present a linear discharge under constant current only locally in a range between \SI{4.4}{V} and \SI{5.4}{V} for a \SI{5.6}{V} supercapacitor. Below \SI{4.4}{V}, the supercap voltage drops very fast and falls below its operation voltage. Selecting a capacitance of \SI{5.6}{V} would thus not allow the PMU, limited to \SI{4.5}{V}, to charge the supercap in its operating voltage range. Even if it is below the \SI{4.5}{V} of the PMU, a \SI{4.2}{V} supercapacitor is thus required to work in the range where most of the energy is actually stored (between \SI{3.1}{V} and \SI{4}{V}). One can finally notice that the leakage current is not negligible, making this type of supercap unsuited for ultra-low-power devices.

\begin{figure}[H]
    \centering
    \includegraphics[clip, trim=1cm 18.5cm 11cm 3cm, scale=1]{196hvc-12.pdf}
    \caption{Constant current charge and discharge: \SI{90}{F} / \SI{5.6}{V}~\cite{Vishay}}
    \label{fig:hvc}
\end{figure}

The all-in-one supercapacitor of \SI{90}{F} is selected because its capacitance is 50\% higher and its cost is lower with not much additional leakage current and space on the board. It thus allows more power consumption (namely processing in the microcontroller) during periods of higher sunlight without saturating the supercapacitor voltage. Based on Figure~\ref{fig:Supercap_voltage_C}, it is expected that the voltage follows the red curve and thus reaches a peak at \SI{3.8}{V}.

Figure~\ref{fig:Supercap_voltage_voltage_split} gives the voltage split for a \SI{90}{F} / \SI{4.2}{V} supercap, which perfectly fits into the PMU and supply specifications.

\begin{figure}[H]
\centering
\begin{tikzpicture}[scale=2]
% Axes:
\draw[->](0,2)--(0,5);
\draw[](-0.1,4.5)--(0,4.5)node[left,font=\small]{\SI{4.5}{V} \, };
\draw[](-0.1,4.2)--(0,4.2)node[left,font=\small]{\SI{4.2}{V} \, };
\draw[](-0.1,2.8)--(0,2.8)node[left,font=\small]{\SI{2.8}{V} \, };
\draw[](-0.1,2.5)--(0,2.5)node[left,font=\small]{\SI{2.5}{V} \, };
\draw[fill=blue!30] (0.1,2.8) rectangle ++(2.9,1.4);
\draw[](0,4.5)--(3,4.5);
\draw[](0,2.5)--(3,2.5);
\node () [] at (1.5,2.6) {PMU voltage drop};
\node () [] at (4.5,2.5) {Supply voltage};
\node () [] at (4.5,3.5) {Active range};
\node () [] at (4.5,4.5) {PMU max voltage};
\end{tikzpicture}
\caption{Voltage split for a \SI{90}{F} / \SI{4.2}{V} supercap coupled with the AEM10941}
\label{fig:Supercap_voltage_voltage_split}
\end{figure}


\chapter{Final model}

\section{Description}

The final model is a stack of 2 boards: a board for data processing and transmission on top of a board for sensing and power management.

\section{Design}

The design of the final model is given in Figure~\ref{fig:final_model_picture}. One can see the 6 solars cells, the supercapacitor in blue, the microphone in light grey, as well as five headers for current/voltage measurements. The components are place such that the solar panels receive the maximum of sunlight.

\begin{figure}[H]
\begin{subfigure}{.5\textwidth}
  \centering
  \includegraphics[width=.52\linewidth,angle=90]{img/real_PCB.jpg}  
  \caption{Without MCU/TX board}
\end{subfigure}
\begin{subfigure}{.48\textwidth}
  \centering
  \includegraphics[width=.82\linewidth]{img/real_PCB_with_MCU.jpg}  
  \caption{With MCU/TX board}
\end{subfigure}
\caption{Pictures of the final model}
\label{fig:final_model_picture}
\end{figure}

\subsection*{Prototyping}

The PCB schematics and layout are available in Appendix~\ref{appendix:schematic}.

\section{Validation}

This section describes the experimental results obtained with the real device.

\subsection*{Power consumption}

The current consumption measured in the different parts is given in Table~\ref{tab:val_current_cons}. These measurements have been made with a Source Measure Unit: Keithley 2400.

\begin{table}[H]
\centering
\begin{tabular}{lc}
\hline
                     & Current [\si{\micro A}]  \\ \hline
 Supercap leakage    & 95                       \\
 AFE                 & 1030                     \\
 PMU                 & 50                       \\
 MCU                 & 470                      \\ \hline
 Total               & 1645                     \\ \hline
\end{tabular}
\caption{Description of the current consumption in the system}
\label{tab:val_current_cons}
\end{table}

When the supercapacitor is fully disconnected, a leakage current of \SI{95}{\micro A} is noticed, which is indeed below the maximum value of \SI{500}{\micro A} in the datasheet.

In the AFE, the microphone consumes \SI{380}{\micro A}. The op amp consumes \SI{650}{\micro A}, which is more than expected since it has two channels.

As given in the datasheet, the PMU quiscient current is \SI{50}{\micro A}.

The current consumption for a basic code in the MCU (duty cycle run/deepsleep mode of 10\%) is \SI{470}{\micro A}.

\subsection*{Solar cells}

Table~\ref{tab:val_current_solar_sel} compares the harvested power from the solar cells in function of the MMP ratio under a fixed interior lighting. The voltage is fixed by the SMU while it measures the current. The highest power is achieved at 70\% of the open circuit voltage (\SI{4.15}{V}), which is selected in hardware via a header connected to the PMU.

\begin{table}[H]
\centering
\begin{tabular}{lccc}
\hline
  MPPT ratio & Voltage [V] & Current [mA] & Power [mW]  \\ \hline
 70\%        & 2.9         & 20.2         & 58.6        \\
 75\%        & 3.11        & 17.9         & 55.7        \\
 85\%        & 3.53        & 11.1         & 39.1        \\
 90\%        & 3.73        & 3.5          & 13.1        \\ \hline
\end{tabular}
\caption{Harvested power from the solar cells in function of the MMP ratio}
\label{tab:val_current_solar_sel}
\end{table}


Table~\ref{tab:val_current_harvested} gives the harvested current under different lighting from the solar cells at the MMP voltage (\SI{2.9}{V}). Since the data were taken at noon, they show more harvesting energy than for the theoretical analysis (see Figure~\ref{fig:daily_luminosity}).

\begin{table}[H]
\centering
\begin{tabular}{lc}
\hline
                     & Current [\si{mA}]  \\ \hline
 In the shade        & 30                       \\
 Cloudy              & 50                       \\
 Sunny               & 150                      \\ \hline
\end{tabular}
\caption{Harvested current under different lighting from the solar cells at the MMP voltage}
\label{tab:val_current_harvested}
\end{table}

\subsection*{Supercapacitor}

Figure~\ref{fig:discharge_supercap_exp} provides the supercapacitor discharge under a constant current of \SI{500}{mA} (to compare with Figure~\ref{fig:hvc}) after being charged to its maximum voltage (\SI{4.2}{V}) and kept at this voltage for 30 minutes (as recommended in the datasheet). It can be noted that the voltage is around \SI{3.1}{V} for the most important part of the operation, which is beneficial since the LDO in the PMU has a low-dropout in this case (and thus a good efficiency). Additionally, the supercapacitor is not in operation under \SI{2.5}{V}, which proves that the best type of DC-DC converter for this application is an LDO (and not a Buck-Boost converter which would allow to step up the voltage). The total energy stored in this \SI{90}{F}/\SI{4.2}{V} supercapacitor is computed as
\[
 E_\te{SC} = \int_0^\infty P_\te{SC}(t) \, \te{d} t = I_\te{discharge} \int_0^\infty V_\te{SC}(t) \, \te{d} t = \SI{851.6}{J}.
\]

\begin{figure}[H]
    \centering
    \input{img/Discharge_supercap_exp.tex}
    \caption{Supercapacitor discharge under a constant current of \SI{500}{mA}}
    \label{fig:discharge_supercap_exp}
\end{figure}



\subsection*{...}

Test noise in ADC input (refine ADC to more than 12 bits if needed), measure number of errors in the digitized data). LSB=0.6mV and expected noise=2.5mV

    Current consumption over a whole period with/without Tim's board (material: SMU for 2-3 days)​

    

    Noise measurement at the ADC input?

    
\chapter{Inference algorithm}

    Classify the type of bird (among the ~10 most common ones) based on frequency spikes (FFT + threshold of bins: scale par rapport intensité moyenne de bruit (soft threshold)): sortir des performances grossières​

    First tests of the code with laptop mic and open-source database of bird songs​

    Matlab: (log scale, sensitivity: detect ratio of birds, + false positives) + compatibility power management / application​

    If not working: count the number of songs
    
    time-frequency representation provides a good do-
main for audio classification for several reasons

\chapter{Improvement perspectives}

Waterproof case and potting

SWOT analysis ?

\chapter{Conclusion}

\appendix

\chapter{Transimpedance amplifier}
\label{appendix:transimpedance}

Figure~\ref{fig:circuit_AFE_appendix} presents the transimpedance amplification circuit simplified in the audio frequency.

\begin{figure}[H]
\centering
\begin{circuitikz}[scale=0.5]
    \draw (3.5,-4) node[op amp, scale = 0.5](opamp){} 
        (opamp.+) node[left] {}
        (opamp.-) node[left] {}
        (opamp.out) node[right] {}
        (opamp.down) node[ground] {}
        (opamp.up) ++ (0,.5) node[above] {$VCC$}
        -- (opamp.up); 
    \draw (3.5,1.5)-- (1.0,1.5);% wire w6
    \draw (8.5,1.5)-- (6.0,1.5);% wire w8
    \node (A) at (-10,1) {};
    \draw (1.0,-3.5)-- (1.0,1.5);% wire w13
    \draw (1.0,-3.5) to[short, i=$I_{AC}$] (-1.5,-3.5);% wire w14
    \draw (opamp.-)-- (1.0,-3.5);
    \draw (8.5,-4.0)-- (8.5,1.5);% wire w16
    \draw (8.5,-4.0)-- (opamp.out);% wire w17
    \draw (10.0,-4.0)-- (8.5,-4.0);% wire w18
    \draw (opamp.+) --  (1.5,-4.5) -- (1.5,-10.5);
    \draw (-3.0,-7.5)-- (-3.0,-7.0);% wire w24
    \draw (-3.0,-10.5)-- (-3.0,-10.0);% wire w28
    \draw (1.5,-10.5)-- (-3.0,-10.5);% wire w30
    \draw (-3.0,-11.0)-- (-3.0,-10.5);% wire w31
    \draw (-3.0,-14.5)-- (-3.0,-13.5);% wire w33
    \draw (-3.0,-15.0)-- (-3.0,-14.5);% wire w36
    \draw (-3.0, -15.0) node[ground, xscale=1, yscale=1, rotate=0, ] (undefined) {};
    \draw (6.0, 1.5) to[R, l=$R_2$] (3.5,1.5){};
    \draw (-3.0, -7.5) to[R, l=$R_3$] (-3.0,-10.0){};
    \draw (-3.0, -11.0) to[R, l=$R_4$] (-3.0,-13.5){};
    \node (VCC) [] at (-3.0,-7.0+0.5) {$V_\te{CC}$};
    \node (Vout) [] at (11.0,-4.0) {$V_\te{o}$};
    \node (Vb) [] at (2.5,-10.5) {$V_\te{B}$};
\end{circuitikz}
\caption{Simplified transimpedance amplification circuit}
\label{fig:circuit_AFE_appendix}
\end{figure}

The voltage at the negative terminal of the op amp is given by
\[
 V_{-} = V_\te{o} - R_2 \, I_\te{AC} \quad \si{[V]}.
\]
Since the positive and negative terminals of an op amp are identical (ideally), the relation becomes
\[
 V_\te{B} = V_\te{o} - R_2 \, I_{AC} \quad \Rightarrow \quad V_\te{o} = V_\te{B} + R_2 \, I_\te{AC} \quad \si{[V]},
\]
which is the transimpedance transfer function of the circuit.

\chapter{Noise gain of the microphone amplifier}
\label{appendix:noise_gain}

Figure~\ref{fig:circuit_AFE_appendix_noise} presents the transimpedance amplification circuit simplified in the audio frequency. The supply voltage (DC) is grounded and the microphone (input current source) is open-circuited. Noise gain is referred to the noise source, which is connected to the noninverting input by definition.

\begin{figure}[H]
\centering
\begin{circuitikz}[scale=0.5]
    \draw (3.5,-4) node[op amp, scale = 0.5](opamp){} 
        (opamp.+) node[left] {}
        (opamp.-) node[left] {}
        (opamp.out) node[right] {}
        (opamp.down) node[ground] {}
        (opamp.up) ++ (0,.5) node[above] {$V_\te{CC}$}
        -- (opamp.up); 
    \draw (3.5,0)-- (1.0,0);% wire w6
    \draw (8.5,0)-- (6.0,0);% wire w8
    \node (A) at (-10,0) {};
    \draw (1.0,-3.5)-- (1.0,0);% wire w13
    \draw (opamp.-)-- (-3,-3.5) to[R, l=$R_1$] (-3,-7) node[ground] (undefined) {};
    \draw (8.5,-4.0)-- (8.5,0);% wire w16
    \draw (8.5,-4.0)-- (opamp.out);% wire w17
    \draw (10.0,-4.0)-- (8.5,-4.0);% wire w18
    \draw (opamp.+) --  (1.5,-4.5);
    \draw (1.5,-7) to[sV=$V_\te{i}$] (1.5,-4.5);
    \draw (6.0, 0) to[R, l=$R_2$] (3.5,0){};
    \node (Vout) [] at (11.0,-4.0) {$V_\te{o}$};
    \draw (1.5,-7) node[ground] (undefined) {};
\end{circuitikz}
\caption{Simplified transimpedance amplification circuit for the noise gain}
\label{fig:circuit_AFE_appendix_noise}
\end{figure}

The voltage at the negative terminal of the op amp is given by
\[
 V_{-} = \frac{R_1}{R_1 + R_2} V_\te{o} \quad \si{[V]}.
\]
Since the positive and negative terminals of an op amp are identical (ideally), the relation becomes
\[
 \frac{V_\te{o}}{V_\te{i}} = 1 + \frac{R_2}{R_1} \quad \si{[V]},
\]
which is the noise gain of the circuit.


\chapter{Schematic of the final model}
\label{appendix:schematic}

The PCB layout (see Figure~\ref{fig:PCB_lay}) and schematic (see Figure~\ref{fig:PCB_sch}) were designed with KiCad. The PCB is composed of 4 layers, of which two are for GND and VDD.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{sensing_PMU_layout.pdf}
    \caption{PCB layout}
    \label{fig:PCB_lay}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=\textwidth]{sensing_PMU_schematic.pdf}
    \caption{PCB schematics}
    \label{fig:PCB_sch}
\end{figure}


\bibliographystyle{unsrt}
\bibliography{biblio.bib}

% Back cover page
\backcoverpage

\end{document}
